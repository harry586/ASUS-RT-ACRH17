name: Universal Firmware Builder

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      
      enable_debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150
    
    steps:
    - name: Checkout config repository
      uses: actions/checkout@v4

    - name: Parse source configuration
      id: source-config
      run: |
        echo "æ£€æŸ¥å›ºä»¶é…ç½®ç›®å½•..."
        if [ ! -d "firmware-config" ]; then
          echo "é”™è¯¯: firmware-config ç›®å½•æœªæ‰¾åˆ°"
          exit 1
        fi
        
        echo "æ£€æŸ¥ repositories.json..."
        if [ ! -f "firmware-config/repositories.json" ]; then
          echo "é”™è¯¯: repositories.json æœªæ‰¾åˆ°"
          exit 1
        fi
        
        PRESET="${{ github.event.inputs.source_preset }}"
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" firmware-config/repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
          echo "è‡ªåŠ¨é€‰æ‹©åˆ†æ”¯: $BRANCH"
        fi
        
        if [ -z "$SOURCE_URL" ]; then
          echo "é”™è¯¯: æ— æ³•ä» repositories.json è·å–æºç  URL"
          exit 1
        fi
        
        echo "æºç : $PRESET - $DESCRIPTION"
        echo "URL: $SOURCE_URL"
        echo "åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    - name: Prepare build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-serial python3-setuptools rsync unzip zlib1g-dev file wget jq

    - name: Get source code
      run: |
        echo "å…‹éš†æºç ä»“åº“: ${{ env.SOURCE_URL }}"
        git clone --depth 1 --branch "${{ env.SOURCE_BRANCH }}" "${{ env.SOURCE_URL }}" source

    - name: Initialize source
      run: |
        cd source
        if [ -f "feeds.conf" ] || [ -f "feeds.conf.default" ]; then
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "è½¯ä»¶æºæ›´æ–°å®Œæˆ"
        fi

    - name: Apply configuration
      run: |
        cd source
        CONFIG_FILE="../firmware-config/${{ github.event.inputs.config_profile }}"
        echo "åº”ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "é”™è¯¯: é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°: $CONFIG_FILE"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "é…ç½®æ–‡ä»¶åº”ç”¨æˆåŠŸ"

    - name: Verify and fix conflicts
      run: |
        cd source
        echo "=== é…ç½®éªŒè¯å’Œå†²çªä¿®å¤ ==="
        
        # æ£€æŸ¥å·²çŸ¥å†²çª
        echo "æ£€æŸ¥ DNSMasq é…ç½®:"
        grep -i "dnsmasq" .config || echo "æœªæ‰¾åˆ° DNSMasq é…ç½®"
        
        echo "æ£€æŸ¥æ— çº¿é©±åŠ¨é…ç½®:"
        grep -E "(ath10k|ath10k-ct)" .config || echo "æœªæ‰¾åˆ°æ— çº¿é©±åŠ¨é…ç½®"
        
        echo "æ£€æŸ¥ KMS æœåŠ¡é…ç½®:"
        grep -E "(minidlna|ffmpeg|ffprobe)" .config || echo "KMS æœåŠ¡å·²æ­£ç¡®ç¦ç”¨"
        
        # åº”ç”¨ä¿®å¤
        echo "åº”ç”¨é…ç½®ä¿®å¤..."
        make defconfig
        
        echo "é…ç½®éªŒè¯å®Œæˆ"

    - name: System diagnostics
      if: github.event.inputs.enable_debug == 'true'
      run: |
        cd source
        echo "=== ç³»ç»Ÿè¯Šæ–­ ==="
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo "å†…å­˜ä½¿ç”¨:"
        free -h
        echo "CPU æ ¸å¿ƒæ•°:"
        nproc
        echo "é…ç½®æ‘˜è¦:"
        grep -c "=y" .config | xargs echo "å·²å¯ç”¨åŒ…æ•°é‡:"
        grep -c "is not set" .config | xargs echo "å·²ç¦ç”¨åŒ…æ•°é‡:"

    - name: Compile firmware
      timeout-minutes: 150
      run: |
        cd source
        
        START_TIME=$(date +%s)
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "å·²ä¿®å¤çš„å†²çª:"
        echo "  - DNSMasq: ä½¿ç”¨ dnsmasq-full æ›¿ä»£ dnsmasq"
        echo "  - æ— çº¿é©±åŠ¨: ä½¿ç”¨ kmod-ath10k-ct æ›¿ä»£ kmod-ath10k"
        echo "  - åª’ä½“æœåŠ¡: ç¦ç”¨ KMS æœåŠ¡å‡å°ä½“ç§¯"
        
        if [ "${{ github.event.inputs.enable_debug }}" = "true" ]; then
          echo "ğŸ” è°ƒè¯•æ¨¡å¼: ä½¿ç”¨è¯¦ç»†è¾“å‡ºå’Œå•çº¿ç¨‹ç¼–è¯‘"
          make V=s -j1
        else
          echo "âš¡ æ™®é€šæ¨¡å¼: ä½¿ç”¨å¹¶è¡Œç¼–è¯‘åŠ é€Ÿ"
          make -j$(($(nproc) + 1)) || make -j1 V=s
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ç¼–è¯‘å®Œæˆï¼Œè€—æ—¶: ${DURATION} ç§’"
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV

    - name: Collect build artifacts
      run: |
        cd source
        echo "æ”¶é›†æ„å»ºäº§ç‰©..."
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          echo "å›ºä»¶å¤§å°:"
          ls -lh $(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -1) 2>/dev/null || echo "æ— æ³•è·å–æ–‡ä»¶å¤§å°"
        else
          echo "æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
          echo "bin/targets ä¸­çš„å¯ç”¨æ–‡ä»¶:"
          find bin/targets -type f 2>/dev/null | head -20
        fi
        
        # åˆ›å»ºäº§ç‰©ç›®å½•
        mkdir -p ../artifacts
        cp -r bin/targets/* ../artifacts/ 2>/dev/null || true

        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        echo "æºç : ${{ env.SOURCE_URL }}" > ../artifacts/build-info.txt
        echo "åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}" >> ../artifacts/build-info.txt
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}" >> ../artifacts/build-info.txt
        echo "æ—¶é—´: $(date)" >> ../artifacts/build-info.txt
        echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }} ç§’" >> ../artifacts/build-info.txt
        echo "GitHub Run ID: ${{ github.run_id }}" >> ../artifacts/build-info.txt
        echo "ä¿®å¤çš„å†²çª: DNSMasq, æ— çº¿é©±åŠ¨, KMSåª’ä½“æœåŠ¡" >> ../artifacts/build-info.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Firmware-${{ github.run_number }}-${{ github.run_attempt }}
        path: artifacts
        retention-days: 30

    - name: Build report
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æºç : ${{ env.SOURCE_URL }}"
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "å°è¯•: ${{ github.run_attempt }}"
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ!"
          echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }} ç§’"
          echo "ğŸ¯ å·²ä¿®å¤çš„å†²çª:"
          echo "   - DNSMasq å†²çª"
          echo "   - æ— çº¿é©±åŠ¨å†²çª" 
          echo "   - KMS åª’ä½“æœåŠ¡"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
        fi
