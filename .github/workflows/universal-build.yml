name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: '选择源码库 (ImmortalWrt功能丰富/OpenWrt官方纯净/LEDE集成度高)'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: '源码分支 (auto=自动推荐稳定分支，或手动指定分支名)'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: '设备配置文件路径 - 查看 firmware-config/configs-list.md 获取可用文件列表'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      
      build_optimization:
        description: '编译优化策略'
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: 'balanced'

      enable_custom_features:
        description: '启用自定义功能 (自定义脚本和预编译IPK包)'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  TERM: "linux"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: "📥 检出配置仓库"
      uses: actions/checkout@v4
      with:
        path: firmware-config

    - name: "🔧 解析源码配置"
      id: source-config
      run: |
        cd firmware-config
        
        if [ ! -f "repositories.json" ]; then
          echo "❌ 错误: repositories.json 文件不存在"
          exit 1
        fi
        
        PRESET="${{ github.event.inputs.source_preset }}"
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" repositories.json)
          echo "自动选择推荐分支: $BRANCH"
        fi
        
        if [ -z "$SOURCE_URL" ]; then
          echo "❌ 错误: 无法从repositories.json获取源码URL"
          exit 1
        fi
        
        echo "✅ 源码库: $PRESET - $DESCRIPTION"
        echo "✅ 仓库URL: $SOURCE_URL"
        echo "✅ 使用分支: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    - name: "🧹 准备构建环境"
      run: |
        echo "安装编译依赖包..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial python3-setuptools rsync unzip zlib1g-dev file wget \
          jq ncurses-term tree
        echo "✅ 构建环境准备完成"

    - name: "📥 获取源代码"
      run: |
        echo "正在克隆源码仓库: ${{ env.SOURCE_URL }}"
        git clone --depth 1 \
          --branch "${{ env.SOURCE_BRANCH }}" \
          "${{ env.SOURCE_URL }}" \
          source
        echo "✅ 源码克隆完成"

    - name: "🔧 源码初始化"
      run: |
        cd source
        echo "初始化源码树..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "✅ Feeds更新完成"

    - name: "🎨 应用自定义配置"
      run: |
        cd source
        CONFIG_FILE="../firmware-config/${{ github.event.inputs.config_profile }}"
        echo "正在应用配置文件: $CONFIG_FILE"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "❌ 错误: 配置文件不存在: $CONFIG_FILE"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "✅ 配置文件应用完成"

    # ======================
    # 自定义功能阶段
    # ======================
    
    - name: "📦 处理预编译IPK包"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        IPK_DIR="../firmware-config/custom-features/prebuilt-ipks"
        
        if [ ! -d "$IPK_DIR" ]; then
          echo "ℹ️ 预编译IPK包目录不存在: $IPK_DIR"
          exit 0
        fi
        
        echo "🔍 查找预编译IPK包..."
        IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f)
        
        if [ -z "$IPK_FILES" ]; then
          echo "ℹ️ 未找到预编译IPK包"
          exit 0
        fi
        
        echo "找到以下IPK包:"
        echo "$IPK_FILES"
        
        # 创建IPK包存储目录
        mkdir -p package/base-files/files/usr/lib/opkg/custom
        
        # 复制所有IPK包到固件文件系统中
        for ipk in $IPK_FILES; do
          echo "📥 复制IPK包: $(basename "$ipk")"
          cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
        done
        
        # 创建自动安装脚本
        mkdir -p package/base-files/files/etc/init.d
        cat > package/base-files/files/etc/init.d/custom-ipk-install << 'EOF'
        #!/bin/sh /etc/rc.common
        
        START=99
        
        start() {
            echo "正在安装自定义IPK包..."
            for ipk in /usr/lib/opkg/custom/*.ipk; do
                if [ -f "$ipk" ]; then
                    echo "安装: $(basename $ipk)"
                    opkg install "$ipk"
                fi
            done
            echo "自定义IPK包安装完成"
        }
        EOF
        
        chmod +x package/base-files/files/etc/init.d/custom-ipk-install
        
        # 确保启动脚本被启用
        if [ -f "package/base-files/files/etc/rc.local" ]; then
          if ! grep -q "custom-ipk-install" package/base-files/files/etc/rc.local; then
            echo "/etc/init.d/custom-ipk-install start" >> package/base-files/files/etc/rc.local
          fi
        fi
        
        echo "✅ 预编译IPK包处理完成"
        echo "📊 共处理 $(echo "$IPK_FILES" | wc -l) 个IPK包"

    - name: "🛠️ 执行自定义脚本"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        SCRIPTS_DIR="../firmware-config/custom-features/scripts"
        
        # 检查脚本目录是否存在
        if [ ! -d "$SCRIPTS_DIR" ]; then
          echo "ℹ️ 自定义脚本目录不存在: $SCRIPTS_DIR"
          exit 0
        fi
        
        # 查找所有.sh脚本文件并按名称排序
        SCRIPTS=$(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort)
        
        if [ -z "$SCRIPTS" ]; then
          echo "ℹ️ 未找到任何脚本文件"
          exit 0
        fi
        
        echo "找到以下脚本文件:"
        echo "$SCRIPTS"
        
        # 逐个执行所有脚本
        for script in $SCRIPTS; do
          echo "执行脚本: $(basename "$script")"
          chmod +x "$script"  # 添加执行权限
          if bash "$script"; then
            echo "✅ $(basename "$script") 执行成功"
          else
            echo "❌ $(basename "$script") 执行失败"
            exit 1
          fi
        done
        
        echo "✅ 所有自定义脚本执行完成"

    - name: "🔍 验证配置"
      run: |
        cd source
        echo "验证配置文件..."
        make defconfig
        echo "✅ 配置验证完成"

    - name: "🔍 系统诊断"
      run: |
        echo "=== 系统资源诊断 ==="
        echo "磁盘空间:"
        df -h
        echo "内存使用:"
        free -h
        echo "CPU核心数:"
        nproc
        echo "终端环境: TERM=$TERM"

        # 显示自定义功能状态
        echo "=== 自定义功能状态 ==="
        echo "启用自定义功能: ${{ github.event.inputs.enable_custom_features }}"

    - name: "🏗️ 编译固件"
      timeout-minutes: 180
      run: |
        cd source
        
        # 设置编译环境
        export TERM=linux
        export FORCE_UNSAFE_CONFIGURE=1
        
        START_TIME=$(date +%s)
        echo "开始编译 (策略: ${{ github.event.inputs.build_optimization }})"
        
        # 根据优化策略选择编译方式
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "🚀 速度优先模式: 多线程编译"
            make -j$(nproc)
            ;;
          "stability")
            echo "🛡️ 稳定性优先模式: 单线程详细编译"
            make V=s -j1
            ;;
          "balanced"|*)
            echo "⚖️ 平衡模式: 2线程详细编译"
            make -j2 V=s
            ;;
        esac
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "✅ 编译完成! 耗时: ${DURATION}秒 ($(($DURATION/60))分钟)"
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV

    - name: "📦 收集构建产物"
      run: |
        cd source
        echo "收集编译输出文件..."
        
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "✅ 生成的固件文件:"
          echo "$FIRMWARE_FILES"
          echo "文件大小:"
          ls -lh $(echo "$FIRMWARE_FILES" | head -1) 2>/dev/null || echo "无法获取文件大小"
        else
          echo "⚠️ 未找到标准固件文件"
          find bin/ -type f 2>/dev/null | head -20 || echo "bin目录不存在"
        fi
        
        mkdir -p ../artifacts
        cp -r bin/targets/* ../artifacts/ 2>/dev/null || true

        echo "源码: ${{ env.SOURCE_URL }}" > ../artifacts/build-info.txt
        echo "分支: ${{ env.SOURCE_BRANCH }}" >> ../artifacts/build-info.txt
        echo "配置: ${{ github.event.inputs.config_profile }}" >> ../artifacts/build-info.txt
        echo "优化: ${{ github.event.inputs.build_optimization }}" >> ../artifacts/build-info.txt
        echo "时间: $(date)" >> ../artifacts/build-info.txt
        echo "时长: ${{ env.BUILD_DURATION }}秒" >> ../artifacts/build-info.txt
        echo "自定义功能: ${{ github.event.inputs.enable_custom_features }}" >> ../artifacts/build-info.txt

    - name: "💾 上传构建产物"
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}"
        path: artifacts
        retention-days: 30

    - name: "📊 构建报告"
      if: always()
      run: |
        echo "=== 构建报告 ==="
        echo "状态: ${{ job.status }}"
        echo "源码: ${{ env.SOURCE_URL }}"
        echo "分支: ${{ env.SOURCE_BRANCH }}"
        echo "配置: ${{ github.event.inputs.config_profile }}"
        echo "优化: ${{ github.event.inputs.build_optimization }}"
        echo "自定义功能: ${{ github.event.inputs.enable_custom_features }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "🎉 构建成功! 固件已上传到Artifacts"
          echo "⏱️ 编译时长: ${{ env.BUILD_DURATION }}秒"
        else
          echo "❌ 构建失败，请检查日志中的错误信息"
        fi
