name: "Universal Firmware Builder - Multi-Architecture Support"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“ (ImmortalWrtåŠŸèƒ½ä¸°å¯Œ/OpenWrtå®˜æ–¹çº¯å‡€/LEDEé›†æˆåº¦é«˜)'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨æŒ‡å®šåˆ†æ”¯å)'
        required: true
        default: 'auto'
        type: string
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ - æŸ¥çœ‹ firmware-config/configs-list.md è·å–å¯ç”¨æ–‡ä»¶åˆ—è¡¨'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      build_optimization:
        description: 'ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥'
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: 'balanced'
      toolchain_strategy:
        description: 'å·¥å…·é“¾ç­–ç•¥ (prebuilt=é¢„ç¼–è¯‘æœ€å¿«/local=æœ¬åœ°ç¼–è¯‘æœ€ç¨³/auto=è‡ªåŠ¨é€‰æ‹©)'
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: 'auto'
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½ (è‡ªå®šä¹‰è„šæœ¬å’Œé¢„ç¼–è¯‘IPKåŒ…)'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  TERM: "linux"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"
  CCACHE_DIR: "/home/runner/ccache"
  BUILD_LOG_DIR: "/home/runner/build-logs"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»“åº“"
      uses: actions/checkout@v4

    - name: "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶ç»“æ„"
      run: |
        echo "=== éªŒè¯é…ç½®æ–‡ä»¶ç»“æ„ ==="
        if [ ! -f "firmware-config/repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          echo "è¯·åˆ›å»º firmware-config/repositories.json æ–‡ä»¶"
          exit 1
        fi
        
        if [ ! -d "firmware-config/configs" ]; then
          echo "âŒ é”™è¯¯: configs ç›®å½•ä¸å­˜åœ¨"
          echo "è¯·åˆ›å»º firmware-config/configs ç›®å½•å¹¶æ·»åŠ é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ… é…ç½®æ–‡ä»¶ç»“æ„éªŒè¯é€šè¿‡"

    - name: "ğŸ’¾ ç³»ç»Ÿèµ„æºåˆ†æä¸æ¸…ç†"
      run: |
        echo "=== ç³»ç»Ÿèµ„æºåˆ†æ ==="
        df -h
        echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
        free -h
        
        echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§äº¤æ¢æ–‡ä»¶..."
        sudo swapoff /mnt/swapfile 2>/dev/null || true
        sudo swapoff /swapfile 2>/dev/null || true
        sudo rm -f /mnt/swapfile 2>/dev/null || true
        sudo rm -f /swapfile 2>/dev/null || true
        
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

    - name: "ğŸ”§ è®¾ç½®å·¥ä½œç¯å¢ƒä¸æƒé™ä¿®å¤"
      run: |
        echo "è®¾ç½®ç¼–è¯‘ç¯å¢ƒ..."
        
        # åˆ›å»º /mnt ç›®å½•å¹¶è®¾ç½®æ­£ç¡®æƒé™
        echo "è®¾ç½® /mnt ç›®å½•æƒé™..."
        sudo mkdir -p ${{ env.SOURCE_DIR }}
        sudo mkdir -p ${{ env.ARTIFACTS_DIR }}
        sudo chown -R runner:runner ${{ env.SOURCE_DIR }}
        sudo chown -R runner:runner ${{ env.ARTIFACTS_DIR }}
        sudo chmod -R 755 ${{ env.SOURCE_DIR }}
        sudo chmod -R 755 ${{ env.ARTIFACTS_DIR }}
        
        # åˆ›å»ºç”¨æˆ·ç›®å½•çš„ccache
        echo "è®¾ç½®CCacheç›®å½•..."
        mkdir -p ${{ env.CCACHE_DIR }}
        chmod -R 755 ${{ env.CCACHE_DIR }}
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p ${{ env.BUILD_LOG_DIR }}
        
        echo "ğŸ”„ å®‰å…¨åˆ›å»ºå¤§å®¹é‡äº¤æ¢æ–‡ä»¶..."
        sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=8192 status=progress
        sudo chmod 600 /mnt/swapfile
        sudo mkswap /mnt/swapfile
        sudo swapon /mnt/swapfile
        echo "âœ… 8GBäº¤æ¢æ–‡ä»¶å·²å¯ç”¨"
        
        echo "âš¡ ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½è®¾ç½®..."
        ulimit -n 65536
        export FORCE_UNSAFE_CONFIGURE=1

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        echo "æ­£åœ¨è§£ææºç é…ç½®..."
        
        if [ ! -f "firmware-config/repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        PRESET="${{ github.event.inputs.source_preset }}"
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" firmware-config/repositories.json)
        
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é¢„è®¾ $PRESET çš„æºç URL"
          exit 1
        fi
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
        fi
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
        echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
        echo "âœ… æºç é…ç½®: $PRESET - $DESCRIPTION, åˆ†æ”¯: $BRANCH"

    - name: "ğŸ› ï¸ é€šç”¨ç¼–è¯‘ä¾èµ–å®‰è£…"
      run: |
        echo "å®‰è£…é€šç”¨ç¼–è¯‘ä¾èµ–åŒ…..."
        sudo apt-get update
        
        # åŸºç¡€ç¼–è¯‘å·¥å…·é“¾
        BASE_PACKAGES="build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools rsync unzip zlib1g-dev file wget jq ccache"
        
        # å·¥å…·é“¾ä¾èµ–
        TOOLCHAIN_PACKAGES="m4 help2man texinfo texi2html libtool-bin automake autoconf pkg-config"
        
        # å…¶ä»–å¯èƒ½çš„ä¾èµ–
        EXTRA_PACKAGES="subversion mercurial curl cmake ninja-build libelf-dev libssl-dev zlib1g-dev libc6-dev libxml2-dev liblzma-dev liblzo2-dev"
        
        echo "å®‰è£…åŸºç¡€åŒ…: $BASE_PACKAGES"
        sudo apt-get install -y $BASE_PACKAGES
        
        echo "å®‰è£…å·¥å…·é“¾åŒ…: $TOOLCHAIN_PACKAGES"
        sudo apt-get install -y $TOOLCHAIN_PACKAGES
        
        echo "å®‰è£…é¢å¤–åŒ…: $EXTRA_PACKAGES"
        sudo apt-get install -y $EXTRA_PACKAGES
        
        # æ£€æŸ¥å…³é”®å·¥å…·ç‰ˆæœ¬
        echo "=== å…³é”®å·¥å…·ç‰ˆæœ¬æ£€æŸ¥ ==="
        for tool in flex bison m4 gcc g++ make; do
          if command -v $tool >/dev/null 2>&1; then
            version=$($tool --version 2>/dev/null | head -1 || echo "æœªçŸ¥ç‰ˆæœ¬")
            echo "âœ… $tool: $version"
          else
            echo "âŒ $tool: æœªå®‰è£…"
          fi
        done
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: "âš¡ è®¾ç½®ç¼–è¯‘ç¼“å­˜å’Œä¼˜åŒ–"
      run: |
        echo "âš¡ è®¾ç½®ç¼–è¯‘ç¼“å­˜..."
        mkdir -p ${{ env.CCACHE_DIR }}
        ccache -M 8G
        ccache -o compression=true
        ccache -o compression_level=6
        ccache -o max_files=100000
        
        echo "ğŸ“Š åˆå§‹CCacheç»Ÿè®¡:"
        ccache -s
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=8G" >> $GITHUB_ENV
        
        echo "âœ… ç¼“å­˜è®¾ç½®å®Œæˆ"

    - name: "ğŸ“¥ è·å–æºä»£ç "
      id: clone-source
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
        cd ${{ env.SOURCE_DIR }}
        
        CLONE_SUCCESS=false
        echo "ğŸ” å°è¯•ä½¿ç”¨é¦–é€‰åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        
        if git clone --depth 1 --branch "${{ env.SOURCE_BRANCH }}" "${{ env.SOURCE_URL }}" . 2>/dev/null; then
          echo "âœ… ä½¿ç”¨é¦–é€‰åˆ†æ”¯å…‹éš†æˆåŠŸ"
          CLONE_SUCCESS=true
          ACTUAL_BRANCH="${{ env.SOURCE_BRANCH }}"
        else
          echo "âš ï¸ é¦–é€‰åˆ†æ”¯å¤±è´¥ï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹åˆ†æ”¯..."
          
          # è·å–æ‰€æœ‰å¯ç”¨åˆ†æ”¯
          git clone --depth 1 "${{ env.SOURCE_URL }}" . 2>/dev/null
          
          # å°è¯•æ£€æµ‹ç¨³å®šåˆ†æ”¯
          STABLE_BRANCHES="main master openwrt-23.05 openwrt-22.03 openwrt-21.02 lede-17.01"
          for branch in $STABLE_BRANCHES; do
            if git checkout "$branch" 2>/dev/null; then
              echo "âœ… ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹åˆ†æ”¯: $branch"
              CLONE_SUCCESS=true
              ACTUAL_BRANCH="$branch"
              break
            fi
          done
          
          if [ "$CLONE_SUCCESS" = "false" ]; then
            # ä½¿ç”¨é»˜è®¤åˆ†æ”¯
            DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d" " -f5)
            if [ -n "$DEFAULT_BRANCH" ]; then
              git checkout "$DEFAULT_BRANCH"
              echo "âœ… ä½¿ç”¨é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
              CLONE_SUCCESS=true
              ACTUAL_BRANCH="$DEFAULT_BRANCH"
            fi
          fi
        fi
        
        if [ "$CLONE_SUCCESS" = "false" ]; then
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œä»“åº“URL"
          exit 1
        fi
        
        echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
        echo "âœ… æºç å…‹éš†å®Œæˆ: $ACTUAL_BRANCH"

    - name: "ğŸ’¾ æºç å…‹éš†åç©ºé—´æ£€æŸ¥"
      run: |
        echo "=== æºç å…‹éš†åç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        
        AVAILABLE_GB=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
        echo "å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}GB"
        
        if [ "$AVAILABLE_GB" -lt 20 ]; then
          echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´ä¸è¶³20GBï¼Œç¼–è¯‘å¯èƒ½ä¼šå¤±è´¥"
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
        fi

    - name: "ğŸ”§ æºç æ¶æ„æ£€æµ‹"
      id: detect-arch
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "ğŸ” æ£€æµ‹æºç æ¶æ„ä¿¡æ¯..."
        
        # æ£€æµ‹ç›®æ ‡æ¶æ„
        if [ -f "target/linux/" ]; then
          echo "æ”¯æŒçš„æ¶æ„:"
          ls target/linux/ | head -10
        fi
        
        # æ£€æµ‹é…ç½®æ–‡ä»¶ä¸­çš„æ¶æ„ä¿¡æ¯
        CONFIG_FILE="$GITHUB_WORKSPACE/firmware-config/${{ github.event.inputs.config_profile }}"
        if [ -f "$CONFIG_FILE" ]; then
          echo "é…ç½®æ–‡ä»¶æ¶æ„ä¿¡æ¯:"
          grep -E "CONFIG_TARGET_ARCH|CONFIG_TARGET_BOARD|CONFIG_TARGET_SUBTARGET" "$CONFIG_FILE" | head -5 || echo "æœªæ‰¾åˆ°æ˜ç¡®çš„æ¶æ„é…ç½®"
        fi
        
        echo "ARCH_INFO=detected" >> $GITHUB_ENV

    - name: "ğŸ”„ æºç åˆå§‹åŒ–ä¸ä¾èµ–ä¿®å¤"
      timeout-minutes: 45
      id: feeds-update
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        START_TIME=$(date +%s)
        echo "å¼€å§‹æºç åˆå§‹åŒ–..."
        
        # é¦–å…ˆæ£€æŸ¥ feeds.conf æˆ– feeds.conf.default
        echo "æ£€æŸ¥feedsé…ç½®..."
        if [ -f "feeds.conf" ]; then
          echo "ä½¿ç”¨ feeds.conf"
          cat feeds.conf
        elif [ -f "feeds.conf.default" ]; then
          echo "ä½¿ç”¨ feeds.conf.default"
          cp feeds.conf.default feeds.conf
          cat feeds.conf
        else
          echo "âš ï¸ æœªæ‰¾åˆ°feedsé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºé»˜è®¤é…ç½®"
          cat > feeds.conf << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git
EOF
        fi
        
        echo "æ­¥éª¤1: æ›´æ–°feeds..."
        MAX_RETRIES=3
        for i in $(seq 1 $MAX_RETRIES); do
          echo "å°è¯• $i/$MAX_RETRIES"
          if ./scripts/feeds update -a; then
            echo "âœ… Feedsæ›´æ–°æˆåŠŸ"
            break
          else
            echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
            if [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥"
              exit 1
            fi
            sleep 5
          fi
        done
        
        echo "æ­¥éª¤2: å®‰è£…feeds..."
        if ! ./scripts/feeds install -a; then
          echo "âŒ Feedså®‰è£…å¤±è´¥ï¼Œå°è¯•é€‰æ‹©æ€§å®‰è£…..."
          ./scripts/feeds install -a -p packages || echo "åŒ…å®‰è£…å¤±è´¥ä½†ç»§ç»­"
          ./scripts/feeds install -a -p luci || echo "Luciå®‰è£…å¤±è´¥ä½†ç»§ç»­"
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        if [ "$DURATION" -gt 600 ]; then
          echo "â±ï¸ Feedsæ›´æ–°è€—æ—¶: ${DURATION}ç§’ (è¾ƒé•¿)"
          echo "feeds_duration=$DURATION" >> $GITHUB_ENV
        elif [ "$DURATION" -gt 300 ]; then
          echo "â±ï¸ Feedsæ›´æ–°è€—æ—¶: ${DURATION}ç§’"
        fi
        
        echo "âœ… Feedsæ›´æ–°å®Œæˆ"

    - name: "ğŸ¨ åº”ç”¨é…ç½®"
      run: |
        cd ${{ env.SOURCE_DIR }}
        CONFIG_FILE="$GITHUB_WORKSPACE/firmware-config/${{ github.event.inputs.config_profile }}"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
          find firmware-config/configs -name ".config_*" 2>/dev/null | head -10
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ: $(basename "$CONFIG_FILE")"

    - name: "ğŸ”§ é€šç”¨æ€§èƒ½ä¸å…¼å®¹æ€§ä¼˜åŒ–é…ç½®"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "åº”ç”¨é€šç”¨æ€§èƒ½ä¸å…¼å®¹æ€§ä¼˜åŒ–é…ç½®..."
        
        # ç¦ç”¨è°ƒè¯•ä¿¡æ¯ä»¥å‡å°‘ç©ºé—´å ç”¨
        sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_BUILD_LOG=y/# CONFIG_BUILD_LOG is not set/' .config 2>/dev/null || true
        
        # å¯ç”¨ccache
        echo "CONFIG_CCACHE=y" >> .config
        
        # æ ¹æ®ä¼˜åŒ–ç­–ç•¥è°ƒæ•´é…ç½®
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "ğŸš€ åº”ç”¨æé€Ÿä¼˜åŒ–é…ç½®..."
            echo "CONFIG_SMALL_FLASH=n" >> .config
            ;;
          "stability")
            echo "ğŸ›¡ï¸ åº”ç”¨ç¨³å®šä¼˜åŒ–é…ç½®..."
            echo "CONFIG_SMALL_FLASH=y" >> .config
            ;;
          *)
            echo "âš–ï¸ åº”ç”¨å¹³è¡¡ä¼˜åŒ–é…ç½®..."
            ;;
        esac
        
        # è‡ªåŠ¨å¤„ç†é…ç½®
        echo "è¿è¡Œ oldconfig..."
        yes "" | make oldconfig >/dev/null 2>&1 || echo "oldconfig å®Œæˆ"
        
        echo "âœ… æ€§èƒ½ä¼˜åŒ–é…ç½®å®Œæˆ"

    - name: "ğŸ› ï¸ æ™ºèƒ½å·¥å…·é“¾ç¼–è¯‘"
      timeout-minutes: 120
      id: toolchain-setup
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        START_TIME=$(date +%s)
        
        # åˆ›å»ºå·¥å…·é“¾ç¼–è¯‘æ—¥å¿—ç›®å½•
        TOOLCHAIN_LOGS_DIR="/home/runner/toolchain-logs"
        mkdir -p $TOOLCHAIN_LOGS_DIR
        
        # æ ¹æ®ç­–ç•¥é€‰æ‹©å·¥å…·é“¾ç¼–è¯‘æ–¹å¼
        STRATEGY="${{ github.event.inputs.toolchain_strategy }}"
        
        if [ "$STRATEGY" = "auto" ]; then
          # è‡ªåŠ¨æ£€æµ‹ï¼šå¦‚æœæœ‰é¢„ç¼–è¯‘å·¥å…·é“¾å°±ä½¿ç”¨ï¼Œå¦åˆ™æœ¬åœ°ç¼–è¯‘
          if [ -d "staging_dir/toolchain-" ] && [ -n "$(ls -A staging_dir/toolchain-*/bin/*gcc 2>/dev/null)" ]; then
            STRATEGY="prebuilt"
          else
            STRATEGY="local"
          fi
        fi
        
        echo "ğŸ”§ å·¥å…·é“¾ç­–ç•¥: $STRATEGY"
        
        case "$STRATEGY" in
          "prebuilt")
            echo "ğŸ“¦ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾"
            echo "result=prebuilt" >> $GITHUB_OUTPUT
            ;;
          "local"|*)
            echo "ğŸ”¨ ç¼–è¯‘æœ¬åœ°å·¥å…·é“¾"
            
            echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§å·¥å…·é“¾..."
            rm -rf staging_dir/toolchain-* build_dir/toolchain-*
            
            # é¦–å…ˆç¼–è¯‘ host å·¥å…·
            echo "ğŸ”§ ç¼–è¯‘ host å·¥å…·..."
            if ! make tools/compile -j$(($(nproc) - 1)) V=s 2>&1 | tee $TOOLCHAIN_LOGS_DIR/host-tools.log; then
              echo "âŒ Hostå·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
              if ! make tools/compile -j1 V=s 2>&1 | tee $TOOLCHAIN_LOGS_DIR/host-tools-single.log; then
                echo "âŒ Hostå·¥å…·å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥"
                echo "=== é”™è¯¯åˆ†æ ==="
                tail -50 $TOOLCHAIN_LOGS_DIR/host-tools-single.log | grep -i "error\|failed" | tail -20
                exit 1
              fi
            fi
            
            echo "âœ… Hostå·¥å…·ç¼–è¯‘å®Œæˆ"
            
            # ç¼–è¯‘æœ¬åœ°å·¥å…·é“¾
            echo "ğŸ”§ ç¼–è¯‘æœ¬åœ°å·¥å…·é“¾..."
            if ! make toolchain/compile -j$(($(nproc) - 1)) V=s 2>&1 | tee $TOOLCHAIN_LOGS_DIR/toolchain-compile.log; then
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
              if ! make toolchain/compile -j1 V=s 2>&1 | tee $TOOLCHAIN_LOGS_DIR/toolchain-compile-single.log; then
                echo "âŒ å·¥å…·é“¾å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥"
                echo "=== é”™è¯¯åˆ†æ ==="
                tail -50 $TOOLCHAIN_LOGS_DIR/toolchain-compile-single.log | grep -i "error\|failed" | tail -20
                exit 1
              fi
            fi
            
            echo "âœ… æœ¬åœ°å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"
            echo "result=local" >> $GITHUB_OUTPUT
            ;;
        esac
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        if [ "$DURATION" -gt 1200 ]; then
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ (è¾ƒé•¿)"
          echo "toolchain_duration=$DURATION" >> $GITHUB_ENV
        elif [ "$DURATION" -gt 600 ]; then
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’"
        fi

    - name: "ğŸ” é€šç”¨å·¥å…·é“¾éªŒè¯"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "=== é€šç”¨å·¥å…·é“¾éªŒè¯ ==="
        
        # æ£€æŸ¥ staging_dir ç»“æ„
        echo "=== staging_dir ç»“æ„ ==="
        find staging_dir/ -type d -maxdepth 2 | sort | head -20
        
        # æ£€æŸ¥å…³é”®å·¥å…·
        echo ""
        echo "=== Host å·¥å…·æ£€æŸ¥ ==="
        for tool in m4 flex bison; do
          tool_path=$(find staging_dir/host/bin -name "$tool" -type f 2>/dev/null | head -1)
          if [ -n "$tool_path" ]; then
            echo "âœ… $tool: $tool_path"
          else
            echo "âŒ $tool: æœªæ‰¾åˆ°"
          fi
        done
        
        echo ""
        echo "=== ç›®æ ‡å·¥å…·é“¾æ£€æŸ¥ ==="
        # æŸ¥æ‰¾ç›®æ ‡å·¥å…·é“¾ç›®å½•
        TOOLCHAIN_DIRS=$(find staging_dir/ -name "toolchain-*" -type d | grep -v host | head -5)
        echo "æ‰¾åˆ°å·¥å…·é“¾ç›®å½•:"
        echo "$TOOLCHAIN_DIRS"
        
        # åœ¨ç›®æ ‡å·¥å…·é“¾ä¸­æŸ¥æ‰¾äº¤å‰ç¼–è¯‘å™¨
        TARGET_GCC=$(find staging_dir/toolchain-*/bin/ -name "*gcc" -type f 2>/dev/null | head -1)
        TARGET_STRIP=$(find staging_dir/toolchain-*/bin/ -name "*strip" -type f 2>/dev/null | head -1)
        
        echo "ç›®æ ‡ GCC: $TARGET_GCC"
        echo "ç›®æ ‡ STRIP: $TARGET_STRIP"
        
        if [ -z "$TARGET_GCC" ]; then
          echo "âŒ ä¸¥é‡é”™è¯¯: æœªæ‰¾åˆ°ç›®æ ‡æ¶æ„äº¤å‰ç¼–è¯‘å™¨!"
          exit 1
        fi
        
        # æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦å¯æ‰§è¡Œ
        if [ -x "$TARGET_GCC" ]; then
          echo "âœ… äº¤å‰ç¼–è¯‘å™¨å¯æ‰§è¡Œ"
          echo "ç¼–è¯‘å™¨ç‰ˆæœ¬:"
          $TARGET_GCC --version | head -1 || echo "æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
        else
          echo "âš ï¸ äº¤å‰ç¼–è¯‘å™¨ä¸å¯æ‰§è¡Œï¼Œå°è¯•ä¿®å¤æƒé™..."
          chmod +x "$TARGET_GCC" || echo "æƒé™ä¿®å¤å¤±è´¥"
        fi
        
        echo ""
        echo "âœ… å·¥å…·é“¾éªŒè¯å®Œæˆ - å·¥å…·é“¾å®Œæ•´"

    - name: "ğŸ“¦ é€šç”¨ç›®å½•ç»“æ„é¢„åˆ›å»º"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "ğŸ”„ é¢„åˆ›å»ºé€šç”¨ç›®å½•ç»“æ„ä»¥é˜²æ­¢ç¼–è¯‘é”™è¯¯..."
        
        # åˆ›å»ºé€šç”¨æ„å»ºç›®å½•æ¨¡å¼
        echo "åˆ›å»ºé€šç”¨æ„å»ºç›®å½•..."
        mkdir -p build_dir/target-*/root-*
        mkdir -p build_dir/target-*/linux-*/root-*
        mkdir -p build_dir/target-*/linux-*/image
        mkdir -p build_dir/toolchain-*/linux-*
        
        # åˆ›å»ºé€šç”¨çš„ç›®æ ‡ç›®å½•ç»“æ„
        echo "åˆ›å»ºé€šç”¨ç›®æ ‡ç›®å½•..."
        for arch_dir in build_dir/target-*; do
          if [ -d "$arch_dir" ]; then
            arch_name=$(basename "$arch_dir")
            echo "å¤„ç†æ¶æ„: $arch_name"
            mkdir -p "$arch_dir/root-"*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev}
            mkdir -p "$arch_dir/root.orig-"*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev}
            mkdir -p "$arch_dir/linux-"*/{root-*,image}
          fi
        done
        
        # åˆ›å»ºstagingç›®å½•
        echo "åˆ›å»ºstagingç›®å½•..."
        mkdir -p staging_dir/target-*/root-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev}
        
        # è®¾ç½®æ­£ç¡®çš„æƒé™
        echo "è®¾ç½®ç›®å½•æƒé™..."
        find build_dir staging_dir -name "tmp" -type d -exec chmod 1777 {} \; 2>/dev/null || true
        find build_dir staging_dir -type d -exec chmod 755 {} \; 2>/dev/null || true
        
        echo "âœ… é€šç”¨ç›®å½•ç»“æ„é¢„åˆ›å»ºå®Œæˆ"

    - name: "ğŸ“¦ å¤„ç†è‡ªå®šä¹‰åŠŸèƒ½"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "å¤„ç†è‡ªå®šä¹‰åŠŸèƒ½..."
        
        # å¤„ç†é¢„ç¼–è¯‘IPKåŒ…
        IPK_DIR="$GITHUB_WORKSPACE/firmware-config/custom-features/prebuilt-ipks"
        if [ -d "$IPK_DIR" ]; then
          IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f)
          if [ -n "$IPK_FILES" ]; then
            mkdir -p package/base-files/files/usr/lib/opkg/custom
            for ipk in $IPK_FILES; do
              echo "ğŸ“¥ å¤åˆ¶IPKåŒ…: $(basename "$ipk")"
              cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
            done
            echo "âœ… é¢„ç¼–è¯‘IPKåŒ…å¤„ç†å®Œæˆ"
          fi
        fi
        
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        SCRIPTS_DIR="$GITHUB_WORKSPACE/firmware-config/custom-features/scripts"
        if [ -d "$SCRIPTS_DIR" ]; then
          for script in $(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort); do
            echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
            chmod +x "$script"
            timeout 300 bash "$script" || echo "âš ï¸ è„šæœ¬æ‰§è¡Œå¯èƒ½è¶…æ—¶æˆ–å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»ºæµç¨‹"
          done
        fi

    - name: "ğŸ” æœ€ç»ˆé…ç½®éªŒè¯"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "éªŒè¯æœ€ç»ˆé…ç½®æ–‡ä»¶..."
        make defconfig >/dev/null 2>&1 || echo "defconfig å®Œæˆ"
        
        # æ£€æŸ¥å…³é”®é…ç½®
        echo "å…³é”®é…ç½®æ£€æŸ¥:"
        grep -E "CONFIG_TARGET_|CONFIG_BUSYBOX|CONFIG_LINUX" .config | head -10 || echo "æ— å…³é”®é…ç½®ä¿¡æ¯"
        
        echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

    - name: "ğŸ’¾ ç¼–è¯‘å‰æœ€ç»ˆç©ºé—´æ£€æŸ¥"
      run: |
        echo "=== ç¼–è¯‘å‰æœ€ç»ˆç©ºé—´æ£€æŸ¥ ==="
        echo "æ ¹åˆ†åŒº (/):"
        df -h /
        echo ""
        echo "æ•°æ®åˆ†åŒº (/mnt):"
        df -h /mnt
        
        AVAILABLE_GB=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
        echo ""
        echo "å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}GB"
        
        if [ "$AVAILABLE_GB" -lt 15 ]; then
          echo "âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³15GBï¼Œæ— æ³•å®‰å…¨ç¼–è¯‘"
          exit 1
        elif [ "$AVAILABLE_GB" -lt 25 ]; then
          echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼  (${AVAILABLE_GB}GB)ï¼Œç¼–è¯‘å¯èƒ½ä¼šå¤±è´¥"
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘"
        fi

    - name: "ğŸ—ï¸ é€šç”¨æ™ºèƒ½ç¼–è¯‘å›ºä»¶"
      timeout-minutes: 240
      id: compile-firmware
      run: |
        cd ${{ env.SOURCE_DIR }}
        export TERM=linux
        export FORCE_UNSAFE_CONFIGURE=1
        
        # è®¾ç½®æ€§èƒ½ä¼˜åŒ–ç¯å¢ƒ
        export CCACHE_DIR="${{ env.CCACHE_DIR }}"
        export CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros
        export CCACHE_MAXSIZE=8G
        
        # è·å–CPUæ ¸å¿ƒæ•°
        CPU_CORES=$(nproc)
        echo "ğŸ’» å¯ç”¨CPUæ ¸å¿ƒæ•°: $CPU_CORES"
        
        START_TIME=$(date +%s)
        
        echo "ğŸš€ å¼€å§‹é€šç”¨æ™ºèƒ½ç¼–è¯‘..."
        echo "ğŸ“Š ç¼–è¯‘å‚æ•°:"
        echo "  - æºç åº“: ${{ env.SOURCE_PRESET }}"
        echo "  - å·¥å…·é“¾ç­–ç•¥: ${{ steps.toolchain-setup.outputs.result }}"
        echo "  - ç¼–è¯‘ä¼˜åŒ–: ${{ github.event.inputs.build_optimization }}"
        echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
        echo "  - å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
        echo "  - CPUæ ¸å¿ƒ: $CPU_CORES"
        
        # è®¾ç½®ç¼–è¯‘ç»“æœå˜é‡
        COMPILE_SUCCESS=false
        BUILD_EXIT_CODE=1
        
        # ç¼–è¯‘å‰ç›®å½•æœ€ç»ˆæ£€æŸ¥
        echo "ğŸ”§ ç¼–è¯‘å‰ç›®å½•æœ€ç»ˆæ£€æŸ¥..."
        find build_dir -name "root-*" -type d | head -5 | while read dir; do
          mkdir -p "$dir/tmp" "$dir/var/lock"
          chmod 1777 "$dir/tmp" 2>/dev/null || true
          chmod 755 "$dir/var/lock" 2>/dev/null || true
        done
        
        # æ™ºèƒ½ç¼–è¯‘ç­–ç•¥
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "ğŸš€ æé€Ÿæ¨¡å¼: ä½¿ç”¨ $CPU_CORES çº¿ç¨‹ç¼–è¯‘"
            LOG_FILE="${{ env.BUILD_LOG_DIR }}/speed.log"
            if make -j$CPU_CORES V=sc 2>&1 | tee "$LOG_FILE"; then
              COMPILE_SUCCESS=true
              BUILD_EXIT_CODE=0
            fi
            ;;
          "stability")
            echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: åˆ†é˜¶æ®µç¼–è¯‘"
            LOG_FILE="${{ env.BUILD_LOG_DIR }}/stability.log"
            {
              set -e
              echo "é˜¶æ®µ1: ç¼–è¯‘å†…æ ¸..."
              make target/linux/compile -j$((CPU_CORES / 2)) V=s
              
              echo "é˜¶æ®µ2: ç¼–è¯‘åŒ…..."
              make package/compile -j1 V=s
              
              echo "é˜¶æ®µ3: æœ€ç»ˆå®‰è£…..."
              make target/install -j1 V=s
              
              COMPILE_SUCCESS=true
              BUILD_EXIT_CODE=0
            } 2>&1 | tee "$LOG_FILE"
            ;;
          "balanced"|*)
            echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: æ™ºèƒ½åˆ†é˜¶æ®µç¼–è¯‘"
            LOG_FILE="${{ env.BUILD_LOG_DIR }}/balanced.log"
            {
              set -e
              echo "é˜¶æ®µ1: ç¼–è¯‘å†…æ ¸å’ŒåŸºç¡€åŒ…..."
              make target/linux/compile package/compile -j$CPU_CORES V=s
              
              echo "é˜¶æ®µ2: æœ€ç»ˆå®‰è£…..."
              make target/install -j1 V=s
              
              COMPILE_SUCCESS=true
              BUILD_EXIT_CODE=0
            } 2>&1 | tee "$LOG_FILE"
            ;;
        esac
        
        # æ˜¾ç¤ºccacheç»Ÿè®¡
        echo "ğŸ“Š CCache ç»Ÿè®¡:"
        ccache -s
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
        
        if [ "$COMPILE_SUCCESS" = "true" ] && [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
          echo "â±ï¸ ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"
          exit 0
        else
          echo "BUILD_STATUS=failure" >> $GITHUB_ENV
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          
          # é”™è¯¯åˆ†æ
          echo "=== é”™è¯¯åˆ†æ ==="
          tail -100 "$LOG_FILE" | grep -i "error\|failed\|undefined\|missing" | tail -20 || echo "æ— æ˜ç¡®é”™è¯¯ä¿¡æ¯"
          
          echo "â±ï¸ ç¼–è¯‘å¤±è´¥äº: ${DURATION}ç§’"
          exit 1
        fi

    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      if: always()
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "æ”¶é›†ç¼–è¯‘äº§ç‰©å’Œè¯Šæ–­ä¿¡æ¯..."
        
        mkdir -p ${{ env.ARTIFACTS_DIR }}
        
        # æ”¶é›†å›ºä»¶æ–‡ä»¶
        if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
          echo "æ”¶é›†å›ºä»¶æ–‡ä»¶..."
          find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) -exec cp --parents {} ${{ env.ARTIFACTS_DIR }}/ \; 2>/dev/null || true
        fi
        
        # æ”¶é›†ç¼–è¯‘æ—¥å¿—
        echo "æ”¶é›†ç¼–è¯‘æ—¥å¿—..."
        cp -r ${{ env.BUILD_LOG_DIR }} ${{ env.ARTIFACTS_DIR }}/ 2>/dev/null || true
        
        # æ”¶é›†é…ç½®ä¿¡æ¯
        cp .config ${{ env.ARTIFACTS_DIR }}/config 2>/dev/null || true
        
        # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        {
          echo "=== é€šç”¨å›ºä»¶æ„å»ºæŠ¥å‘Š ==="
          echo "æ„å»ºæ—¶é—´: $(date)"
          echo "ç¼–è¯‘çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
          echo "æºç åº“: ${{ env.SOURCE_PRESET }}"
          echo "æºç åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
          echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "å·¥å…·é“¾: ${{ steps.toolchain-setup.outputs.result }}"
          echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo ""
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          echo "Runner: ${{ runner.os }}"
          echo "CPU: $(nproc) cores"
          echo "å†…å­˜: $(free -h | awk '/^Mem:/{print $2}')"
        } > ${{ env.ARTIFACTS_DIR }}/build-report.txt
        
        # å¤åˆ¶åˆ°å·¥ä½œç›®å½•
        mkdir -p $GITHUB_WORKSPACE/artifacts
        cp -r ${{ env.ARTIFACTS_DIR }}/* $GITHUB_WORKSPACE/artifacts/ 2>/dev/null || true
        
        echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

    - name: "ğŸ§¹ å®‰å…¨æ¸…ç†ç¯å¢ƒ"
      if: always()
      run: |
        echo "å®‰å…¨æ¸…ç†ç¼–è¯‘ç¯å¢ƒ..."
        sudo swapoff /mnt/swapfile 2>/dev/null || true
        sudo rm -rf ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} /mnt/swapfile 2>/dev/null || true
        rm -rf ${{ env.CCACHE_DIR }} 2>/dev/null || true
        rm -rf ${{ env.BUILD_LOG_DIR }} 2>/dev/null || true
        rm -rf /home/runner/toolchain-logs 2>/dev/null || true
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.BUILD_STATUS || 'unknown' }}"
        path: artifacts
        retention-days: 30

    - name: "ğŸ“Š æœ€ç»ˆç¼–è¯‘æŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æœ€ç»ˆç¼–è¯‘æŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "ç¼–è¯‘çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
        
        if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
          echo "â±ï¸ ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’ ($((${{ env.BUILD_DURATION }}/60))åˆ†é’Ÿ)"
          echo "ğŸ“¦ äº§ç‰©å·²ä¸Šä¼ åˆ° Artifacts"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æŸ¥çœ‹ Artifacts ä¸­çš„è¯¦ç»†æ—¥å¿—å’Œè¯Šæ–­ä¿¡æ¯"
        fi
