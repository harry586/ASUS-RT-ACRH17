name: Universal Firmware Builder - Full Detection & Validation

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: é€‰æ‹©æºç åº“
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: immortalwrt
      source_branch:
        description: æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æŒ‡å®š main/master ç­‰)
        required: true
        default: auto
        type: string
      config_profile:
        description: è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„
        required: true
        type: string
        default: firmware-config/configs/.config_rt-ac42u_immortalwrt
      build_optimization:
        description: ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: balanced
      toolchain_strategy:
        description: å·¥å…·é“¾ç­–ç•¥
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: auto
      enable_custom_features:
        description: å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  SOURCE_DIR: /tmp/source
  ARTIFACTS_DIR: /tmp/artifacts
  CCACHE_DIR: /tmp/ccache
  BUILD_LOG_DIR: /tmp/build-logs
  TOOLCHAIN_LOG_DIR: /tmp/toolchain-logs

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: .  # ç›´æ¥æ£€å‡ºåˆ°å½“å‰ç›®å½•

      - name: ğŸ’¾ æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æ
        timeout-minutes: 2
        run: |
          echo "=== æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æ ==="
          echo "ğŸ“Š ç£ç›˜ç©ºé—´:"
          df -h | grep -E "Filesystem|/dev/root|/dev/sda"
          echo ""
          echo "ğŸ’» CPU ä¿¡æ¯:"
          echo "æ ¸å¿ƒæ•°: $(nproc)"
          echo "æ¶æ„: $(uname -m)"
          echo "CPU å‹å·: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
          echo ""
          echo "ğŸ§  å†…å­˜ä¿¡æ¯:"
          free -h
          echo ""
          echo "ğŸ“ å…³é”®ç›®å½•çŠ¶æ€:"
          for dir in /tmp /home/runner /opt /var /usr; do
            if [ -d "$dir" ]; then
              mount_point=$(df "$dir" 2>/dev/null | awk 'NR==2 {print $6}')
              usage=$(df -h "$dir" 2>/dev/null | awk 'NR==2 {print $5}')
              echo "  $dir: æŒ‚è½½ç‚¹=$mount_point, ä½¿ç”¨ç‡=$usage"
            else
              echo "  $dir: ç›®å½•ä¸å­˜åœ¨"
            fi
          done
          echo ""
          echo "ğŸ”„ äº¤æ¢ç©ºé—´: $(swapon --show | wc -l 2>/dev/null || echo 0) ä¸ªäº¤æ¢æ–‡ä»¶"
          echo ""
          echo "âœ… èµ„æºåˆ†æå®Œæˆ - ç³»ç»Ÿå°±ç»ª"

      - name: ğŸ”§ å…¨é¢å·¥ä½œç¯å¢ƒè®¾ç½®
        run: |
          echo "è®¾ç½®å…¨é¢ç¼–è¯‘ç¯å¢ƒ..."
          
          # åˆ›å»ºæ‰€æœ‰å¿…è¦ç›®å½•
          echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          
          # è®¾ç½®æ‰€æœ‰æƒå’Œæƒé™
          echo "ğŸ”’ è®¾ç½®ç›®å½•æƒé™..."
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          sudo chmod -R 777 ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          
          # éªŒè¯ç›®å½•åˆ›å»º
          echo "ğŸ” éªŒè¯ç›®å½•åˆ›å»º..."
          for dir in ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir: åˆ›å»ºæˆåŠŸ"
            else
              echo "âŒ $dir: åˆ›å»ºå¤±è´¥"
              exit 1
            fi
          done
          
          echo "ğŸ”„ åˆ›å»ºé«˜æ€§èƒ½äº¤æ¢æ–‡ä»¶..."
          sudo dd if=/dev/zero of=/swapfile bs=1M count=8192 status=progress
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          echo "âš¡ ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½è®¾ç½®..."
          ulimit -n 65536
          # å¿½ç•¥sysctlæƒé™é”™è¯¯ï¼Œè¿™äº›ä¸æ˜¯å…³é”®è®¾ç½®
          sudo sysctl -w vm.swappiness=60 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®swappinessï¼ˆéå…³é”®é”™è¯¯ï¼‰"
          sudo sysctl -w vm.vfs_cache_pressure=50 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®vfs_cache_pressureï¼ˆéå…³é”®é”™è¯¯ï¼‰"
          
          echo "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color

      - name: ğŸ” é…ç½®æ–‡ä»¶éªŒè¯
        run: |
          echo "=== é…ç½®æ–‡ä»¶éªŒè¯ ==="
          
          # æ£€æŸ¥ç›®å½•ç»“æ„
          echo "ğŸ“ é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„:"
          find . -type f \( -name "*.json" -o -name ".config_*" \) 2>/dev/null | head -10 || echo "æ— é…ç½®æ–‡ä»¶"
          
          # é‡ç‚¹æ£€æŸ¥ repositories.json - åŸºäºæ‚¨çš„ç›®å½•ç»“æ„
          echo ""
          echo "ğŸ” æ£€æŸ¥ repositories.json æ–‡ä»¶..."
          
          # åŸºäºæ‚¨çš„ç›®å½•ç»“æ„æŸ¥æ‰¾
          REPO_JSON_PATHS=(
            "firmware-config/repositories.json"
            "./firmware-config/repositories.json"
          )
          
          REPO_JSON_FOUND=""
          for path in "${REPO_JSON_PATHS[@]}"; do
            if [ -f "$path" ]; then
              REPO_JSON_FOUND="$path"
              echo "âœ… æ‰¾åˆ° repositories.json: $path"
              echo "æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
              ls -la "$path"
              break
            else
              echo "âŒ æœªæ‰¾åˆ°: $path"
            fi
          done
          
          if [ -z "$REPO_JSON_FOUND" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° repositories.json æ–‡ä»¶"
            echo ""
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo ""
            echo "ç›®å½•å†…å®¹:"
            ls -la
            echo ""
            echo "firmware-config ç›®å½•å†…å®¹:"
            ls -la firmware-config/ 2>/dev/null || echo "firmware-config ç›®å½•ä¸å­˜åœ¨"
            echo ""
            echo "æœç´¢çš„æ–‡ä»¶è·¯å¾„: ${REPO_JSON_PATHS[*]}"
            exit 1
          fi
          
          echo "âœ… ä½¿ç”¨ repositories.json æ–‡ä»¶: $REPO_JSON_FOUND"
          echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
          
          # éªŒè¯JSONæ ¼å¼
          echo ""
          echo "ğŸ” JSONæ ¼å¼éªŒè¯..."
          if jq . "$REPO_JSON_FOUND" > /dev/null 2>&1; then
            echo "âœ… JSONæ ¼å¼æ­£ç¡®"
          else
            echo "âŒ JSONæ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          # éªŒè¯å¿…éœ€å­—æ®µ
          echo ""
          echo "ğŸ” å¿…éœ€å­—æ®µéªŒè¯..."
          REQUIRED_PRESETS=("immortalwrt" "openwrt" "lede")
          for preset in "${REQUIRED_PRESETS[@]}"; do
            if jq -e ".repositories.$preset.url" "$REPO_JSON_FOUND" >/dev/null 2>&1; then
              echo "âœ… $preset: URLå­—æ®µå­˜åœ¨"
            else
              echo "âŒ $preset: URLå­—æ®µç¼ºå¤±"
              exit 1
            fi
            
            if jq -e ".repositories.$preset.recommended_branch" "$REPO_JSON_FOUND" >/dev/null 2>&1; then
              echo "âœ… $preset: recommended_branchå­—æ®µå­˜åœ¨"
            else
              echo "âŒ $preset: recommended_branchå­—æ®µç¼ºå¤±"
              exit 1
            fi
          done
          
          echo ""
          echo "âœ… æ‰€æœ‰é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: ğŸ”§ æ™ºèƒ½æºç é…ç½®è§£æ
        id: source-config
        run: |
          echo "æ­£åœ¨æ™ºèƒ½è§£ææºç é…ç½®..."
          
          PRESET="${{ github.event.inputs.source_preset }}"
          echo "ä½¿ç”¨çš„é¢„è®¾: $PRESET"
          
          # ä½¿ç”¨æ‰¾åˆ°çš„JSONæ–‡ä»¶è·¯å¾„
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          
          # éªŒè¯é¢„è®¾æœ‰æ•ˆæ€§
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯: é¢„è®¾ '$PRESET' ä¸å­˜åœ¨"
            echo "å¯ç”¨çš„é¢„è®¾:"
            jq -r '.repositories | keys[]' "$REPO_JSON_PATH"
            exit 1
          fi
          
          # è·å–æºç é…ç½®
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"æœªçŸ¥\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          
          echo "âœ… æˆåŠŸè·å–é…ç½®ä¿¡æ¯"
          
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "ğŸ¤– è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
          else
            echo "ğŸ“‹ ä½¿ç”¨æŒ‡å®šåˆ†æ”¯: $BRANCH"
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "RECOMMENDED_BRANCH=$RECOMMENDED_BRANCH" >> $GITHUB_ENV
          
          echo ""
          echo "âœ… æºç é…ç½®è§£æå®Œæˆ"
          echo "ğŸ“Š é…ç½®è¯¦æƒ…:"
          echo "  - é¢„è®¾: $PRESET"
          echo "  - æè¿°: $DESCRIPTION"
          echo "  - ä»“åº“: $SOURCE_URL"
          echo "  - åˆ†æ”¯: $BRANCH"
          echo "  - æ¨èåˆ†æ”¯: $RECOMMENDED_BRANCH"

      - name: ğŸ› ï¸ å…¨é¢ç¼–è¯‘ä¾èµ–å®‰è£…ä¸éªŒè¯
        run: |
          echo "å®‰è£…å…¨é¢ç¼–è¯‘ä¾èµ–åŒ…..."
          sudo apt-get update
          
          # åˆ†ç±»å®‰è£…ä¾èµ–åŒ…
          echo "ğŸ“¦ å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          
          echo "ğŸ“¦ å®‰è£…å¼€å‘åº“..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools
          
          echo "ğŸ“¦ å®‰è£…å·¥å…·é“¾ä¾èµ–..."
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache m4 help2man texinfo texi2html
          
          echo "ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·..."
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion mercurial curl cmake ninja-build
          
          echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿåº“..."
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libc6-dev libxml2-dev liblzma-dev liblzo2-dev
          
          echo "ğŸ” ä¾èµ–å®‰è£…éªŒè¯..."
          
          # éªŒè¯å…³é”®å·¥å…·
          echo "=== å…³é”®å·¥å…·éªŒè¯ ==="
          for tool in gcc g++ make flex bison git curl wget; do
            if command -v $tool >/dev/null 2>&1; then
              version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-4 | tr -d '\n' || echo "å¯ç”¨")
              echo "âœ… $tool: $version"
            else
              echo "âŒ $tool: æœªå®‰è£…"
              exit 1
            fi
          done
          
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å’ŒéªŒè¯å®Œæˆ"

      - name: âš¡ é«˜çº§ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–
        run: |
          echo "è®¾ç½®é«˜çº§ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–..."
          
          # CCacheé…ç½®
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M 8G
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=100000
          ccache -o sloppiness=file_macro,include_file_mtime,include_file_ctime,time_macros
          
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=8G" >> $GITHUB_ENV
          echo "CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros" >> $GITHUB_ENV
          
          echo "ğŸ“Š åˆå§‹CCacheç»Ÿè®¡:"
          ccache -s
          
          # ç³»ç»Ÿä¼˜åŒ–
          echo "ğŸ”§ ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–..."
          echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®sysctlé…ç½®ï¼ˆéå…³é”®ï¼‰"
          echo "vm.vfs_cache_pressure=50" | sudo tee -a /etc/sysctl.conf 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®sysctlé…ç½®ï¼ˆéå…³é”®ï¼‰"
          sudo sysctl -p 2>/dev/null || echo "âš ï¸ æ— æ³•åº”ç”¨sysctlé…ç½®ï¼ˆéå…³é”®ï¼‰"
          
          echo "âœ… ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–å®Œæˆ"

      - name: ğŸ“¥ æ™ºèƒ½æºç è·å–ä¸éªŒè¯
        id: clone-source
        run: |
          echo "å¼€å§‹æ™ºèƒ½æºç è·å–..."
          cd ${{ env.SOURCE_DIR }}
          
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          echo "ğŸ¯ è¯·æ±‚åˆ†æ”¯: $REQUESTED_BRANCH"
          echo "ğŸ¯ æºç ä»“åº“: ${{ env.SOURCE_URL }}"
          
          # å®šä¹‰å…‹éš†ç­–ç•¥ - ä¿®å¤åˆ†æ”¯æŸ¥æ‰¾é€»è¾‘
          CLONE_STRATEGIES=(
            "æŒ‡å®šåˆ†æ”¯: git clone --depth 1 --branch $REQUESTED_BRANCH ${{ env.SOURCE_URL }} ."
            "mainåˆ†æ”¯: git clone --depth 1 --branch main ${{ env.SOURCE_URL }} ."
            "masteråˆ†æ”¯: git clone --depth 1 --branch master ${{ env.SOURCE_URL }} ."
            "é»˜è®¤åˆ†æ”¯: git clone --depth 1 ${{ env.SOURCE_URL }} ."
          )
          
          CLONE_SUCCESS=false
          for strategy in "${CLONE_STRATEGIES[@]}"; do
            strategy_name=$(echo "$strategy" | cut -d: -f1)
            clone_cmd=$(echo "$strategy" | cut -d: -f2-)
            
            echo ""
            echo "ğŸ”§ å°è¯•ç­–ç•¥: $strategy_name"
            echo "å‘½ä»¤: $clone_cmd"
            
            # æ¸…ç†ç›®å½•
            rm -rf .[!.]* * 2>/dev/null || true
            
            if eval $clone_cmd 2>&1 | tee /tmp/clone.log; then
              # éªŒè¯å…‹éš†æ˜¯å¦çœŸçš„æˆåŠŸ
              if [ -d ".git" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                echo "âœ… å…‹éš†æˆåŠŸ: $strategy_name"
                echo "ğŸ“‹ å®é™…åˆ†æ”¯: $ACTUAL_BRANCH"
                CLONE_SUCCESS=true
                break
              else
                echo "âš ï¸ Gitç›®å½•æœªåˆ›å»ºï¼Œç»§ç»­å°è¯•å…¶ä»–ç­–ç•¥..."
              fi
            else
              echo "âŒ ç­–ç•¥å¤±è´¥: $strategy_name"
              # æ˜¾ç¤ºå…‹éš†é”™è¯¯è¯¦æƒ…
              if [ -f "/tmp/clone.log" ]; then
                echo "å…‹éš†é”™è¯¯è¯¦æƒ…:"
                tail -20 /tmp/clone.log
              fi
            fi
          done
          
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰å…‹éš†ç­–ç•¥éƒ½å¤±è´¥"
            echo "ğŸ” æœ€åå°è¯•çš„å…‹éš†æ—¥å¿—:"
            cat /tmp/clone.log 2>/dev/null || echo "æ— å…‹éš†æ—¥å¿—"
            exit 1
          fi
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          
          # æºç éªŒè¯
          echo ""
          echo "ğŸ” æºç ä»“åº“éªŒè¯..."
          echo "ğŸ“ æºç ç›®å½•ç»“æ„:"
          ls -la | head -10
          echo ""
          echo "ğŸ“Š ä»“åº“ä¿¡æ¯:"
          git log --oneline -3 2>/dev/null || echo "æ— æ³•è·å–æäº¤å†å²"
          echo ""
          echo "ğŸŒ¿ åˆ†æ”¯ä¿¡æ¯:"
          git branch -a 2>/dev/null | head -5 || echo "æ— æ³•è·å–åˆ†æ”¯ä¿¡æ¯"
          
          echo ""
          echo "âœ… æºç è·å–ä¸éªŒè¯å®Œæˆ"

      - name: ğŸ’¾ æºç è·å–åç©ºé—´ç›‘æµ‹
        run: |
          echo "=== æºç è·å–åç©ºé—´ç›‘æµ‹ ==="
          echo "ğŸ“Š å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

          AVAILABLE_GB=$(df /tmp | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}GB"

          if [ "$AVAILABLE_GB" -lt 15 ]; then
            echo "ğŸš¨ ä¸¥é‡è­¦å‘Š: ç£ç›˜ç©ºé—´ä¸è¶³15GBï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
            exit 1
          elif [ "$AVAILABLE_GB" -lt 25 ]; then
            echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼  (${AVAILABLE_GB}GB)"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi

      - name: ğŸ”„ æ™ºèƒ½æºç åˆå§‹åŒ–
        timeout-minutes: 45
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹æ™ºèƒ½æºç åˆå§‹åŒ–..."
          START_TIME=$(date +%s)
          
          # Feedsé…ç½®æ£€æµ‹ä¸ä¿®å¤
          echo "ğŸ”§ Feedsé…ç½®æ£€æµ‹..."
          if [ -f "feeds.conf" ]; then
            echo "ğŸ“‹ ä½¿ç”¨ç°æœ‰ feeds.conf"
          elif [ -f "feeds.conf.default" ]; then
            echo "ğŸ“‹ ä½¿ç”¨ feeds.conf.default"
            cp feeds.conf.default feeds.conf
          else
            echo "âš ï¸ æœªæ‰¾åˆ°feedsé…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®"
            echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
            echo "src-git luci https://git.openwrt.org/feed/luci.git" >> feeds.conf
            echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
            echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
          fi
          
          # Feedsæ›´æ–°ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          echo "ğŸ”„ æ›´æ–°Feeds..."
          for i in 1 2 3; do
            echo "å°è¯• $i/3"
            if ./scripts/feeds update -a; then
              echo "âœ… Feedsæ›´æ–°æˆåŠŸ"
              break
            else
              echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
              if [ $i -eq 3 ]; then
                echo "ğŸ” Feedsæ›´æ–°å¤±è´¥åˆ†æ:"
                tail -50 ${{ env.BUILD_LOG_DIR }}/feeds-update.log 2>/dev/null || echo "æ— è¯¦ç»†æ—¥å¿—"
                exit 1
              fi
              sleep 5
            fi
          done
          
          # Feedså®‰è£…
          echo "ğŸ“¦ å®‰è£…Feeds..."
          if ! ./scripts/feeds install -a; then
            echo "âš ï¸ å®Œæ•´å®‰è£…å¤±è´¥ï¼Œå°è¯•åŸºç¡€å®‰è£…..."
            ./scripts/feeds install -a -p packages
            ./scripts/feeds install -a -p luci
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Feedsåˆå§‹åŒ–è€—æ—¶: ${DURATION}ç§’"
          echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ¨ é…ç½®åº”ç”¨ä¸éªŒè¯
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "åº”ç”¨è®¾å¤‡é…ç½®..."
          
          CONFIG_FILE="${{ github.event.inputs.config_profile }}"
          echo "æ­£åœ¨æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          
          # åŸºäºæ‚¨çš„ç›®å½•ç»“æ„æŸ¥æ‰¾é…ç½®æ–‡ä»¶
          CONFIG_PATHS=(
            "$CONFIG_FILE"
            "../$CONFIG_FILE"
            "../../$CONFIG_FILE"
            "firmware-config/configs/$(basename $CONFIG_FILE)"
            "../firmware-config/configs/$(basename $CONFIG_FILE)"
          )
          
          CONFIG_FOUND=""
          for path in "${CONFIG_PATHS[@]}"; do
            if [ -f "$path" ]; then
              CONFIG_FOUND="$path"
              echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $path"
              echo "æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
              ls -la "$path"
              break
            else
              echo "âŒ æœªæ‰¾åˆ°: $path"
            fi
          done
          
          if [ -z "$CONFIG_FOUND" ]; then
            echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ '$CONFIG_FILE' ä¸å­˜åœ¨"
            echo ""
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo ""
            echo "ç›®å½•ç»“æ„è¯¦æƒ…:"
            echo "å½“å‰ç›®å½•:"
            ls -la
            echo ""
            echo "ä¸Šçº§ç›®å½•:"
            ls -la ../
            echo ""
            echo "ä¸Šä¸Šçº§ç›®å½•:"
            ls -la ../../
            echo ""
            echo "æ‰€æœ‰å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
            find . -name ".config_*" -o -name "*.config" 2>/dev/null | head -20 || echo "æ— é…ç½®æ–‡ä»¶"
            echo ""
            echo "firmware-config/configs ç›®å½•ä¸­çš„æ–‡ä»¶:"
            ls -la firmware-config/configs/ 2>/dev/null || echo "firmware-config/configs ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å¤‡ä»½åŸå§‹é…ç½®
          cp "$CONFIG_FOUND" .config
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ: $(basename $CONFIG_FOUND)"
          
          # é…ç½®éªŒè¯
          echo "ğŸ” é…ç½®éªŒè¯..."
          if [ ! -f ".config" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶æœªæ­£ç¡®åº”ç”¨"
            exit 1
          fi
          
          echo "ğŸ“‹ å…³é”®é…ç½®é¡¹:"
          grep -E "CONFIG_TARGET_|CONFIG_BUSYBOX|CONFIG_LINUX" .config | head -10 || echo "æ— å…³é”®é…ç½®ä¿¡æ¯"
          
          # é…ç½®æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
          CONFIG_SIZE=$(stat -c%s .config)
          if [ "$CONFIG_SIZE" -lt 100 ]; then
            echo "âŒ é…ç½®æ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½æŸå"
            exit 1
          fi
          
          echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

      - name: ğŸ”§ é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "åº”ç”¨é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®..."
          
          # åŸºç¡€ä¼˜åŒ–
          echo "âš¡ åº”ç”¨åŸºç¡€ä¼˜åŒ–..."
          sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_BUILD_LOG=y/# CONFIG_BUILD_LOG is not set/' .config 2>/dev/null || true
          
          # å¯ç”¨ccache
          echo "CONFIG_CCACHE=y" >> .config
          
          # æ ¹æ®ä¼˜åŒ–ç­–ç•¥è°ƒæ•´
          case "${{ github.event.inputs.build_optimization }}" in
            "speed")
              echo "ğŸš€ åº”ç”¨æé€Ÿä¼˜åŒ–é…ç½®..."
              echo "CONFIG_DEBUG_INFO=n" >> .config
              ;;
            "stability")
              echo "ğŸ›¡ï¸ åº”ç”¨ç¨³å®šä¼˜åŒ–é…ç½®..."
              echo "CONFIG_SMALL_FLASH=y" >> .config
              ;;
            *)
              echo "âš–ï¸ åº”ç”¨å¹³è¡¡ä¼˜åŒ–é…ç½®..."
              ;;
          esac
          
          # è‡ªåŠ¨å¤„ç†é…ç½®
          echo "ğŸ”„ è¿è¡Œé…ç½®å¤„ç†..."
          yes "" | make oldconfig >/dev/null 2>&1 || echo "é…ç½®å¤„ç†å®Œæˆ"
          
          echo "âœ… æ€§èƒ½ä¼˜åŒ–é…ç½®å®Œæˆ"

      - name: ğŸ› ï¸ å…¨é¢å·¥å…·é“¾ç¼–è¯‘ä¸éªŒè¯
        timeout-minutes: 120
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹å…¨é¢å·¥å…·é“¾ç¼–è¯‘..."
          START_TIME=$(date +%s)
          mkdir -p ${{ env.TOOLCHAIN_LOG_DIR }}
          
          # æ¸…ç†æ—§å·¥å…·é“¾
          echo "ğŸ§¹ æ¸…ç†æ—§å·¥å…·é“¾..."
          rm -rf staging_dir/toolchain-* build_dir/toolchain-*
          
          # Hostå·¥å…·ç¼–è¯‘
          echo "ğŸ”§ ç¼–è¯‘Hostå·¥å…·..."
          if ! make tools/compile -j$(($(nproc) - 1)) V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools.log; then
            echo "âŒ Hostå·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if ! make tools/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools-single.log; then
              echo "âŒ Hostå·¥å…·ç¼–è¯‘å½»åº•å¤±è´¥"
              exit 1
            fi
          fi
          
          # Hostå·¥å…·éªŒè¯
          echo "ğŸ” Hostå·¥å…·éªŒè¯..."
          REQUIRED_HOST_TOOLS="m4 flex bison"
          for tool in $REQUIRED_HOST_TOOLS; do
            if [ -f "staging_dir/host/bin/$tool" ]; then
              echo "âœ… $tool: å­˜åœ¨"
            else
              echo "âŒ $tool: ç¼ºå¤±"
              exit 1
            fi
          done
          
          # å·¥å…·é“¾ç¼–è¯‘
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾..."
          if ! make toolchain/compile -j$(($(nproc) - 1)) V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile.log; then
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if ! make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile-single.log; then
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å½»åº•å¤±è´¥"
              exit 1
            fi
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’"
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: ğŸ” æ·±åº¦å·¥å…·é“¾éªŒè¯
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== æ·±åº¦å·¥å…·é“¾éªŒè¯ ==="
          
          # ç›®å½•ç»“æ„éªŒè¯
          echo "ğŸ“ å·¥å…·é“¾ç›®å½•ç»“æ„:"
          find staging_dir/ -type d -maxdepth 2 | sort
          
          # Hostå·¥å…·è¯¦ç»†éªŒè¯
          echo ""
          echo "ğŸ”§ Hostå·¥å…·è¯¦ç»†éªŒè¯:"
          for tool in m4 flex bison; do
            tool_path=$(find staging_dir/host/bin -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$tool_path" ] && [ -x "$tool_path" ]; then
              version=$("$tool_path" --version 2>/dev/null | head -1 || echo "å¯æ‰§è¡Œ")
              echo "âœ… $tool: $version"
            else
              echo "âŒ $tool: ç¼ºå¤±æˆ–ä¸å¯æ‰§è¡Œ"
              exit 1
            fi
          done
          
          # ç›®æ ‡å·¥å…·é“¾éªŒè¯
          echo ""
          echo "ğŸ¯ ç›®æ ‡å·¥å…·é“¾éªŒè¯:"
          TARGET_GCC=$(find staging_dir/toolchain-*/bin/ -name "*gcc" -type f 2>/dev/null | head -1)
          TARGET_STRIP=$(find staging_dir/toolchain-*/bin/ -name "*strip" -type f 2>/dev/null | head -1)
          TARGET_LD=$(find staging_dir/toolchain-*/bin/ -name "*ld" -type f 2>/dev/null | head -1)
          
          if [ -n "$TARGET_GCC" ] && [ -x "$TARGET_GCC" ]; then
            echo "âœ… ç›®æ ‡GCC: $TARGET_GCC"
            echo "ğŸ“‹ GCCç‰ˆæœ¬: $($TARGET_GCC --version | head -1)"
          else
            echo "âŒ ç›®æ ‡GCC: ç¼ºå¤±æˆ–ä¸å¯æ‰§è¡Œ"
            exit 1
          fi
          
          if [ -n "$TARGET_STRIP" ] && [ -x "$TARGET_STRIP" ]; then
            echo "âœ… ç›®æ ‡STRIP: $TARGET_STRIP"
          else
            echo "âŒ ç›®æ ‡STRIP: ç¼ºå¤±æˆ–ä¸å¯æ‰§è¡Œ"
          fi
          
          if [ -n "$TARGET_LD" ] && [ -x "$TARGET_LD" ]; then
            echo "âœ… ç›®æ ‡LD: $TARGET_LD"
          else
            echo "âŒ ç›®æ ‡LD: ç¼ºå¤±æˆ–ä¸å¯æ‰§è¡Œ"
          fi
          
          # å·¥å…·é“¾å®Œæ•´æ€§æ£€æŸ¥
          echo ""
          echo "ğŸ” å·¥å…·é“¾å®Œæ•´æ€§æ£€æŸ¥..."
          TOOLCHAIN_BIN_DIR=$(dirname "$TARGET_GCC" 2>/dev/null)
          if [ -n "$TOOLCHAIN_BIN_DIR" ] && [ -d "$TOOLCHAIN_BIN_DIR" ]; then
            TOOL_COUNT=$(ls "$TOOLCHAIN_BIN_DIR" | wc -l)
            echo "å·¥å…·é“¾å·¥å…·æ•°é‡: $TOOL_COUNT"
            if [ "$TOOL_COUNT" -lt 10 ]; then
              echo "âš ï¸ å·¥å…·é“¾å·¥å…·æ•°é‡è¿‡å°‘ï¼Œå¯èƒ½ä¸å®Œæ•´"
            fi
          fi
          
          echo "âœ… æ·±åº¦å·¥å…·é“¾éªŒè¯å®Œæˆ"

      - name: ğŸ“¦ æ™ºèƒ½è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†
        if: github.event.inputs.enable_custom_features == 'true'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¤„ç†æ™ºèƒ½è‡ªå®šä¹‰åŠŸèƒ½..."
          
          # åŸºäºæ‚¨çš„ç›®å½•ç»“æ„æŸ¥æ‰¾è‡ªå®šä¹‰åŠŸèƒ½
          CUSTOM_PATHS=(
            "firmware-config/custom-features"
            "../firmware-config/custom-features"
            "../../firmware-config/custom-features"
          )
          
          # é¢„ç¼–è¯‘IPKåŒ…å¤„ç†
          IPK_FOUND=false
          for base_path in "${CUSTOM_PATHS[@]}"; do
            IPK_DIR="$base_path/prebuilt-ipks"
            if [ -d "$IPK_DIR" ]; then
              echo "ğŸ“¦ å¤„ç†é¢„ç¼–è¯‘IPKåŒ…..."
              IPK_COUNT=$(find "$IPK_DIR" -name "*.ipk" -type f | wc -l)
              if [ "$IPK_COUNT" -gt 0 ]; then
                mkdir -p package/base-files/files/usr/lib/opkg/custom
                find "$IPK_DIR" -name "*.ipk" -exec cp {} package/base-files/files/usr/lib/opkg/custom/ \;
                echo "âœ… å·²å¤åˆ¶ $IPK_COUNT ä¸ªIPKåŒ…"
                
                # éªŒè¯IPKåŒ…
                echo "ğŸ” éªŒè¯IPKåŒ…..."
                for ipk in package/base-files/files/usr/lib/opkg/custom/*.ipk; do
                  if [ -f "$ipk" ]; then
                    ipk_size=$(stat -c%s "$ipk")
                    if [ "$ipk_size" -gt 1000 ]; then
                      echo "âœ… $(basename $ipk): æœ‰æ•ˆ ($ipk_size å­—èŠ‚)"
                    else
                      echo "âš ï¸ $(basename $ipk): æ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½æŸå"
                    fi
                  fi
                done
                IPK_FOUND=true
                break
              fi
            fi
          done
          
          if [ "$IPK_FOUND" = "false" ]; then
            echo "â„¹ï¸ æ— IPKåŒ…ç›®å½•æˆ–æ–‡ä»¶"
          fi
          
          # è‡ªå®šä¹‰è„šæœ¬å¤„ç†
          SCRIPTS_FOUND=false
          for base_path in "${CUSTOM_PATHS[@]}"; do
            SCRIPTS_DIR="$base_path/scripts"
            if [ -d "$SCRIPTS_DIR" ]; then
              echo "ğŸ“œ å¤„ç†è‡ªå®šä¹‰è„šæœ¬..."
              SCRIPT_COUNT=$(find "$SCRIPTS_DIR" -name "*.sh" -type f | wc -l)
              if [ "$SCRIPT_COUNT" -gt 0 ]; then
                for script in $(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort); do
                  echo "â–¶ï¸ æ‰§è¡Œè„šæœ¬: $(basename $script)"
                  chmod +x "$script"
                  if timeout 600 bash "$script"; then
                    echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ: $(basename $script)"
                  else
                    echo "âš ï¸ è„šæœ¬æ‰§è¡Œå¤±è´¥æˆ–è¶…æ—¶: $(basename $script)"
                  fi
                done
                SCRIPTS_FOUND=true
                break
              fi
            fi
          done
          
          if [ "$SCRIPTS_FOUND" = "false" ]; then
            echo "â„¹ï¸ æ— è„šæœ¬ç›®å½•æˆ–æ–‡ä»¶"
          fi
          
          echo "âœ… è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†å®Œæˆ"

      - name: ğŸ” å…¨é¢ç›®å½•ç»“æ„é¢„åˆ›å»º
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "é¢„åˆ›å»ºå…¨é¢ç›®å½•ç»“æ„..."
          
          # æ£€æµ‹ç›®æ ‡æ¶æ„
          echo "ğŸ” æ£€æµ‹ç›®æ ‡æ¶æ„..."
          TARGET_PATTERN=$(grep "CONFIG_TARGET_ARCH_PACKAGES" .config | cut -d= -f2 | tr -d '"' | cut -d_ -f1)
          echo "æ£€æµ‹åˆ°æ¶æ„æ¨¡å¼: $TARGET_PATTERN"
          
          # åˆ›å»ºé€šç”¨ç›®å½•ç»“æ„
          echo "ğŸ“ åˆ›å»ºé€šç”¨ç›®å½•ç»“æ„..."
          mkdir -p build_dir/target-*/root-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev,run,lock}
          mkdir -p build_dir/target-*/root.orig-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev,run,lock}
          mkdir -p build_dir/target-*/linux-*/{root-*,image}
          mkdir -p staging_dir/target-*/root-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev,run,lock}
          
          # è®¾ç½®æƒé™
          echo "ğŸ”’ è®¾ç½®ç›®å½•æƒé™..."
          find build_dir staging_dir -name "tmp" -type d -exec chmod 1777 {} \; 2>/dev/null || true
          find build_dir staging_dir -name "lock" -type d -exec chmod 755 {} \; 2>/dev/null || true
          find build_dir staging_dir -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          # éªŒè¯ç›®å½•åˆ›å»º
          echo "ğŸ” éªŒè¯ç›®å½•åˆ›å»º..."
          DIR_COUNT=$(find build_dir staging_dir -type d | wc -l)
          echo "åˆ›å»ºçš„ç›®å½•æ•°é‡: $DIR_COUNT"
          echo "âœ… ç›®å½•ç»“æ„é¢„åˆ›å»ºå®Œæˆ"

      - name: ğŸ’¾ ç¼–è¯‘å‰æœ€ç»ˆç©ºé—´ç›‘æµ‹ä¸æ¸…ç†
        run: |
          echo "=== ç¼–è¯‘å‰æœ€ç»ˆç©ºé—´ç›‘æµ‹ä¸æ¸…ç† ==="
          echo "ğŸ“Š è¯¦ç»†ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

          AVAILABLE_GB=$(df /tmp | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo ""
          echo "ğŸ“ˆ å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}GB"

          if [ "$AVAILABLE_GB" -lt 10 ]; then
            echo "ğŸš¨ ä¸¥é‡é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³10GBï¼Œæ— æ³•ç¼–è¯‘"
            exit 1
          elif [ "$AVAILABLE_GB" -lt 20 ]; then
            echo "âš ï¸ ä¸¥é‡è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼  (${AVAILABLE_GB}GB)ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
            echo "ğŸ§¹ æ‰§è¡Œç´§æ€¥ç©ºé—´æ¸…ç†..."
            sudo apt-get clean
            sudo rm -rf /var/lib/apt/lists/*
            sudo sync
            echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
            echo "ğŸ“Š æ¸…ç†åç©ºé—´:"
            df -h
          elif [ "$AVAILABLE_GB" -lt 30 ]; then
            echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´æœ‰é™ (${AVAILABLE_GB}GB)"
          else
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
          fi

          echo ""
          echo "ğŸ§  å†…å­˜å’Œäº¤æ¢ç©ºé—´:"
          free -h

      - name: ğŸ—ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶
        timeout-minutes: 240
        id: compile-firmware
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹æ™ºèƒ½ç¼–è¯‘å›ºä»¶..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=linux
          
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros
          
          CPU_CORES=$(nproc)
          mkdir -p ${{ env.BUILD_LOG_DIR }}
          START_TIME=$(date +%s)
          
          echo "ğŸ“Š ç¼–è¯‘å‚æ•°æ±‡æ€»:"
          echo "  - æºç åº“: ${{ env.SOURCE_PRESET }}"
          echo "  - å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "  - å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - CPUæ ¸å¿ƒ: $CPU_CORES"
          echo "  - CCache: å·²å¯ç”¨"
          
          COMPILE_SUCCESS=false
          BUILD_EXIT_CODE=1
          
          # æ™ºèƒ½ç¼–è¯‘ç­–ç•¥
          case "${{ github.event.inputs.build_optimization }}" in
            "speed")
              echo "ğŸš€ æ‰§è¡Œæé€Ÿç¼–è¯‘æ¨¡å¼..."
              LOG_FILE="${{ env.BUILD_LOG_DIR }}/speed-compile.log"
              {
                echo "é˜¶æ®µ1: å…¨æ ¸å¿ƒç¼–è¯‘..."
                if make -j$CPU_CORES V=s; then
                  COMPILE_SUCCESS=true
                  BUILD_EXIT_CODE=0
                fi
              } 2>&1 | tee "$LOG_FILE"
              ;;
            "stability")
              echo "ğŸ›¡ï¸ æ‰§è¡Œç¨³å®šç¼–è¯‘æ¨¡å¼..."
              LOG_FILE="${{ env.BUILD_LOG_DIR }}/stability-compile.log"
              {
                set -e
                echo "é˜¶æ®µ1: ç¼–è¯‘å†…æ ¸..."
                make target/linux/compile -j$((CPU_CORES / 2)) V=s
                echo "é˜¶æ®µ2: ç¼–è¯‘è½¯ä»¶åŒ…..."
                make package/compile -j1 V=s
                echo "é˜¶æ®µ3: æœ€ç»ˆç»„è£…..."
                make target/install -j1 V=s
                COMPILE_SUCCESS=true
                BUILD_EXIT_CODE=0
              } 2>&1 | tee "$LOG_FILE"
              ;;
            "balanced")
              echo "âš–ï¸ æ‰§è¡Œå¹³è¡¡ç¼–è¯‘æ¨¡å¼..."
              LOG_FILE="${{ env.BUILD_LOG_DIR }}/balanced-compile.log"
              {
                set -e
                echo "é˜¶æ®µ1: ç¼–è¯‘å†…æ ¸å’ŒåŸºç¡€åŒ…..."
                make target/linux/compile -j$CPU_CORES V=s
                echo "é˜¶æ®µ2: ç¼–è¯‘æ‰€æœ‰è½¯ä»¶åŒ…..."
                make package/compile -j$((CPU_CORES / 2)) V=s
                echo "é˜¶æ®µ3: æœ€ç»ˆå®‰è£…..."
                make target/install -j1 V=s
                COMPILE_SUCCESS=true
                BUILD_EXIT_CODE=0
              } 2>&1 | tee "$LOG_FILE"
              ;;
            *)
              echo "âš–ï¸ æ‰§è¡Œé»˜è®¤ç¼–è¯‘æ¨¡å¼..."
              LOG_FILE="${{ env.BUILD_LOG_DIR }}/default-compile.log"
              {
                set -e
                echo "é˜¶æ®µ1: ç¼–è¯‘å†…æ ¸å’ŒåŸºç¡€åŒ…..."
                make target/linux/compile -j$CPU_CORES V=s
                echo "é˜¶æ®µ2: ç¼–è¯‘æ‰€æœ‰è½¯ä»¶åŒ…..."
                make package/compile -j$((CPU_CORES / 2)) V=s
                echo "é˜¶æ®µ3: æœ€ç»ˆå®‰è£…..."
                make target/install -j1 V=s
                COMPILE_SUCCESS=true
                BUILD_EXIT_CODE=0
              } 2>&1 | tee "$LOG_FILE"
              ;;
          esac
          
          # æ˜¾ç¤ºç¼–è¯‘ç»Ÿè®¡
          echo "ğŸ“Š CCache ç¼–è¯‘ç»Ÿè®¡:"
          ccache -s
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
          
          if [ "$COMPILE_SUCCESS" = "true" ] && [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
            echo "â±ï¸ æ€»ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"
            exit 0
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            
            # é”™è¯¯åˆ†æ
            echo "=== è¯¦ç»†é”™è¯¯åˆ†æ ==="
            tail -200 "$LOG_FILE" | grep -i "error\|failed\|undefined\|missing\|no such file" | tail -50 || echo "æ— æ˜ç¡®é”™è¯¯ä¿¡æ¯"
            
            echo "â±ï¸ ç¼–è¯‘å¤±è´¥äº: ${DURATION}ç§’"
            exit 1
          fi

      - name: ğŸ“¦ å…¨é¢äº§ç‰©æ”¶é›†ä¸è¯Šæ–­
        if: always()
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹å…¨é¢äº§ç‰©æ”¶é›†ä¸è¯Šæ–­..."
          mkdir -p ${{ env.ARTIFACTS_DIR }}
          
          # æ”¶é›†å›ºä»¶æ–‡ä»¶
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "ğŸ“¦ æ”¶é›†å›ºä»¶æ–‡ä»¶..."
            FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) 2>/dev/null | wc -l)
            find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) \
              -exec cp --parents {} ${{ env.ARTIFACTS_DIR }}/ \; 2>/dev/null || true
            echo "âœ… æ”¶é›†åˆ° $FIRMWARE_FILES ä¸ªå›ºä»¶æ–‡ä»¶"
          fi
          
          # æ”¶é›†ç¼–è¯‘æ—¥å¿—
          echo "ğŸ“‹ æ”¶é›†ç¼–è¯‘æ—¥å¿—..."
          cp -r ${{ env.BUILD_LOG_DIR }} ${{ env.ARTIFACTS_DIR }}/ 2>/dev/null || true
          cp -r ${{ env.TOOLCHAIN_LOG_DIR }} ${{ env.ARTIFACTS_DIR }}/ 2>/dev/null || true
          
          # æ”¶é›†é…ç½®ä¿¡æ¯
          cp .config ${{ env.ARTIFACTS_DIR }}/config 2>/dev/null || true
          
          # ç”Ÿæˆè¯¦ç»†æ„å»ºæŠ¥å‘Š
          echo "ğŸ“Š ç”Ÿæˆè¯¦ç»†æ„å»ºæŠ¥å‘Š..."
          {
            echo "=== è¯¦ç»†å›ºä»¶æ„å»ºæŠ¥å‘Š ==="
            echo "æ„å»ºæ—¶é—´: $(date)"
            echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
            echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
            echo ""
            echo "=== æºç ä¿¡æ¯ ==="
            echo "æºç åº“: ${{ env.SOURCE_PRESET }}"
            echo "è¯·æ±‚åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
            echo "å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
            echo "æ¨èåˆ†æ”¯: ${{ env.RECOMMENDED_BRANCH }}"
            echo ""
            echo "=== ç¼–è¯‘é…ç½® ==="
            echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
            echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
            echo "å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}"
            echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
            echo ""
            echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
            echo "Runner: ${{ runner.os }}"
            echo "CPUæ ¸å¿ƒ: $(nproc)"
            echo "å†…å­˜: $(free -h | awk '/^Mem:/{print $2}')"
            echo "ç£ç›˜ç©ºé—´: $(df -h /tmp | awk 'NR==2{print $4}') å¯ç”¨"
            echo ""
            echo "=== äº§ç‰©ä¿¡æ¯ ==="
            if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
              echo "å›ºä»¶æ–‡ä»¶:"
              find ${{ env.ARTIFACTS_DIR }} -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | \
                xargs -I {} basename {} | sort || echo "æ— å›ºä»¶æ–‡ä»¶"
            else
              echo "æ„å»ºå¤±è´¥ï¼Œæ— å›ºä»¶äº§ç‰©"
            fi
          } > ${{ env.ARTIFACTS_DIR }}/detailed-build-report.txt
          
          # å¤åˆ¶åˆ°å·¥ä½œåŒº
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp -r ${{ env.ARTIFACTS_DIR }}/* $GITHUB_WORKSPACE/artifacts/ 2>/dev/null || true
          echo "âœ… å…¨é¢äº§ç‰©æ”¶é›†å®Œæˆ"

      - name: ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}
          path: artifacts
          retention-days: 30

      - name: ğŸ§¹ ç¼–è¯‘åæ™ºèƒ½æ¸…ç†
        if: always()
        run: |
          echo "å¼€å§‹ç¼–è¯‘åæ™ºèƒ½æ¸…ç†..."
          
          # æ˜¾ç¤ºæ¸…ç†å‰çŠ¶æ€
          echo "=== æ¸…ç†å‰çŠ¶æ€ ==="
          df -h
          free -h
          
          # æ— è®ºç¼–è¯‘æˆåŠŸä¸å¦ï¼Œéƒ½æ¸…ç†è¿™äº›ä¸´æ—¶æ–‡ä»¶
          echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘ä¸´æ—¶æ–‡ä»¶..."
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            # ä¿ç•™æºç ä½†æ¸…ç†æ„å»ºç›®å½•
            cd ${{ env.SOURCE_DIR }}
            rm -rf build_dir/* staging_dir/* tmp/* 2>/dev/null || true
            # ä½†å¦‚æœæ˜¯ç¼–è¯‘å¤±è´¥ï¼Œæˆ‘ä»¬ä¿ç•™æ›´å¤šæ–‡ä»¶ç”¨äºè°ƒè¯•
            if [ "${{ env.BUILD_STATUS }}" != "success" ]; then
              echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œä¿ç•™æºç å’Œå…³é”®ç›®å½•ç”¨äºè°ƒè¯•"
              echo "ğŸ“ ä¿ç•™çš„ç›®å½•:"
              ls -la | head -10
            else
              echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ¸…ç†æ„å»ºç›®å½•"
            fi
          fi
          
          # æ¸…ç†ç¼“å­˜ç›®å½•
          echo "ğŸ§¹ æ¸…ç†ç¼“å­˜..."
          rm -rf ${{ env.CCACHE_DIR }}/* 2>/dev/null || true
          
          # æ¸…ç†æ—¥å¿—ç›®å½•ï¼ˆä½†ä¿ç•™æœ€æ–°çš„ï¼‰
          echo "ğŸ§¹ æ¸…ç†æ—¥å¿—..."
          rm -rf ${{ env.BUILD_LOG_DIR }}/* ${{ env.TOOLCHAIN_LOG_DIR }}/* 2>/dev/null || true
          
          # æ¸…ç†äº§ç‰©ç›®å½•
          echo "ğŸ§¹ æ¸…ç†äº§ç‰©ç›®å½•..."
          rm -rf ${{ env.ARTIFACTS_DIR }} 2>/dev/null || true
          
          # æ¸…ç†äº¤æ¢æ–‡ä»¶
          echo "ğŸ§¹ æ¸…ç†äº¤æ¢æ–‡ä»¶..."
          sudo swapoff /swapfile 2>/dev/null || true
          sudo rm -f /swapfile 2>/dev/null || true
          
          # ç³»ç»Ÿçº§æ¸…ç†
          echo "ğŸ§¹ ç³»ç»Ÿçº§æ¸…ç†..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          
          # æ˜¾ç¤ºæ¸…ç†åçŠ¶æ€
          echo ""
          echo "=== æ¸…ç†åçŠ¶æ€ ==="
          df -h
          free -h
          echo "âœ… æ™ºèƒ½æ¸…ç†å®Œæˆ"

      - name: ğŸ§¹ æœ€ç»ˆç¯å¢ƒæ¸…ç†
        if: always()
        run: |
          echo "å¼€å§‹æœ€ç»ˆç¯å¢ƒæ¸…ç†..."
          
          # è¿™ä¸ªæ­¥éª¤ç¡®ä¿æ— è®ºå‰é¢å‘ç”Ÿäº†ä»€ä¹ˆï¼Œéƒ½ä¼šæ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
          # é˜²æ­¢å ç”¨GitHub Actionsçš„ç£ç›˜ç©ºé—´
          
          echo "ğŸ§¹ æœ€ç»ˆæ¸…ç†æ‰€æœ‰ä¸´æ—¶ç›®å½•..."
          sudo rm -rf ${{ env.SOURCE_DIR }} 2>/dev/null || echo "æºç ç›®å½•å·²æ¸…ç†"
          sudo rm -rf ${{ env.ARTIFACTS_DIR }} 2>/dev/null || echo "äº§ç‰©ç›®å½•å·²æ¸…ç†"
          sudo rm -rf ${{ env.CCACHE_DIR }} 2>/dev/null || echo "ç¼“å­˜ç›®å½•å·²æ¸…ç†"
          sudo rm -rf ${{ env.BUILD_LOG_DIR }} 2>/dev/null || echo "æ„å»ºæ—¥å¿—å·²æ¸…ç†"
          sudo rm -rf ${{ env.TOOLCHAIN_LOG_DIR }} 2>/dev/null || echo "å·¥å…·é“¾æ—¥å¿—å·²æ¸…ç†"
          
          # å†æ¬¡ç¡®ä¿äº¤æ¢æ–‡ä»¶è¢«æ¸…ç†
          sudo swapoff /swapfile 2>/dev/null || true
          sudo rm -f /swapfile 2>/dev/null || true
          
          echo "ğŸ“Š æœ€ç»ˆç£ç›˜çŠ¶æ€:"
          df -h
          echo "âœ… æœ€ç»ˆç¯å¢ƒæ¸…ç†å®Œæˆ"

      - name: ğŸ“Š æœ€ç»ˆç»¼åˆæŠ¥å‘Š
        if: always()
        run: |
          echo "=== æœ€ç»ˆç»¼åˆæŠ¥å‘Š ==="
          echo "ğŸ¯ å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ†” è¿è¡ŒID: ${{ github.run_id }}"
          echo "ğŸ†” è¿è¡Œå·: ${{ github.run_number }}"
          echo ""
          echo "ğŸ“¦ æºç ä¿¡æ¯:"
          echo "  - é¢„è®¾: ${{ env.SOURCE_PRESET }}"
          echo "  - åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - æ¨è: ${{ env.RECOMMENDED_BRANCH }}"
          echo ""
          echo "âš™ï¸ ç¼–è¯‘é…ç½®:"
          echo "  - é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "  - å·¥å…·é“¾: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - è‡ªå®šä¹‰: ${{ github.event.inputs.enable_custom_features }}"
          echo ""
          echo "ğŸ“ˆ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
            echo "ğŸ“¦ ä¸‹è½½ Artifacts è·å–ç¼–è¯‘äº§ç‰©"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo "ğŸ” è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—åˆ†æé”™è¯¯åŸå› "
            echo "ğŸ“‹ æ£€æŸ¥ Artifacts ä¸­çš„ç¼–è¯‘æ—¥å¿—"
          fi
