name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“ (ImmortalWrtåŠŸèƒ½ä¸°å¯Œ/OpenWrtå®˜æ–¹çº¯å‡€/LEDEé›†æˆåº¦é«˜)'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨æŒ‡å®šåˆ†æ”¯å)'
        required: true
        default: 'auto'
        type: string
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ - æŸ¥çœ‹ firmware-config/configs-list.md è·å–å¯ç”¨æ–‡ä»¶åˆ—è¡¨'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      build_optimization:
        description: 'ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥'
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: 'balanced'
      toolchain_strategy:
        description: 'å·¥å…·é“¾ç­–ç•¥ (prebuilt=é¢„ç¼–è¯‘æœ€å¿«/local=æœ¬åœ°ç¼–è¯‘æœ€ç¨³/auto=è‡ªåŠ¨é€‰æ‹©)'
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: 'auto'
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½ (è‡ªå®šä¹‰è„šæœ¬å’Œé¢„ç¼–è¯‘IPKåŒ…)'
        required: false
        default: false
        type: boolean

env:
  TZ: "Asia/Shanghai"
  TERM: "linux"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»“åº“"
      uses: actions/checkout@v4

    - name: "ğŸ’¾ ç´§æ€¥ç£ç›˜ç©ºé—´æ¸…ç†"
      run: |
        echo "=== ç´§æ€¥ç£ç›˜ç©ºé—´æ¸…ç† ==="
        df -h
        
        echo "1. æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /var/cache/apt/*
        
        echo "2. æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
        sudo find /home/runner/actions-runner/cached/_diag/ -name "*.log" -delete 2>/dev/null || true
        sudo journalctl --vacuum-time=1h 2>/dev/null || true
        
        echo "3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        sudo rm -rf /tmp/* 2>/dev/null || true
        sudo rm -rf /var/tmp/* 2>/dev/null || true
        
        echo "4. æ¸…ç†ä¸å¿…è¦çš„è½¯ä»¶åŒ…..."
        sudo apt-get autoremove -y 2>/dev/null || true
        sudo apt-get remove -y --purge man-db manpages 2>/dev/null || true
        
        echo "5. æ¸…ç†Dockerç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
        sudo docker system prune -f 2>/dev/null || true
        
        echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
        df -h

    - name: "ğŸ” æ£€æŸ¥ç›®å½•ç»“æ„"
      run: |
        echo "=== å½“å‰ç›®å½•ç»“æ„ ==="
        pwd
        ls -la
        echo "=== firmware-config ç›®å½•å†…å®¹ ==="
        ls -la firmware-config/
        echo "=== æ£€æŸ¥ repositories.json ==="
        if [ -f "firmware-config/repositories.json" ]; then
          echo "âœ… repositories.json å­˜åœ¨"
          cat firmware-config/repositories.json
        else
          echo "âŒ repositories.json ä¸å­˜åœ¨"
          echo "è¯·åœ¨ firmware-config ç›®å½•ä¸‹åˆ›å»º repositories.json æ–‡ä»¶"
          exit 1
        fi

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        echo "æ­£åœ¨è§£ææºç é…ç½®..."
        
        if [ ! -f "firmware-config/repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ° repositories.json æ–‡ä»¶"
        
        PRESET="${{ github.event.inputs.source_preset }}"
        
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" firmware-config/repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
          echo "è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
        fi
        
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•ä»repositories.jsonè·å–æºç URLï¼Œè¯·æ£€æŸ¥$PRESETé…ç½®"
          cat firmware-config/repositories.json
          exit 1
        fi
        
        if [ -z "$BRANCH" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•è·å–æºç åˆ†æ”¯"
          exit 1
        fi
        
        echo "âœ… æºç åº“: $PRESET - $DESCRIPTION"
        echo "âœ… ä»“åº“URL: $SOURCE_URL"
        echo "âœ… ä½¿ç”¨åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    - name: "ğŸ§¹ å‡†å¤‡æ„å»ºç¯å¢ƒ"
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–åŒ…..."
        sudo apt-get update
        # åªå®‰è£…æœ€å¿…è¦çš„åŒ…
        sudo apt-get install -y --no-install-recommends \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          rsync unzip zlib1g-dev file wget jq
        
        echo "ğŸ”„ åˆ›å»ºäº¤æ¢æ–‡ä»¶è§£å†³å†…å­˜ä¸è¶³..."
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "âœ… 4GBäº¤æ¢æ–‡ä»¶å·²å¯ç”¨"
        
        echo "âœ… æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: "ğŸ“¥ è·å–æºä»£ç  - æç®€å…‹éš†"
      id: clone-source
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“: ${{ env.SOURCE_URL }}"
        echo "é¦–é€‰åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        
        # æç®€å…‹éš†ç­–ç•¥
        CLONE_SUCCESS=false
        
        # å°è¯•é¦–é€‰åˆ†æ”¯
        echo "ğŸ” å°è¯•ä½¿ç”¨é¦–é€‰åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        if git clone --depth 1 --filter=blob:none --branch "${{ env.SOURCE_BRANCH }}" "${{ env.SOURCE_URL }}" source 2>/dev/null; then
          echo "âœ… ä½¿ç”¨é¦–é€‰åˆ†æ”¯å…‹éš†æˆåŠŸ: ${{ env.SOURCE_BRANCH }}"
          CLONE_SUCCESS=true
          ACTUAL_BRANCH="${{ env.SOURCE_BRANCH }}"
        else
          echo "âš ï¸ é¦–é€‰åˆ†æ”¯ '${{ env.SOURCE_BRANCH }}' ä¸å­˜åœ¨ï¼Œå°è¯•å¤‡é€‰åˆ†æ”¯..."
          
          # æ ¹æ®é¦–é€‰åˆ†æ”¯å†³å®šå¤‡é€‰åˆ†æ”¯
          if [ "${{ env.SOURCE_BRANCH }}" = "main" ]; then
            ALTERNATIVE_BRANCH="master"
          elif [ "${{ env.SOURCE_BRANCH }}" = "master" ]; then
            ALTERNATIVE_BRANCH="main"
          else
            ALTERNATIVE_BRANCH="main"
          fi
          
          echo "ğŸ” å°è¯•å¤‡é€‰åˆ†æ”¯: $ALTERNATIVE_BRANCH"
          if git clone --depth 1 --filter=blob:none --branch "$ALTERNATIVE_BRANCH" "${{ env.SOURCE_URL }}" source 2>/dev/null; then
            echo "âœ… ä½¿ç”¨å¤‡é€‰åˆ†æ”¯å…‹éš†æˆåŠŸ: $ALTERNATIVE_BRANCH"
            CLONE_SUCCESS=true
            ACTUAL_BRANCH="$ALTERNATIVE_BRANCH"
          else
            # æœ€åå°è¯•ï¼šä¸æŒ‡å®šåˆ†æ”¯
            echo "ğŸ” å°è¯•æ— åˆ†æ”¯å…‹éš†..."
            if git clone --depth 1 --filter=blob:none "${{ env.SOURCE_URL }}" source 2>/dev/null; then
              echo "âœ… æ— åˆ†æ”¯å…‹éš†æˆåŠŸï¼Œå°†ä½¿ç”¨é»˜è®¤åˆ†æ”¯"
              CLONE_SUCCESS=true
              cd source
              ACTUAL_BRANCH=$(git branch --show-current)
              cd ..
            fi
          fi
        fi
        
        if [ "$CLONE_SUCCESS" = "false" ]; then
          echo "âŒ æ‰€æœ‰å…‹éš†å°è¯•éƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“URLå’Œåˆ†æ”¯åç§°"
          exit 1
        fi
        
        echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
        echo "âœ… æºç å…‹éš†å®Œæˆï¼Œå®é™…ä½¿ç”¨åˆ†æ”¯: $ACTUAL_BRANCH"

    - name: "ğŸ’¾ å…‹éš†åç£ç›˜æ£€æŸ¥"
      run: |
        echo "=== æºç å…‹éš†åç£ç›˜ç©ºé—´ ==="
        df -h
        echo "=== æºç ç›®å½•å¤§å° ==="
        du -sh source/ || echo "æ— æ³•è·å–æºç ç›®å½•å¤§å°"

    - name: "ğŸ”§ æºç åˆå§‹åŒ– - ç²¾ç®€ç‰ˆ"
      timeout-minutes: 20
      run: |
        cd source
        echo "åˆå§‹åŒ–æºç æ ‘ï¼ˆç²¾ç®€æ¨¡å¼ï¼‰..."
        
        echo "æ­¥éª¤1: ä»…æ›´æ–°å¿…è¦çš„feeds..."
        ./scripts/feeds update packages
        ./scripts/feeds update luci
        
        echo "æ­¥éª¤2: å®‰è£…åŸºç¡€feeds..."
        ./scripts/feeds install -a
        
        echo "âœ… Feedsæ›´æ–°å®Œæˆ"

    - name: "ğŸ¨ åº”ç”¨è‡ªå®šä¹‰é…ç½®"
      run: |
        cd source
        CONFIG_FILE="../firmware-config/${{ github.event.inputs.config_profile }}"
        echo "æ­£åœ¨åº”ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          ls -la ../firmware-config/configs/ || echo "configsç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ"

    - name: "ğŸ”§ ä¿®å¤é…ç½®ç¯å¢ƒ"
      run: |
        cd source
        echo "ä¿®å¤æ— å¤´ç¯å¢ƒé…ç½®é—®é¢˜..."
        
        sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_BUILD_LOG=y/# CONFIG_BUILD_LOG is not set/' .config 2>/dev/null || true
        
        echo "åº”ç”¨éäº¤äº’å¼é…ç½®..."
        yes "" | make oldconfig >/dev/null 2>&1 || true
        
        echo "âœ… é…ç½®ç¯å¢ƒä¿®å¤å®Œæˆ"

    - name: "ğŸ› ï¸ è®¾ç½®å·¥å…·é“¾ç­–ç•¥"
      id: toolchain-setup
      run: |
        cd source
        
        STRATEGY="${{ github.event.inputs.toolchain_strategy }}"
        echo "å·¥å…·é“¾ç­–ç•¥: $STRATEGY"
        
        case $STRATEGY in
          "prebuilt")
            echo "ğŸ”§ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾..."
            if make tools/install toolchain/install -j1; then
              echo "âœ… é¢„ç¼–è¯‘å·¥å…·é“¾å®‰è£…æˆåŠŸ"
              echo "result=prebuilt" >> $GITHUB_OUTPUT
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ é¢„ç¼–è¯‘å·¥å…·é“¾å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°ç¼–è¯‘"
              echo "result=local" >> $GITHUB_OUTPUT
              echo "status=fallback" >> $GITHUB_OUTPUT
            fi
            ;;
          "local")
            echo "ğŸ”§ ä½¿ç”¨æœ¬åœ°ç¼–è¯‘å·¥å…·é“¾..."
            echo "result=local" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            ;;
          "auto"|*)
            echo "ğŸ”§ è‡ªåŠ¨é€‰æ‹©å·¥å…·é“¾ç­–ç•¥..."
            if make tools/install toolchain/install -j1; then
              echo "âœ… é¢„ç¼–è¯‘å·¥å…·é“¾å¯ç”¨"
              echo "result=prebuilt" >> $GITHUB_OUTPUT
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ é¢„ç¼–è¯‘å·¥å…·é“¾ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°ç¼–è¯‘"
              echo "result=local" >> $GITHUB_OUTPUT
              echo "status=fallback" >> $GITHUB_OUTPUT
            fi
            ;;
        esac

    - name: "ğŸ“¦ å¤„ç†é¢„ç¼–è¯‘IPKåŒ…"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        IPK_DIR="../firmware-config/custom-features/prebuilt-ipks"
        
        if [ ! -d "$IPK_DIR" ]; then
          echo "â„¹ï¸ é¢„ç¼–è¯‘IPKåŒ…ç›®å½•ä¸å­˜åœ¨: $IPK_DIR"
          exit 0
        fi
        
        echo "ğŸ” æŸ¥æ‰¾é¢„ç¼–è¯‘IPKåŒ…..."
        IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f)
        
        if [ -z "$IPK_FILES" ]; then
          echo "â„¹ï¸ æœªæ‰¾åˆ°é¢„ç¼–è¯‘IPKåŒ…"
          exit 0
        fi
        
        echo "æ‰¾åˆ°ä»¥ä¸‹IPKåŒ…:"
        echo "$IPK_FILES"
        
        mkdir -p package/base-files/files/usr/lib/opkg/custom
        
        for ipk in $IPK_FILES; do
          echo "ğŸ“¥ å¤åˆ¶IPKåŒ…: $(basename "$ipk")"
          cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
        done
        
        echo "âœ… é¢„ç¼–è¯‘IPKåŒ…å¤„ç†å®Œæˆ"

    - name: "ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        SCRIPTS_DIR="../firmware-config/custom-features/scripts"
        
        if [ ! -d "$SCRIPTS_DIR" ]; then
          echo "â„¹ï¸ è‡ªå®šä¹‰è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $SCRIPTS_DIR"
          exit 0
        fi
        
        SCRIPTS=$(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort)
        
        if [ -z "$SCRIPTS" ]; then
          echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½•è„šæœ¬æ–‡ä»¶"
          exit 0
        fi
        
        for script in $SCRIPTS; do
          echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
          chmod +x "$script"
          if bash "$script"; then
            echo "âœ… $(basename "$script") æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ $(basename "$script") æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
        done
        
        echo "âœ… æ‰€æœ‰è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

    - name: "ğŸ” éªŒè¯é…ç½®"
      run: |
        cd source
        echo "éªŒè¯é…ç½®æ–‡ä»¶..."
        make defconfig >/dev/null 2>&1 || echo "é…ç½®éªŒè¯å®Œæˆï¼ˆéäº¤äº’å¼ï¼‰"
        echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

    - name: "ğŸ’¾ ç¼–è¯‘å‰ç´§æ€¥ç©ºé—´æ£€æŸ¥"
      run: |
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ç´§æ€¥æ£€æŸ¥ ==="
        df -h
        
        # å¦‚æœç©ºé—´ä»ç„¶ä¸è¶³ï¼Œæ‰§è¡Œé¢å¤–æ¸…ç†
        AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
        if [ "$AVAILABLE_SPACE" -lt 8000000 ]; then  # å¦‚æœå°äº8GB
          echo "âš ï¸ ç£ç›˜ç©ºé—´ä»ç„¶ç´§å¼ ï¼Œæ‰§è¡Œé¢å¤–æ¸…ç†..."
          cd source
          # æ¸…ç†ä¸€äº›ç¼–è¯‘ç¼“å­˜
          rm -rf tmp/ 2>/dev/null || true
          rm -rf logs/ 2>/dev/null || true
          cd ..
          sudo rm -rf /var/log/*.gz 2>/dev/null || true
          sudo rm -rf /var/log/*.old 2>/dev/null || true
          echo "âœ… é¢å¤–æ¸…ç†å®Œæˆ"
          df -h
        fi

    - name: "ğŸ—ï¸ ç¼–è¯‘å›ºä»¶ - è¶…ä¿å®ˆæ¨¡å¼"
      timeout-minutes: 240
      run: |
        cd source
        export TERM=linux
        export FORCE_UNSAFE_CONFIGURE=1
        
        # è¶…ä¿å®ˆå†…å­˜è®¾ç½®
        export MAKE_TERMOUT=
        export MAKE_TERMERR=
        export NUM_CPU=1  # å¼ºåˆ¶å•çº¿ç¨‹
        
        START_TIME=$(date +%s)
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶ (è¶…ä¿å®ˆæ¨¡å¼)..."
        echo "ğŸ“Š ç¼–è¯‘å‚æ•°:"
        echo "  - å·¥å…·é“¾ç­–ç•¥: ${{ steps.toolchain-setup.outputs.result }}"
        echo "  - ç¼–è¯‘ä¼˜åŒ–: ${{ github.event.inputs.build_optimization }}"
        echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
        echo "  - å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
        
        # æ— è®ºç”¨æˆ·é€‰æ‹©ä»€ä¹ˆä¼˜åŒ–ç­–ç•¥ï¼Œéƒ½ä½¿ç”¨å•çº¿ç¨‹
        echo "ğŸ›¡ï¸ è¶…ä¿å®ˆæ¨¡å¼: å•çº¿ç¨‹ç¼–è¯‘ (é¿å…ç£ç›˜ç©ºé—´ä¸è¶³)"
        if make -j1 V=s; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ!"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          # å°è¯•æ›´ä¿å®ˆçš„æ–¹å¼
          echo "ğŸ”„ å°è¯•æ— å¹¶è¡Œç¼–è¯‘..."
          make V=s
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "âœ… ç¼–è¯‘å®Œæˆ! è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV

    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      if: success()
      run: |
        cd source
        echo "æ”¶é›†ç¼–è¯‘è¾“å‡ºæ–‡ä»¶..."
        
        mkdir -p ../artifacts
        
        # ä¼˜å…ˆæŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) 2>/dev/null | head -10)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          for file in $FIRMWARE_FILES; do
            echo "ğŸ“¦ å¤åˆ¶: $(basename "$file")"
            mkdir -p "../artifacts/$(dirname "$file")"
            cp "$file" "../artifacts/$file"
          done
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶ï¼Œæ”¶é›†æ‰€æœ‰binç›®å½•æ–‡ä»¶..."
          find bin/ -type f -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" | head -20
        fi
        
        {
          echo "=== å›ºä»¶æ„å»ºä¿¡æ¯ ==="
          echo "æºç : ${{ env.SOURCE_URL }}"
          echo "è¯·æ±‚åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
          echo "å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
          echo "ä¼˜åŒ–: ${{ github.event.inputs.build_optimization }}"
          echo "å·¥å…·é“¾: ${{ steps.toolchain-setup.outputs.result }}"
          echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo "æ„å»ºæ—¶é—´: $(date)"
          echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’"
          echo "GitHub Run: ${{ github.run_id }}-${{ github.run_attempt }}"
          echo "ç¼–è¯‘æ¨¡å¼: è¶…ä¿å®ˆå•çº¿ç¨‹ (ç£ç›˜ç©ºé—´ä¼˜åŒ–)"
          echo ""
          echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
          find bin/targets -type f 2>/dev/null | sort || echo "æ— æ³•åˆ—å‡ºæ–‡ä»¶"
        } > ../artifacts/build-info.txt

    - name: "ğŸ§¹ æœ€ç»ˆæ¸…ç†é‡Šæ”¾ç©ºé—´"
      if: always()
      run: |
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´æ¸…ç† ==="
        
        # åˆ é™¤æºç ç›®å½•ï¼ˆä¿ç•™artifactsï¼‰
        if [ -d "source" ]; then
          echo "åˆ é™¤æºç ç›®å½•ä»¥é‡Šæ”¾ç©ºé—´..."
          rm -rf source/
        fi
        
        # åˆ é™¤äº¤æ¢æ–‡ä»¶
        echo "åˆ é™¤äº¤æ¢æ–‡ä»¶..."
        sudo swapoff /swapfile 2>/dev/null || true
        sudo rm -f /swapfile 2>/dev/null || true
        
        # æœ€ç»ˆç³»ç»Ÿæ¸…ç†
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
        df -h

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}-${{ github.run_attempt }}"
        path: artifacts
        retention-days: 7  # ç¼©çŸ­ä¿ç•™æ—¶é—´

    - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æºç : ${{ env.SOURCE_URL }}"
        echo "è¯·æ±‚åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        echo "å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ! å›ºä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "â±ï¸ ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’"
          echo "ğŸŒ¿ å®é™…ä½¿ç”¨åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´ç®¡ç†: è¶…ä¿å®ˆæ¨¡å¼å¯ç”¨"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          echo ""
          echo "ğŸ’¡ è°ƒè¯•å»ºè®®:"
          echo "  - ç£ç›˜ç©ºé—´ä¸è¶³æ˜¯ä¸»è¦é—®é¢˜"
          echo "  - å°è¯•ä½¿ç”¨æ›´ç²¾ç®€çš„é…ç½®æ–‡ä»¶"
          echo "  - ç¦ç”¨è‡ªå®šä¹‰åŠŸèƒ½ä»¥å‡å°‘ç©ºé—´å ç”¨"
          echo "  - è€ƒè™‘ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾"
          echo "  - æ£€æŸ¥åˆ†æ”¯åç§°æ˜¯å¦æ­£ç¡®"
        fi
        echo ""
        echo "=== æœ€ç»ˆç£ç›˜çŠ¶æ€ ==="
        df -h
