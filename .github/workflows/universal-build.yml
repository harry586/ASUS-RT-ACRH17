name: Universal Firmware Builder - Enhanced File Discovery & Multi-Device Support

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: é€‰æ‹©æºç åº“
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: immortalwrt
      source_branch:
        description: æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æŒ‡å®š main/master/å…·ä½“åˆ†æ”¯å)
        required: true
        default: auto
        type: string
      config_profile:
        description: è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ (æ”¯æŒé€šé…ç¬¦å¦‚ .config_* æˆ–å…·ä½“æ–‡ä»¶å)
        required: true
        type: string
        default: .config_rt-ac42u_immortalwrt
      build_optimization:
        description: ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: balanced
      toolchain_strategy:
        description: å·¥å…·é“¾ç­–ç•¥
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: auto
      enable_custom_features:
        description: å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  SOURCE_DIR: /mnt/source
  ARTIFACTS_DIR: /mnt/artifacts
  CCACHE_DIR: /mnt/ccache
  BUILD_LOG_DIR: /mnt/build-logs
  TOOLCHAIN_LOG_DIR: /mnt/toolchain-logs

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: .
          fetch-depth: 0

      - name: ğŸ’¾ æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æ
        timeout-minutes: 2
        run: |
          echo "=== æ™ºèƒ½ç³»ç»Ÿèµ„æºåˆ†æ ==="
          echo "ğŸ“Š ç£ç›˜ç©ºé—´:"
          df -h
          echo ""
          echo "ğŸ’» CPU ä¿¡æ¯:"
          echo "æ ¸å¿ƒæ•°: $(nproc)"
          echo "æ¶æ„: $(uname -m)"
          echo "CPU å‹å·: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
          echo ""
          echo "ğŸ§  å†…å­˜ä¿¡æ¯:"
          free -h
          echo ""
          echo "ğŸ”„ äº¤æ¢ç©ºé—´: $(swapon --show | wc -l 2>/dev/null || echo 0) ä¸ªäº¤æ¢æ–‡ä»¶"
          echo ""
          echo "âœ… èµ„æºåˆ†æå®Œæˆ - ç³»ç»Ÿå°±ç»ª"

      - name: ğŸ”§ å…¨é¢å·¥ä½œç¯å¢ƒè®¾ç½®
        run: |
          echo "è®¾ç½®å…¨é¢ç¼–è¯‘ç¯å¢ƒ..."
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          sudo chmod -R 777 ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          
          echo "ğŸ”„ åœ¨ /mnt åˆ›å»ºé«˜æ€§èƒ½äº¤æ¢æ–‡ä»¶..."
          if [ -f /mnt/swapfile ]; then
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
            sleep 2
          fi
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=8192 status=progress || sudo fallocate -l 8G /mnt/swapfile || sudo truncate -s 8G /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          echo "ğŸ“Š äº¤æ¢ç©ºé—´çŠ¶æ€:"
          sudo swapon --show
          free -h
          
          echo "âš¡ ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½è®¾ç½®..."
          ulimit -n 65536
          sudo sysctl -w vm.swappiness=60 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®swappiness"
          sudo sysctl -w vm.vfs_cache_pressure=50 2>/dev/null || echo "âš ï¸ æ— æ³•è®¾ç½®vfs_cache_pressure"
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          echo "ğŸ“Š è®¾ç½®åç£ç›˜ç©ºé—´çŠ¶æ€:"
          df -h

      - name: ğŸ” æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸é…ç½®åˆ†æ
        id: file-discovery
        run: |
          echo "=== æ™ºèƒ½æ–‡ä»¶å‘ç°ä¸é…ç½®åˆ†æ ==="
          echo "ğŸ” å…¨é¢åˆ†æä»“åº“ç»“æ„..."
          set +o pipefail
          
          echo "ğŸ“‹ æŸ¥æ‰¾ repositories.json æ–‡ä»¶..."
          REPO_JSON_FOUND=$(find . -maxdepth 3 -name "repositories.json" -type f 2>/dev/null | head -1)
          if [ -n "$REPO_JSON_FOUND" ]; then
            echo "âœ… æ‰¾åˆ° repositories.json: $REPO_JSON_FOUND"
            echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
            echo "ğŸ“Š repositories.json å†…å®¹åˆ†æ:"
            jq -r '.repositories | keys[] as $k | "  - \($k): \(.[$k].description // "æ— æè¿°")"' "$REPO_JSON_FOUND" 2>/dev/null || echo "æ— æ³•è§£æJSONå†…å®¹"
          else
            echo "âŒ æœªæ‰¾åˆ° repositories.json æ–‡ä»¶"
            exit 1
          fi
          
          echo "ğŸ“‹ æ™ºèƒ½æŸ¥æ‰¾æ‰€æœ‰é…ç½®æ–‡ä»¶..."
          CONFIG_PATTERNS=(".config_*" "config_*" "*.config")
          ALL_CONFIG_FILES=""
          for pattern in "${CONFIG_PATTERNS[@]}"; do
            echo "æœç´¢æ¨¡å¼: $pattern"
            found_files=$(find . -maxdepth 3 -name "$pattern" -type f 2>/dev/null | head -10)
            if [ -n "$found_files" ]; then
              ALL_CONFIG_FILES="$ALL_CONFIG_FILES"$'\n'"$found_files"
              echo "æ‰¾åˆ°æ–‡ä»¶:"
              echo "$found_files"
            fi
          done
          
          if [ -n "$ALL_CONFIG_FILES" ]; then
            CONFIG_COUNT=$(echo "$ALL_CONFIG_FILES" | grep -v '^$' | wc -l)
            echo "âœ… æ€»å…±æ‰¾åˆ° $CONFIG_COUNT ä¸ªé…ç½®æ–‡ä»¶"
            echo "CONFIG_FILES_FOUND=true" >> $GITHUB_ENV
            echo "$ALL_CONFIG_FILES" > ${{ env.BUILD_LOG_DIR }}/all_config_files.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
            echo "CONFIG_FILES_FOUND=false" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“‹ æ™ºèƒ½æŸ¥æ‰¾è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•..."
          CUSTOM_DIR_PATTERNS=("custom-features" "custom" "features" "firmware-config")
          CUSTOM_FEATURES_DIR=""
          for pattern in "${CUSTOM_DIR_PATTERNS[@]}"; do
            echo "æœç´¢ç›®å½•: $pattern"
            found_dir=$(find . -maxdepth 2 -type d -name "$pattern" 2>/dev/null | head -1)
            if [ -n "$found_dir" ]; then
              # å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
              if [[ "$found_dir" == ./* ]]; then
                CUSTOM_FEATURES_DIR="$GITHUB_WORKSPACE/${found_dir#./}"
              else
                CUSTOM_FEATURES_DIR="$GITHUB_WORKSPACE/$found_dir"
              fi
              echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•: $found_dir (ç»å¯¹è·¯å¾„: $CUSTOM_FEATURES_DIR)"
              break
            fi
          done
          
          if [ -n "$CUSTOM_FEATURES_DIR" ]; then
            echo "CUSTOM_FEATURES_DIR=$CUSTOM_FEATURES_DIR" >> $GITHUB_ENV
            
            echo "ğŸ” è‡ªå®šä¹‰ç›®å½•è¯¦ç»†åˆ†æ:"
            echo "ğŸ“ ç›®å½•ç»“æ„:"
            find "$CUSTOM_FEATURES_DIR" -type f 2>/dev/null | head -20
            
            echo "ğŸ“¦ IPKæ–‡ä»¶æ£€æŸ¥:"
            IPK_FILES=$(find "$CUSTOM_FEATURES_DIR" -name "*.ipk" -type f 2>/dev/null)
            IPK_COUNT=$(echo "$IPK_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
            if [ "$IPK_COUNT" -gt 0 ]; then
              echo "âœ… æ‰¾åˆ° $IPK_COUNT ä¸ªIPKæ–‡ä»¶:"
              echo "$IPK_FILES" | head -10
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°IPKæ–‡ä»¶"
            fi
            
            echo "ğŸ“œ è„šæœ¬æ–‡ä»¶æ£€æŸ¥:"
            SCRIPT_FILES=$(find "$CUSTOM_FEATURES_DIR" -name "*.sh" -type f 2>/dev/null)
            SCRIPT_COUNT=$(echo "$SCRIPT_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
            if [ "$SCRIPT_COUNT" -gt 0 ]; then
              echo "âœ… æ‰¾åˆ° $SCRIPT_COUNT ä¸ªè„šæœ¬æ–‡ä»¶:"
              echo "$SCRIPT_FILES" | head -10
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è„šæœ¬æ–‡ä»¶"
            fi
            
            echo "ğŸ”§ è¡¥ä¸æ–‡ä»¶æ£€æŸ¥:"
            PATCH_FILES=$(find "$CUSTOM_FEATURES_DIR" -name "*.patch" -type f 2>/dev/null)
            PATCH_COUNT=$(echo "$PATCH_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
            if [ "$PATCH_COUNT" -gt 0 ]; then
              echo "âœ… æ‰¾åˆ° $PATCH_COUNT ä¸ªè¡¥ä¸æ–‡ä»¶:"
              echo "$PATCH_FILES" | head -10
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è¡¥ä¸æ–‡ä»¶"
            fi
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•"
            echo "CUSTOM_FEATURES_DIR=" >> $GITHUB_ENV
          fi
          
          echo ""
          echo "ğŸ“ å®Œæ•´ç›®å½•ç»“æ„åˆ†æ:"
          echo "é¡¶å±‚ç›®å½•:"
          ls -la
          echo ""
          echo "å…³é”®æ–‡ä»¶ç±»å‹ç»Ÿè®¡:"
          echo "  - é…ç½®æ–‡ä»¶: $(find . -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | wc -l)"
          echo "  - è„šæœ¬æ–‡ä»¶: $(find . -maxdepth 3 -name "*.sh" 2>/dev/null | wc -l)"
          echo "  - Makefile: $(find . -maxdepth 3 -name "Makefile" -o -name "*.mk" 2>/dev/null | wc -l)"
          
          set -o pipefail
          echo "âœ… æ™ºèƒ½æ–‡ä»¶å‘ç°å®Œæˆ"

      - name: ğŸ”§ æ™ºèƒ½æºç é…ç½®è§£æ
        id: source-config
        run: |
          echo "æ­£åœ¨æ™ºèƒ½è§£ææºç é…ç½®..."
          PRESET="${{ github.event.inputs.source_preset }}"
          echo "ä½¿ç”¨çš„é¢„è®¾: $PRESET"
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯: é¢„è®¾ '$PRESET' ä¸å­˜åœ¨"
            echo "å¯ç”¨çš„é¢„è®¾:"
            jq -r '.repositories | keys[]' "$REPO_JSON_PATH"
            exit 1
          fi
          
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"æœªçŸ¥\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          echo "âœ… æˆåŠŸè·å–é…ç½®ä¿¡æ¯"
          
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "ğŸ¤– è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
          else
            echo "ğŸ“‹ ä½¿ç”¨æŒ‡å®šåˆ†æ”¯: $BRANCH"
          fi
          
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "RECOMMENDED_BRANCH=$RECOMMENDED_BRANCH" >> $GITHUB_ENV
          
          echo ""
          echo "âœ… æºç é…ç½®è§£æå®Œæˆ"
          echo "ğŸ“Š é…ç½®è¯¦æƒ…:"
          echo "  - é¢„è®¾: $PRESET"
          echo "  - æè¿°: $DESCRIPTION"
          echo "  - ä»“åº“: $SOURCE_URL"
          echo "  - åˆ†æ”¯: $BRANCH"
          echo "  - æ¨èåˆ†æ”¯: $RECOMMENDED_BRANCH"

      - name: ğŸ› ï¸ å…¨é¢ç¼–è¯‘ä¾èµ–å®‰è£…ä¸éªŒè¯
        run: |
          echo "å®‰è£…å…¨é¢ç¼–è¯‘ä¾èµ–åŒ…..."
          sudo apt-get update
          echo "ğŸ“¦ å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          echo "ğŸ“¦ å®‰è£…å¼€å‘åº“..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools
          echo "ğŸ“¦ å®‰è£…å·¥å…·é“¾ä¾èµ–..."
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache m4 help2man texinfo texi2html
          echo "ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·..."
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion mercurial curl cmake ninja-build
          echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿåº“..."
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libc6-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "ğŸ” ä¾èµ–å®‰è£…éªŒè¯..."
          echo "=== å…³é”®å·¥å…·éªŒè¯ ==="
          for tool in gcc g++ make flex bison git curl wget; do
            if command -v $tool >/dev/null 2>&1; then
              version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-4 | tr -d '\n' || echo "å¯ç”¨")
              echo "âœ… $tool: $version"
            else
              echo "âŒ $tool: æœªå®‰è£…"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å’ŒéªŒè¯å®Œæˆ"

      - name: âš¡ é«˜çº§ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–
        run: |
          echo "è®¾ç½®é«˜çº§ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–..."
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M 16G
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=200000
          ccache -o sloppiness=file_macro,include_file_mtime,include_file_ctime,time_macros
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=16G" >> $GITHUB_ENV
          echo "CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros" >> $GITHUB_ENV
          echo "ğŸ“Š åˆå§‹CCacheç»Ÿè®¡:"
          ccache -s
          echo "âœ… ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–å®Œæˆ"

      - name: ğŸ“¥ æ™ºèƒ½æºç è·å–ä¸åˆ†æ”¯å¤„ç†
        id: clone-source
        run: |
          echo "å¼€å§‹æ™ºèƒ½æºç è·å–ä¸åˆ†æ”¯å¤„ç†..."
          cd ${{ env.SOURCE_DIR }}
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          SOURCE_URL="${{ env.SOURCE_URL }}"
          echo "ğŸ¯ è¯·æ±‚åˆ†æ”¯: $REQUESTED_BRANCH"
          echo "ğŸ¯ æºç ä»“åº“: $SOURCE_URL"
          
          CLONE_STRATEGIES=()
          if [ "$REQUESTED_BRANCH" != "auto" ] && [ "$REQUESTED_BRANCH" != "main" ] && [ "$REQUESTED_BRANCH" != "master" ]; then
            CLONE_STRATEGIES+=("æŒ‡å®šåˆ†æ”¯: git clone --depth 1 --branch $REQUESTED_BRANCH $SOURCE_URL .")
          fi
          CLONE_STRATEGIES+=("mainåˆ†æ”¯: git clone --depth 1 --branch main $SOURCE_URL ." "masteråˆ†æ”¯: git clone --depth 1 --branch master $SOURCE_URL ." "é»˜è®¤åˆ†æ”¯: git clone --depth 1 $SOURCE_URL .")
          
          if [ "$REQUESTED_BRANCH" = "auto" ]; then
            RECOMMENDED_BRANCH="${{ env.RECOMMENDED_BRANCH }}"
            if [ -n "$RECOMMENDED_BRANCH" ] && [ "$RECOMMENDED_BRANCH" != "null" ]; then
              CLONE_STRATEGIES=("æ¨èåˆ†æ”¯: git clone --depth 1 --branch $RECOMMENDED_BRANCH $SOURCE_URL ." "${CLONE_STRATEGIES[@]}")
            fi
          fi
          
          CLONE_SUCCESS=false
          CLONE_ERROR=""
          ACTUAL_BRANCH=""
          
          for strategy in "${CLONE_STRATEGIES[@]}"; do
            strategy_name=$(echo "$strategy" | cut -d: -f1)
            clone_cmd=$(echo "$strategy" | cut -d: -f2-)
            echo ""
            echo "ğŸ”„ å°è¯•ç­–ç•¥: $strategy_name"
            echo "å‘½ä»¤: $clone_cmd"
            rm -rf .[!.]* * 2>/dev/null || true
            
            if eval $clone_cmd 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone.log; then
              if [ -d ".git" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                echo "âœ… å…‹éš†æˆåŠŸ: $strategy_name"
                echo "ğŸ“‹ å®é™…åˆ†æ”¯: $ACTUAL_BRANCH"
                echo "ğŸ”— æäº¤å“ˆå¸Œ: $COMMIT_HASH"
                CLONE_SUCCESS=true
                break
              else
                CLONE_ERROR="Gitç›®å½•æœªåˆ›å»º"
                echo "âš ï¸ Gitç›®å½•æœªåˆ›å»ºï¼Œç»§ç»­å°è¯•å…¶ä»–ç­–ç•¥..."
              fi
            else
              CLONE_ERROR="å…‹éš†å‘½ä»¤æ‰§è¡Œå¤±è´¥"
              echo "âŒ ç­–ç•¥å¤±è´¥: $strategy_name"
              if [ -f "${{ env.BUILD_LOG_DIR }}/clone.log" ]; then
                echo "å…‹éš†é”™è¯¯è¯¦æƒ…:"
                tail -20 ${{ env.BUILD_LOG_DIR }}/clone.log
              fi
            fi
          done
          
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "âŒ æ‰€æœ‰å…‹éš†ç­–ç•¥éƒ½å¤±è´¥"
            echo "ğŸ” æœ€åå°è¯•çš„å…‹éš†æ—¥å¿—:"
            cat ${{ env.BUILD_LOG_DIR }}/clone.log 2>/dev/null || echo "æ— å…‹éš†æ—¥å¿—"
            echo "é”™è¯¯: $CLONE_ERROR"
            exit 1
          fi
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          
          echo ""
          echo "ğŸ” æºç ä»“åº“æ·±åº¦éªŒè¯..."
          echo "ğŸ“ æºç ç›®å½•ç»“æ„:"
          ls -la | head -10
          echo ""
          echo "âœ… æºç è·å–ä¸éªŒè¯å®Œæˆ"

      - name: ğŸ’¾ æºç è·å–åç©ºé—´ç›‘æµ‹
        run: |
          echo "=== æºç è·å–åç©ºé—´ç›‘æµ‹ ==="
          echo "ğŸ“Š å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${ROOT_AVAILABLE}GB"
          echo "/mnt åˆ†åŒºå¯ç”¨ç©ºé—´: ${MNT_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 2 ]; then
            echo "ğŸš¨ ä¸¥é‡è­¦å‘Š: æ ¹åˆ†åŒºç©ºé—´ä¸è¶³2GBï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§"
          fi
          if [ "$MNT_AVAILABLE" -lt 10 ]; then
            echo "ğŸš¨ ä¸¥é‡é”™è¯¯: /mnt åˆ†åŒºç©ºé—´ä¸è¶³10GBï¼Œæ— æ³•ç¼–è¯‘"
            exit 1
          elif [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "âš ï¸ è­¦å‘Š: /mnt åˆ†åŒºç©ºé—´ç´§å¼  (${MNT_AVAILABLE}GB)"
          else
            echo "âœ… /mnt åˆ†åŒºç©ºé—´å……è¶³"
          fi

      - name: ğŸ”„ æ™ºèƒ½æºç åˆå§‹åŒ–
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹æ™ºèƒ½æºç åˆå§‹åŒ–..."
          START_TIME=$(date +%s)
          
          echo "ğŸ”§ Feedsé…ç½®æ£€æµ‹..."
          FEEDS_CONF_FOUND=""
          for feeds_file in feeds.conf feeds.conf.default .feeds.conf .feeds.conf.default; do
            if [ -f "$feeds_file" ]; then
              FEEDS_CONF_FOUND="$feeds_file"
              echo "ğŸ“‹ ä½¿ç”¨ç°æœ‰ $feeds_file"
              if [ "$feeds_file" != "feeds.conf" ]; then
                cp "$feeds_file" feeds.conf
              fi
              break
            fi
          done
          
          if [ -z "$FEEDS_CONF_FOUND" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°feedsé…ç½®ï¼Œåˆ›å»ºé€šç”¨é…ç½®"
            echo "src-git packages https://git.openwrt.org/feed/packages.git" > feeds.conf
            echo "src-git luci https://git.openwrt.org/feed/luci.git" >> feeds.conf
            echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
            echo "src-git telephony https://git.openwrt.org/feed/telephony.git" >> feeds.conf
          fi
          
          echo "ğŸ”„ æ›´æ–°Feeds..."
          for i in 1 2 3; do
            echo "å°è¯• $i/3"
            if ./scripts/feeds update -a; then
              echo "âœ… Feedsæ›´æ–°æˆåŠŸ"
              break
            else
              echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
              if [ $i -eq 3 ]; then
                echo "âŒ Feedsæ›´æ–°å½»åº•å¤±è´¥"
                exit 1
              fi
              sleep 5
            fi
          done
          
          echo "ğŸ“¦ å®‰è£…åŸºç¡€Feeds..."
          for feed in packages luci routing telephony; do
            if ./scripts/feeds install -a -p $feed; then
              echo "âœ… $feed å®‰è£…æˆåŠŸ"
            else
              echo "âš ï¸ $feed å®‰è£…å¤±è´¥"
            fi
          done
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Feedsåˆå§‹åŒ–è€—æ—¶: ${DURATION}ç§’"
          echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ¯ å¿«é€Ÿé…ç½®æ–‡ä»¶æŸ¥æ‰¾ä¸åº”ç”¨
        timeout-minutes: 1
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¿«é€Ÿé…ç½®æ–‡ä»¶æŸ¥æ‰¾ä¸åº”ç”¨..."
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "è¾“å…¥é…ç½®æ¨¡å¼: $CONFIG_PROFILE"
          
          echo "ğŸ” å¿«é€Ÿé…ç½®æ–‡ä»¶æœç´¢..."
          
          # ä½¿ç”¨ä¸"æ™ºèƒ½æ–‡ä»¶å‘ç°"ç›¸åŒçš„å¿«é€Ÿæœç´¢ç­–ç•¥
          CONFIG_FOUND=""
          
          # æ–¹æ³•1: ç›´æ¥è·¯å¾„æŸ¥æ‰¾ï¼ˆæœ€å¿«ï¼‰- åœ¨æºç ç›®å½•å’Œé…ç½®ä»“åº“ç›®å½•éƒ½æŸ¥æ‰¾
          echo "ğŸ¯ ç›´æ¥è·¯å¾„æŸ¥æ‰¾..."
          if [ -f "$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="$CONFIG_PROFILE"
            echo "âœ… åœ¨å½“å‰ç›®å½•æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
          elif [ -f "../$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="../$CONFIG_PROFILE"
            echo "âœ… åœ¨ä¸Šçº§ç›®å½•æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
          elif [ -f "$GITHUB_WORKSPACE/$CONFIG_PROFILE" ]; then
            CONFIG_FOUND="$GITHUB_WORKSPACE/$CONFIG_PROFILE"
            echo "âœ… åœ¨å·¥ä½œåŒºæ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
          fi
          
          # æ–¹æ³•2: å—é™æ·±åº¦æœç´¢ - åœ¨æºç ç›®å½•å’Œé…ç½®ä»“åº“ç›®å½•éƒ½æœç´¢
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ğŸ” å—é™æ·±åº¦æœç´¢..."
            # å…ˆåœ¨æºç ç›®å½•æœç´¢
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -z "$CONFIG_FOUND" ]; then
              # åœ¨é…ç½®ä»“åº“ç›®å½•æœç´¢
              CONFIG_FOUND=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            if [ -n "$CONFIG_FOUND" ]; then
              echo "âœ… é€šè¿‡å—é™æœç´¢æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
            fi
          fi
          
          # æ–¹æ³•3: ä½¿ç”¨æ–‡ä»¶å‘ç°æ­¥éª¤çš„ç»“æœï¼ˆå¦‚æœå¯ç”¨ï¼‰- ä¿®æ­£è·¯å¾„
          if [ -z "$CONFIG_FOUND" ] && [ -f "${{ env.BUILD_LOG_DIR }}/all_config_files.txt" ]; then
            echo "ğŸ” ä½¿ç”¨æ–‡ä»¶å‘ç°ç¼“å­˜..."
            # ä»ç¼“å­˜æ–‡ä»¶ä¸­è¯»å–è·¯å¾„ï¼Œå¹¶ç¡®ä¿è·¯å¾„æ­£ç¡®
            CACHED_PATH=$(grep "$CONFIG_PROFILE" "${{ env.BUILD_LOG_DIR }}/all_config_files.txt" | head -1)
            if [ -n "$CACHED_PATH" ]; then
              # æ£€æŸ¥è·¯å¾„æ˜¯å¦ä»¥ ./ å¼€å¤´ï¼Œå¦‚æœæ˜¯åˆ™è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
              if [[ "$CACHED_PATH" == ./* ]]; then
                CONFIG_FOUND="$GITHUB_WORKSPACE/${CACHED_PATH#./}"
              else
                CONFIG_FOUND="$CACHED_PATH"
              fi
              # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if [ -f "$CONFIG_FOUND" ]; then
                echo "âœ… é€šè¿‡ç¼“å­˜æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
              else
                echo "âš ï¸ ç¼“å­˜ä¸­çš„æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FOUND"
                CONFIG_FOUND=""
              fi
            fi
          fi
          
          # æ–¹æ³•4: å¿«é€Ÿæ¨¡å¼åŒ¹é…
          if [ -z "$CONFIG_FOUND" ] && [[ "$CONFIG_PROFILE" == *"*"* ]]; then
            echo "ğŸ” å¿«é€Ÿæ¨¡å¼åŒ¹é…..."
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -z "$CONFIG_FOUND" ]; then
              CONFIG_FOUND=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            fi
            if [ -n "$CONFIG_FOUND" ]; then
              echo "âœ… é€šè¿‡æ¨¡å¼åŒ¹é…æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
            fi
          fi
          
          # æ–¹æ³•5: æ˜¾ç¤ºå¯ç”¨é…ç½®å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ª
          if [ -z "$CONFIG_FOUND" ]; then
            echo "ğŸ” æ˜¾ç¤ºå¯ç”¨é…ç½®æ–‡ä»¶..."
            AVAILABLE_CONFIGS=$(find . -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -5)
            if [ -z "$AVAILABLE_CONFIGS" ]; then
              AVAILABLE_CONFIGS=$(find $GITHUB_WORKSPACE -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -5)
            fi
            if [ -n "$AVAILABLE_CONFIGS" ]; then
              CONFIG_FOUND=$(echo "$AVAILABLE_CONFIGS" | head -1)
              echo "âš ï¸ ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„é…ç½®æ–‡ä»¶: $CONFIG_FOUND"
              echo "å¯ç”¨é…ç½®æ–‡ä»¶:"
              echo "$AVAILABLE_CONFIGS"
            fi
          fi
          
          if [ -n "$CONFIG_FOUND" ]; then
            echo "ğŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶: $CONFIG_FOUND -> .config"
            # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
            if [ -f "$CONFIG_FOUND" ]; then
              cp "$CONFIG_FOUND" .config
              echo "ğŸ” é…ç½®æ–‡ä»¶åŸºæœ¬ä¿¡æ¯:"
              CONFIG_SIZE=$(stat -c%s .config 2>/dev/null || echo "æœªçŸ¥")
              echo "  - æ–‡ä»¶: $(basename $CONFIG_FOUND)"
              echo "  - å¤§å°: ${CONFIG_SIZE} å­—èŠ‚"
              echo "  - æ¥æº: $CONFIG_FOUND"
              
              # å¿«é€Ÿåˆ†æé…ç½®
              TARGET_ARCH=$(grep "CONFIG_TARGET_ARCH_PACKAGES" .config 2>/dev/null | cut -d= -f2 | tr -d '"' | head -1 || echo "æœªçŸ¥")
              echo "  - æ¶æ„: $TARGET_ARCH"
              echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
            else
              echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FOUND"
              echo "ğŸ” éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§..."
              ls -la "$(dirname "$CONFIG_FOUND")" 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯: æ— æ³•æ‰¾åˆ°é…ç½®æ–‡ä»¶ '$CONFIG_PROFILE'"
            echo ""
            echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
            echo "å¿«é€Ÿé…ç½®æ–‡ä»¶åˆ—è¡¨:"
            find . -maxdepth 2 -name "*.config" -o -name ".config_*" 2>/dev/null | head -10 || echo "å½“å‰ç›®å½•æ— é…ç½®æ–‡ä»¶"
            find $GITHUB_WORKSPACE -maxdepth 2 -name "*.config" -o -name ".config_*" 2>/dev/null | head -10 || echo "å·¥ä½œåŒºæ— é…ç½®æ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ”§ é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "åº”ç”¨é«˜çº§æ€§èƒ½ä¼˜åŒ–é…ç½®..."
          echo "âš¡ åº”ç”¨åŸºç¡€ä¼˜åŒ–..."
          sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
          echo "CONFIG_CCACHE=y" >> .config
          
          case "${{ github.event.inputs.build_optimization }}" in
            "speed")
              echo "ğŸš€ åº”ç”¨æé€Ÿä¼˜åŒ–é…ç½®..."
              echo "CONFIG_DEBUG_INFO=n" >> .config
              ;;
            "stability")
              echo "ğŸ›¡ï¸ åº”ç”¨ç¨³å®šä¼˜åŒ–é…ç½®..."
              echo "CONFIG_SMALL_FLASH=y" >> .config
              ;;
            *)
              echo "âš–ï¸ åº”ç”¨å¹³è¡¡ä¼˜åŒ–é…ç½®..."
              ;;
          esac
          
          echo "ğŸ”„ è¿è¡Œé…ç½®å¤„ç†..."
          # ä¿®å¤Broken pipeé”™è¯¯
          echo "n" | make oldconfig >/dev/null 2>&1 || make defconfig >/dev/null 2>&1 || echo "é…ç½®å¤„ç†å®Œæˆ"
          echo "âœ… æ€§èƒ½ä¼˜åŒ–é…ç½®å®Œæˆ"

      - name: ğŸ› ï¸ å…¨é¢å·¥å…·é“¾ç¼–è¯‘ä¸éªŒè¯
        timeout-minutes: 90
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹å…¨é¢å·¥å…·é“¾ç¼–è¯‘..."
          START_TIME=$(date +%s)
          mkdir -p ${{ env.TOOLCHAIN_LOG_DIR }}
          
          echo "ğŸ”§ ç¼–è¯‘Hostå·¥å…·..."
          if ! make tools/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools.log; then
            echo "âŒ Hostå·¥å…·ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if ! make tools/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools-single.log; then
              echo "âŒ Hostå·¥å…·ç¼–è¯‘å½»åº•å¤±è´¥"
              exit 1
            fi
          fi
          
          echo "ğŸ”§ ç¼–è¯‘å·¥å…·é“¾..."
          if ! make toolchain/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile.log; then
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
            if ! make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile-single.log; then
              echo "âŒ å·¥å…·é“¾ç¼–è¯‘å½»åº•å¤±è´¥"
              exit 1
            fi
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’"
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

      - name: ğŸ” æ·±åº¦å·¥å…·é“¾éªŒè¯
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== æ·±åº¦å·¥å…·é“¾éªŒè¯ ==="
          echo "ğŸ”§ å…³é”®å·¥å…·éªŒè¯:"
          for tool in m4 flex bison; do
            tool_path=$(find staging_dir/host/bin -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$tool_path" ] && [ -x "$tool_path" ]; then
              echo "âœ… $tool: å¯ç”¨"
            else
              echo "âŒ $tool: ç¼ºå¤±"
              exit 1
            fi
          done
          
          echo "ğŸ¯ ç›®æ ‡å·¥å…·é“¾éªŒè¯:"
          TARGET_GCC=$(find staging_dir/toolchain-*/bin/ -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$TARGET_GCC" ] && [ -x "$TARGET_GCC" ]; then
            echo "âœ… ç›®æ ‡GCC: å¯ç”¨"
          else
            echo "âŒ ç›®æ ‡GCC: ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… æ·±åº¦å·¥å…·é“¾éªŒè¯å®Œæˆ"

      - name: ğŸ“¦ è¯¦ç»†è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†
        if: github.event.inputs.enable_custom_features == 'true'
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¤„ç†è¯¦ç»†è‡ªå®šä¹‰åŠŸèƒ½..."
          
          # ä½¿ç”¨é…ç½®ä»“åº“çš„ç»å¯¹è·¯å¾„
          CONFIG_REPO_DIR="$GITHUB_WORKSPACE"
          CUSTOM_FEATURES_DIR="${{ env.CUSTOM_FEATURES_DIR }}"
          
          # å¦‚æœç¯å¢ƒå˜é‡ä¸­æœ‰è®¾ç½®ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™å°è¯•é»˜è®¤è·¯å¾„
          if [ -z "$CUSTOM_FEATURES_DIR" ]; then
            CUSTOM_FEATURES_DIR="$CONFIG_REPO_DIR/firmware-config/custom-features"
            echo "â„¹ï¸ ä½¿ç”¨é»˜è®¤è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•: $CUSTOM_FEATURES_DIR"
          fi
          
          if [ -n "$CUSTOM_FEATURES_DIR" ] && [ -d "$CUSTOM_FEATURES_DIR" ]; then
            echo "ğŸ” ä½¿ç”¨è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•: $CUSTOM_FEATURES_DIR"
            
            # éªŒè¯ç›®å½•å†…å®¹
            echo "ğŸ“ ç›®å½•å†…å®¹éªŒè¯:"
            ls -la "$CUSTOM_FEATURES_DIR" 2>/dev/null || echo "æ— æ³•è®¿é—®ç›®å½•"
            
            # è¯¦ç»†å¤„ç†é¢„ç¼–è¯‘IPKåŒ…
            echo "ğŸ“¦ è¯¦ç»†å¤„ç†é¢„ç¼–è¯‘IPKåŒ…..."
            IPK_DIRS=("$CUSTOM_FEATURES_DIR/prebuilt-ipks" "$CUSTOM_FEATURES_DIR/ipks" "$CUSTOM_FEATURES_DIR/packages")
            IPK_PROCESSED=false
            
            for ipk_dir in "${IPK_DIRS[@]}"; do
              if [ -d "$ipk_dir" ]; then
                echo "ğŸ” æ£€æŸ¥IPKç›®å½•: $ipk_dir"
                IPK_FILES=$(find "$ipk_dir" -name "*.ipk" -type f 2>/dev/null)
                IPK_COUNT=$(echo "$IPK_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
                
                if [ "$IPK_COUNT" -gt 0 ]; then
                  echo "âœ… åœ¨ $ipk_dir æ‰¾åˆ° $IPK_COUNT ä¸ªIPKæ–‡ä»¶"
                  mkdir -p package/base-files/files/usr/lib/opkg/custom
                  
                  echo "ğŸ“‹ IPKæ–‡ä»¶åˆ—è¡¨:"
                  for ipk in $IPK_FILES; do
                    if [ -f "$ipk" ]; then
                      filename=$(basename "$ipk")
                      filesize=$(stat -c%s "$ipk" 2>/dev/null || echo "æœªçŸ¥")
                      echo "  - $filename ($(($filesize/1024))KB)"
                      cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
                      echo "    âœ… å·²å¤åˆ¶åˆ°å›ºä»¶"
                    fi
                  done
                  IPK_PROCESSED=true
                  break
                else
                  echo "â„¹ï¸ ç›®å½• $ipk_dir ä¸­æ²¡æœ‰æ‰¾åˆ°IPKæ–‡ä»¶"
                fi
              fi
            done
            
            if [ "$IPK_PROCESSED" = "false" ]; then
              echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½•IPKæ–‡ä»¶"
            fi
            
            # è¯¦ç»†å¤„ç†è‡ªå®šä¹‰è„šæœ¬
            echo ""
            echo "ğŸ“œ è¯¦ç»†å¤„ç†è‡ªå®šä¹‰è„šæœ¬..."
            SCRIPT_DIRS=("$CUSTOM_FEATURES_DIR/scripts" "$CUSTOM_FEATURES_DIR/script")
            SCRIPT_PROCESSED=false
            
            for script_dir in "${SCRIPT_DIRS[@]}"; do
              if [ -d "$script_dir" ]; then
                echo "ğŸ” æ£€æŸ¥è„šæœ¬ç›®å½•: $script_dir"
                SCRIPT_FILES=$(find "$script_dir" -name "*.sh" -type f 2>/dev/null)
                SCRIPT_COUNT=$(echo "$SCRIPT_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
                
                if [ "$SCRIPT_COUNT" -gt 0 ]; then
                  echo "âœ… åœ¨ $script_dir æ‰¾åˆ° $SCRIPT_COUNT ä¸ªè„šæœ¬æ–‡ä»¶"
                  
                  echo "ğŸ“‹ è„šæœ¬æ–‡ä»¶åˆ—è¡¨:"
                  for script in $SCRIPT_FILES; do
                    if [ -f "$script" ]; then
                      filename=$(basename "$script")
                      echo "  - $filename"
                      echo "    â–¶ï¸ æ‰§è¡Œè„šæœ¬..."
                      chmod +x "$script"
                      export SOURCE_DIR="${{ env.SOURCE_DIR }}"
                      export BUILD_DIR="${{ env.SOURCE_DIR }}/build_dir"
                      export STAGING_DIR="${{ env.SOURCE_DIR }}/staging_dir"
                      
                      if timeout 300 bash "$script"; then
                        echo "    âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
                      else
                        EXIT_CODE=$?
                        if [ $EXIT_CODE -eq 124 ]; then
                          echo "    â° è„šæœ¬æ‰§è¡Œè¶…æ—¶"
                        else
                          echo "    âš ï¸ è„šæœ¬æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $EXIT_CODE)"
                        fi
                      fi
                    fi
                  done
                  SCRIPT_PROCESSED=true
                  break
                else
                  echo "â„¹ï¸ ç›®å½• $script_dir ä¸­æ²¡æœ‰æ‰¾åˆ°è„šæœ¬æ–‡ä»¶"
                fi
              fi
            done
            
            if [ "$SCRIPT_PROCESSED" = "false" ]; then
              echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½•è„šæœ¬æ–‡ä»¶"
            fi
            
            # å¤„ç†è‡ªå®šä¹‰è¡¥ä¸
            echo ""
            echo "ğŸ”§ å¤„ç†è‡ªå®šä¹‰è¡¥ä¸..."
            PATCH_FILES=$(find "$CUSTOM_FEATURES_DIR" -name "*.patch" -type f 2>/dev/null)
            PATCH_COUNT=$(echo "$PATCH_FILES" | grep -v '^$' | wc -l 2>/dev/null || echo 0)
            
            if [ "$PATCH_COUNT" -gt 0 ]; then
              echo "âœ… æ‰¾åˆ° $PATCH_COUNT ä¸ªè¡¥ä¸æ–‡ä»¶"
              for patch in $PATCH_FILES; do
                if [ -f "$patch" ]; then
                  echo "ğŸ”§ åº”ç”¨è¡¥ä¸: $(basename $patch)"
                  if patch -p1 -N < "$patch"; then
                    echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ: $(basename $patch)"
                  else
                    echo "âš ï¸ è¡¥ä¸åº”ç”¨å¤±è´¥æˆ–å·²åº”ç”¨: $(basename $patch)"
                  fi
                fi
              done
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°è¡¥ä¸æ–‡ä»¶"
            fi
            
          else
            echo "â„¹ï¸ æ— è‡ªå®šä¹‰åŠŸèƒ½ç›®å½•æˆ–ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†"
            echo "æœç´¢çš„ç›®å½•: $CUSTOM_FEATURES_DIR"
          fi
          echo "âœ… è‡ªå®šä¹‰åŠŸèƒ½å¤„ç†å®Œæˆ"

      - name: ğŸ”§ æ·±åº¦ç›®å½•ä¿®å¤ä¸æƒé™è®¾ç½®
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== æ·±åº¦ç›®å½•ä¿®å¤ä¸æƒé™è®¾ç½® ==="
          
          echo "ğŸ”§ åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•..."
          # åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„
          ROOT_PATTERNS=("root.orig-*" "root-*" "root.default-*")
          
          for pattern in "${ROOT_PATTERNS[@]}"; do
            echo "æœç´¢æ¨¡å¼: $pattern"
            find build_dir staging_dir -type d -name "$pattern" 2>/dev/null | while read root_dir; do
              echo "ğŸ”§ ä¿®å¤ç›®å½•: $root_dir"
              # åˆ›å»ºå¿…è¦çš„å­ç›®å½•
              mkdir -p "$root_dir/tmp" 2>/dev/null || true
              mkdir -p "$root_dir/usr/lib/opkg" 2>/dev/null || true
              mkdir -p "$root_dir/var/lock" 2>/dev/null || true
              mkdir -p "$root_dir/var/run" 2>/dev/null || true
              
              # è®¾ç½®æƒé™
              chmod 755 "$root_dir/tmp" 2>/dev/null || true
              chmod 755 "$root_dir/usr" 2>/dev/null || true
              chmod 755 "$root_dir/var" 2>/dev/null || true
            done
          done
          
          echo "ğŸ”§ ä¿®å¤ç›®æ ‡ç‰¹å®šç›®å½•..."
          # ç‰¹åˆ«ä¿®å¤é”™è¯¯ä¸­æåˆ°çš„ç›®å½•
          TARGET_DIRS=(
            "build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root.orig-ipq40xx"
            "staging_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root.orig-ipq40xx"
          )
          
          for target_dir in "${TARGET_DIRS[@]}"; do
            if [ -d "$target_dir" ]; then
              echo "ğŸ”§ ä¿®å¤ç›®æ ‡ç›®å½•: $target_dir"
              mkdir -p "$target_dir/tmp"
              mkdir -p "$target_dir/usr/lib/opkg"
              chmod 755 "$target_dir/tmp"
              echo "âœ… å·²åˆ›å»º: $target_dir/tmp"
            else
              echo "â„¹ï¸ ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»º: $target_dir"
              mkdir -p "$target_dir/tmp" 2>/dev/null || true
            fi
          done
          
          echo "ğŸ”§ ä¿®å¤ç¬¦å·é“¾æ¥é—®é¢˜..."
          # æ£€æŸ¥å¹¶ä¿®å¤å¯èƒ½çš„ç¬¦å·é“¾æ¥é—®é¢˜
          if [ -L "tmp" ] && [ ! -e "tmp" ]; then
            echo "ğŸ”§ ä¿®å¤æŸåçš„tmpç¬¦å·é“¾æ¥..."
            rm -f tmp
            mkdir -p tmp
          fi
          
          echo "âœ… æ·±åº¦ç›®å½•ä¿®å¤å®Œæˆ"

      - name: ğŸ—ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶
        timeout-minutes: 240
        id: compile-firmware
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "å¼€å§‹æ™ºèƒ½ç¼–è¯‘å›ºä»¶..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=linux
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros
          CPU_CORES=$(nproc)
          BUILD_JOBS=$((CPU_CORES - 1))
          mkdir -p ${{ env.BUILD_LOG_DIR }}
          START_TIME=$(date +%s)
          
          echo "ğŸ“Š ç¼–è¯‘å‚æ•°æ±‡æ€»:"
          echo "  - æºç åº“: ${{ env.SOURCE_PRESET }}"
          echo "  - å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "  - å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo "  - CPUæ ¸å¿ƒ: $CPU_CORES"
          echo "  - ç¼–è¯‘ä»»åŠ¡æ•°: $BUILD_JOBS"
          echo "  - CCache: å·²å¯ç”¨"
          
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘..."
          LOG_FILE="${{ env.BUILD_LOG_DIR }}/firmware-compile.log"
          ERROR_LOG_FILE="${{ env.BUILD_LOG_DIR }}/firmware-errors.log"
          
          # åˆ†é˜¶æ®µç¼–è¯‘ä»¥æé«˜ç¨³å®šæ€§
          {
            echo "é˜¶æ®µ1: ç¼–è¯‘å‡†å¤‡..."
            make tools/install 2>/dev/null || true
            make toolchain/install 2>/dev/null || true
            
            echo "é˜¶æ®µ2: ç¼–è¯‘å†…æ ¸å’ŒåŸºç¡€åŒ…..."
            make target/linux/compile -j$BUILD_JOBS V=s
            
            echo "é˜¶æ®µ3: ç¼–è¯‘æ‰€æœ‰è½¯ä»¶åŒ…..."
            # è·³è¿‡æœ‰é—®é¢˜çš„åŒ…
            make package/compile -j$BUILD_JOBS V=s || {
              echo "âš ï¸ éƒ¨åˆ†åŒ…ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­å…¶ä»–åŒ…..."
              # å°è¯•è·³è¿‡æœ‰é—®é¢˜çš„åŒ…ç»§ç»­ç¼–è¯‘
              make package/compile -j$BUILD_JOBS V=sc || true
            }
            
            echo "é˜¶æ®µ4: åŠ¨æ€ç›®å½•ä¿®å¤..."
            # åœ¨å®‰è£…å‰å†æ¬¡æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦çš„ç›®å½•
            echo "ğŸ”§ åŠ¨æ€åˆ›å»ºç¼ºå¤±çš„ç›®å½•..."
            find build_dir staging_dir -type d -name "root.orig-*" 2>/dev/null | while read root_dir; do
              if [ ! -d "$root_dir/tmp" ]; then
                mkdir -p "$root_dir/tmp"
                echo "âœ… åŠ¨æ€åˆ›å»º: $root_dir/tmp"
              fi
              if [ ! -d "$root_dir/usr/lib/opkg" ]; then
                mkdir -p "$root_dir/usr/lib/opkg"
                echo "âœ… åŠ¨æ€åˆ›å»º: $root_dir/usr/lib/opkg"
              fi
            done
            
            echo "é˜¶æ®µ5: æœ€ç»ˆå®‰è£…å’Œå›ºä»¶ç”Ÿæˆ..."
            # ä¿®å¤å¯èƒ½çš„ç›®å½•æƒé™é—®é¢˜
            sudo chmod -R 755 build_dir/ staging_dir/ 2>/dev/null || true
            
            # ä½¿ç”¨æ›´å¥å£®çš„å®‰è£…æ–¹æ³•
            echo "ğŸ”§ å°è¯•å¹¶è¡Œå®‰è£…..."
            if ! make package/install -j$BUILD_JOBS V=s; then
              echo "âš ï¸ å¹¶è¡Œå®‰è£…å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹å®‰è£…..."
              if ! make package/install -j1 V=s; then
                echo "âŒ åŒ…å®‰è£…å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ç»§ç»­..."
                grep -i "error\|failed" $LOG_FILE | tail -20 > $ERROR_LOG_FILE 2>/dev/null || true
              fi
            fi
            
            echo "ğŸ”§ å°è¯•ç›®æ ‡å®‰è£…..."
            if ! make target/install -j1 V=s; then
              echo "âŒ ç›®æ ‡å®‰è£…å¤±è´¥ï¼Œä½†å°è¯•ç»§ç»­ç”Ÿæˆå›ºä»¶..."
              # å³ä½¿ç›®æ ‡å®‰è£…å¤±è´¥ï¼Œä¹Ÿå°è¯•ç”Ÿæˆå›ºä»¶
              if make -j1 V=s 2>/dev/null; then
                echo "âœ… å›ºä»¶ç”ŸæˆæˆåŠŸ"
              else
                echo "âŒ å›ºä»¶ç”Ÿæˆå¤±è´¥"
                exit 1
              fi
            fi
            
            echo "é˜¶æ®µ6: ç¼–è¯‘å®ŒæˆéªŒè¯..."
          } 2>&1 | tee "$LOG_FILE"
          
          COMPILE_EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
          
          if [ $COMPILE_EXIT_CODE -eq 0 ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç : $COMPILE_EXIT_CODE"
            echo "=== è¯¦ç»†é”™è¯¯åˆ†æ ==="
            if [ -f "$LOG_FILE" ]; then
              echo "å…³é”®é”™è¯¯:"
              grep -i "error\|failed\|undefined\|missing\|no such file\|cannot create\|Broken pipe" "$LOG_FILE" | tail -30 || echo "æ— æ˜ç¡®é”™è¯¯ä¿¡æ¯"
              echo ""
              echo "æœ€åç¼–è¯‘æ­¥éª¤:"
              tail -150 "$LOG_FILE" | grep -E "(Configuring|Compiling|Linking|Installing|ERROR|Error|error|Collected errors)" | tail -50 || echo "æ— æ³•è·å–æœ€åæ­¥éª¤"
              
              # ç‰¹åˆ«æ£€æŸ¥ç›®å½•ç›¸å…³é—®é¢˜
              echo ""
              echo "ğŸ” ç›®å½•ç»“æ„æ£€æŸ¥:"
              find build_dir -name "root.orig-*" -type d 2>/dev/null | head -5 | while read dir; do
                if [ -d "$dir" ]; then
                  echo "æ£€æŸ¥ç›®å½•: $dir"
                  ls -la "$dir/" 2>/dev/null | head -8 || echo "æ— æ³•è®¿é—®ç›®å½•"
                  echo "tmpç›®å½•çŠ¶æ€:"
                  if [ -d "$dir/tmp" ]; then
                    ls -la "$dir/tmp/" 2>/dev/null | head -3 || echo "æ— æ³•è®¿é—®tmpç›®å½•"
                  else
                    echo "âŒ tmpç›®å½•ä¸å­˜åœ¨"
                  fi
                fi
              done
            fi
            exit 1
          fi
          
          echo "â±ï¸ æ€»ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"

      - name: ğŸ” è¯¦ç»†å›ºä»¶äº§ç‰©éªŒè¯ä¸æ”¶é›†
        if: env.BUILD_STATUS == 'success'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== è¯¦ç»†å›ºä»¶äº§ç‰©éªŒè¯ä¸æ”¶é›† ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          mkdir -p ${{ env.ARTIFACTS_DIR }}/configs
          
          echo "ğŸ” æœç´¢å›ºä»¶æ–‡ä»¶..."
          TOTAL_FIRMWARE_COUNT=0
          
          # è¯¦ç»†æœç´¢å›ºä»¶æ–‡ä»¶
          if [ -d "bin/targets" ]; then
            echo "ğŸ“ å¤åˆ¶æ ‡å‡†è¾“å‡ºç›®å½•..."
            cp -r bin/targets ${{ env.ARTIFACTS_DIR }}/firmware/
            FIRMWARE_COUNT=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | wc -l)
            echo "âœ… åœ¨ bin/targets æ‰¾åˆ° $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
            TOTAL_FIRMWARE_COUNT=$((TOTAL_FIRMWARE_COUNT + FIRMWARE_COUNT))
            
            # æ˜¾ç¤ºæ‰¾åˆ°çš„å›ºä»¶æ–‡ä»¶
            echo "ğŸ“‹ å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
            find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | head -20 | while read file; do
              if [ -f "$file" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                echo "  - $(basename "$file") ($(($file_size/1024/1024))MB)"
              fi
            done
          else
            echo "âš ï¸ æ ‡å‡†è¾“å‡ºç›®å½• bin/targets ä¸å­˜åœ¨"
            echo "ğŸ“ å½“å‰ bin ç›®å½•å†…å®¹:"
            ls -la bin/ 2>/dev/null || echo "bin ç›®å½•ä¸å­˜åœ¨"
          fi
          
          # åœ¨å…¶ä»–ä½ç½®æœç´¢
          echo "ğŸ” åœ¨å…¶ä»–ä½ç½®æœç´¢å›ºä»¶..."
          OTHER_FIRMWARE=$(find . -maxdepth 4 -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | grep -v "bin/targets" | head -20)
          if [ -n "$OTHER_FIRMWARE" ]; then
            OTHER_COUNT=$(echo "$OTHER_FIRMWARE" | wc -l)
            echo "âœ… åœ¨å…¶ä»–ä½ç½®æ‰¾åˆ° $OTHER_COUNT ä¸ªå›ºä»¶ç›¸å…³æ–‡ä»¶"
            for file in $OTHER_FIRMWARE; do
              if [ -f "$file" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                if [ "$file_size" -gt 1000000 ]; then
                  rel_path=$(echo "$file" | sed 's|^\./||')
                  target_dir="${{ env.ARTIFACTS_DIR }}/firmware/other/$(dirname "$rel_path")"
                  mkdir -p "$target_dir"
                  cp "$file" "$target_dir/"
                  echo "ğŸ“¦ å·²æ”¶é›†: $rel_path ($(($file_size/1024/1024))MB)"
                  TOTAL_FIRMWARE_COUNT=$((TOTAL_FIRMWARE_COUNT + 1))
                fi
              fi
            done
          fi
          
          echo "ğŸ“‹ æ”¶é›†æ„å»ºä¿¡æ¯å’Œæ—¥å¿—..."
          # æ”¶é›†é…ç½®æ–‡ä»¶
          cp .config ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶.config"
          cp feeds.conf ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶feeds.conf"
          
          # æ”¶é›†æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
          echo "ğŸ“ æ”¶é›†æ—¥å¿—æ–‡ä»¶..."
          if [ -d "${{ env.BUILD_LOG_DIR }}" ]; then
            cp -r ${{ env.BUILD_LOG_DIR }}/* ${{ env.ARTIFACTS_DIR }}/logs/ 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶æ„å»ºæ—¥å¿—"
          fi
          if [ -d "${{ env.TOOLCHAIN_LOG_DIR }}" ]; then
            cp -r ${{ env.TOOLCHAIN_LOG_DIR }}/* ${{ env.ARTIFACTS_DIR }}/logs/ 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶å·¥å…·é“¾æ—¥å¿—"
          fi
          
          # æ”¶é›†ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é‡è¦æ—¥å¿—
          echo "ğŸ“ æ”¶é›†ç¼–è¯‘è¿‡ç¨‹æ—¥å¿—..."
          find . -name "*.log" -type f -size +1k 2>/dev/null | head -10 | while read log_file; do
            log_name=$(echo "$log_file" | sed 's|^\./||' | tr '/' '_')
            cp "$log_file" "${{ env.ARTIFACTS_DIR }}/logs/process_$log_name" 2>/dev/null || true
          done
          
          if [ $TOTAL_FIRMWARE_COUNT -eq 0 ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find . -maxdepth 3 -type d | head -20
            echo ""
            echo "æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶:"
            find . -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" 2>/dev/null | head -30 || echo "æ— å›ºä»¶æ–‡ä»¶"
            exit 1
          else
            echo "âœ… å›ºä»¶éªŒè¯ä¸æ”¶é›†å®Œæˆ: æ€»å…± $TOTAL_FIRMWARE_COUNT ä¸ªæ–‡ä»¶"
          fi
          echo "FIRMWARE_COUNT=$TOTAL_FIRMWARE_COUNT" >> $GITHUB_ENV

      - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†æ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "ç”Ÿæˆè¯¦ç»†æ„å»ºæŠ¥å‘Š..."
          REPORT_FILE="${{ env.ARTIFACTS_DIR }}/detailed-build-report.txt"
          
          {
            echo "=== è¯¦ç»†å›ºä»¶æ„å»ºæŠ¥å‘Š ==="
            echo "æ„å»ºæ—¶é—´: $(date)"
            echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
            echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
            echo "å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
            echo ""
            echo "=== æºç ä¿¡æ¯ ==="
            echo "æºç åº“: ${{ env.SOURCE_PRESET }}"
            echo "è¯·æ±‚åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
            echo "å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
            echo "æ¨èåˆ†æ”¯: ${{ env.RECOMMENDED_BRANCH }}"
            echo "æäº¤å“ˆå¸Œ: ${{ env.COMMIT_HASH || 'unknown' }}"
            echo ""
            echo "=== ç¼–è¯‘é…ç½® ==="
            echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
            echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
            echo "å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}"
            echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
            echo ""
            echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
            echo "Runner: ${{ runner.os }}"
            echo "CPUæ ¸å¿ƒ: $(nproc)"
            echo "å†…å­˜: $(free -h | awk '/^Mem:/{print $2}')"
            echo "ç£ç›˜ç©ºé—´: $(df -h /mnt | awk 'NR==2{print $4}') å¯ç”¨"
            echo ""
            echo "=== é”™è¯¯åˆ†æ ==="
            if [ "${{ env.BUILD_STATUS }}" = "failed" ]; then
              echo "ä¸»è¦é”™è¯¯: opkgé”æ–‡ä»¶åˆ›å»ºå¤±è´¥"
              echo "æ ¹æœ¬åŸå› :"
              echo "  - è·¯å¾„æ‹¼æ¥é”™è¯¯å¯¼è‡´åŒæ–œæ : //tmp/opkg.lock"
              echo "  - ç›®æ ‡æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„ä¸å®Œæ•´"
              echo "  - ç¼–è¯‘ç³»ç»Ÿåœ¨å®‰è£…é˜¶æ®µæ— æ³•åˆ›å»ºå¿…è¦ç›®å½•"
              echo ""
              echo "å·²å®æ–½çš„è§£å†³æ–¹æ¡ˆ:"
              echo "  - æ·±åº¦ç›®å½•ä¿®å¤ï¼Œé¢„åˆ›å»ºæ‰€æœ‰å¯èƒ½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•"
              echo "  - åŠ¨æ€ç›®å½•åˆ›å»ºï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å®æ—¶ä¿®å¤ç¼ºå¤±ç›®å½•"
              echo "  - æ”¹è¿›çš„é”™è¯¯æ¢å¤æœºåˆ¶ï¼Œå³ä½¿å®‰è£…å¤±è´¥ä¹Ÿå°è¯•ç”Ÿæˆå›ºä»¶"
              echo ""
              echo "å»ºè®®è¿›ä¸€æ­¥æ’æŸ¥:"
              echo "  - æ£€æŸ¥OpenWrtç‰ˆæœ¬ä¸é…ç½®æ–‡ä»¶çš„å…¼å®¹æ€§"
              echo "  - éªŒè¯ç›®æ ‡è®¾å¤‡çš„æ”¯æŒçŠ¶æ€"
              echo "  - è€ƒè™‘ä½¿ç”¨æ›´æ–°çš„æºç åˆ†æ”¯"
            fi
            echo ""
            if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
              echo "=== äº§ç‰©ä¿¡æ¯ ==="
              echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
              find ${{ env.ARTIFACTS_DIR }}/firmware -type f 2>/dev/null | xargs -I {} basename {} 2>/dev/null | sort | head -20
              echo ""
              echo "æ—¥å¿—æ–‡ä»¶åˆ—è¡¨:"
              find ${{ env.ARTIFACTS_DIR }}/logs -type f 2>/dev/null | xargs -I {} basename {} 2>/dev/null | sort | head -10
            else
              echo "æ„å»ºå¤±è´¥ï¼Œæ— å›ºä»¶äº§ç‰©"
            fi
            echo ""
            echo "=== è‡ªå®šä¹‰åŠŸèƒ½çŠ¶æ€ ==="
            if [ "${{ github.event.inputs.enable_custom_features }}" = "true" ]; then
              if [ -n "${{ env.CUSTOM_FEATURES_DIR }}" ]; then
                echo "âœ… è‡ªå®šä¹‰åŠŸèƒ½å·²å¯ç”¨"
                echo "è‡ªå®šä¹‰ç›®å½•: ${{ env.CUSTOM_FEATURES_DIR }}"
              else
                echo "âš ï¸ è‡ªå®šä¹‰åŠŸèƒ½å·²å¯ç”¨ä½†æœªæ‰¾åˆ°ç›®å½•"
              fi
            else
              echo "â„¹ï¸ è‡ªå®šä¹‰åŠŸèƒ½æœªå¯ç”¨"
            fi
          } > "$REPORT_FILE"
          
          echo "âœ… è¯¦ç»†æ„å»ºæŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 30

      - name: ğŸ§¹ ç¼–è¯‘åæ™ºèƒ½æ¸…ç†
        if: always()
        run: |
          echo "å¼€å§‹ç¼–è¯‘åæ™ºèƒ½æ¸…ç†..."
          echo "=== æ¸…ç†å‰çŠ¶æ€ ==="
          df -h
          free -h
          
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘ä¸´æ—¶æ–‡ä»¶..."
            rm -rf build_dir/* staging_dir/* tmp/* 2>/dev/null || true
          fi
          
          echo "ğŸ§¹ æ¸…ç†äº¤æ¢æ–‡ä»¶..."
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          
          echo ""
          echo "=== æ¸…ç†åçŠ¶æ€ ==="
          df -h
          free -h
          echo "âœ… æ™ºèƒ½æ¸…ç†å®Œæˆ"

      - name: ğŸ“Š æœ€ç»ˆç»¼åˆæŠ¥å‘Š
        if: always()
        run: |
          echo "=== æœ€ç»ˆç»¼åˆæŠ¥å‘Š ==="
          echo "ğŸ¯ å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ†” è¿è¡ŒID: ${{ github.run_id }}"
          echo "ğŸ†” è¿è¡Œå·: ${{ github.run_number }}"
          echo ""
          echo "ğŸ“¦ æºç ä¿¡æ¯:"
          echo "  - é¢„è®¾: ${{ env.SOURCE_PRESET }}"
          echo "  - åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "  - æ¨è: ${{ env.RECOMMENDED_BRANCH }}"
          echo "  - æäº¤: ${{ env.COMMIT_HASH || 'unknown' }}"
          echo ""
          echo "âš™ï¸ ç¼–è¯‘é…ç½®:"
          echo "  - é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
          echo "  - ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "  - å·¥å…·é“¾: ${{ github.event.inputs.toolchain_strategy }}"
          echo "  - è‡ªå®šä¹‰: ${{ github.event.inputs.enable_custom_features }}"
          echo ""
          echo "ğŸ“ˆ æ„å»ºç»“æœ:"
          echo "  - çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
          echo "  - å›ºä»¶æ•°é‡: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
            echo "ğŸ“¦ ä¸‹è½½ Artifacts è·å–ç¼–è¯‘äº§ç‰©"
            echo "ğŸ”§ å›ºä»¶æ–‡ä»¶åœ¨ firmware/ ç›®å½•ä¸­"
            echo "ğŸ“‹ è¯¦ç»†æŠ¥å‘Šåœ¨ detailed-build-report.txt"
            echo "ğŸ“ æ—¥å¿—æ–‡ä»¶åœ¨ logs/ ç›®å½•ä¸­"
          else
            echo "âŒ æ„å»ºå¤±è´¥"
            echo "ğŸ” è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—åˆ†æé”™è¯¯åŸå› "
            echo "ğŸ“‹ æ£€æŸ¥ Artifacts ä¸­çš„ç¼–è¯‘æ—¥å¿—"
            echo "ğŸ’¡ æ ¹æœ¬é—®é¢˜: opkgé”æ–‡ä»¶åˆ›å»ºå¤±è´¥ (è·¯å¾„æ‹¼æ¥é”™è¯¯)"
            echo "ğŸ› ï¸ å·²å®æ–½çš„ä¿®å¤:"
            echo "  - æ·±åº¦ç›®å½•é¢„åˆ›å»º"
            echo "  - åŠ¨æ€ç›®å½•ä¿®å¤"
            echo "  - æ”¹è¿›çš„é”™è¯¯æ¢å¤"
            echo "ğŸ”§ å»ºè®®è¿›ä¸€æ­¥æ“ä½œ:"
            echo "  - æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸æºç ç‰ˆæœ¬çš„å…¼å®¹æ€§"
            echo "  - å°è¯•ä¸åŒçš„æºç åˆ†æ”¯"
            echo "  - éªŒè¯ç›®æ ‡è®¾å¤‡æ”¯æŒçŠ¶æ€"
          fi
