name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æŒ‡å®š main/master ç­‰)'
        required: true
        default: 'auto'
        type: string
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      build_optimization:
        description: 'ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥'
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: 'balanced'
      toolchain_strategy:
        description: 'å·¥å…·é“¾ç­–ç•¥'
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: 'auto'
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  SOURCE_DIR: "/tmp/source"
  ARTIFACTS_DIR: "/tmp/artifacts"
  CCACHE_DIR: "/tmp/ccache"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: firmware-config

    - name: "ğŸ’¾ ç³»ç»Ÿèµ„æºåˆ†æ"
      run: |
        echo "=== ç³»ç»Ÿèµ„æºåˆ†æ ==="
        df -h
        echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
        free -h

    - name: "ğŸ”§ è®¾ç½®å·¥ä½œç¯å¢ƒ"
      run: |
        echo "è®¾ç½®ç¼–è¯‘ç¯å¢ƒ..."
        sudo mkdir -p ${{ env.SOURCE_DIR }}
        sudo mkdir -p ${{ env.ARTIFACTS_DIR }}
        sudo mkdir -p ${{ env.CCACHE_DIR }}
        sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }}
        sudo chown -R $USER:$USER ${{ env.ARTIFACTS_DIR }}
        sudo chown -R $USER:$USER ${{ env.CCACHE_DIR }}
        
        echo "ğŸ”„ åˆ›å»ºäº¤æ¢æ–‡ä»¶..."
        sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "âš¡ ä¼˜åŒ–ç³»ç»Ÿè®¾ç½®..."
        ulimit -n 65536
        export FORCE_UNSAFE_CONFIGURE=1

    - name: "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶"
      run: |
        echo "=== éªŒè¯é…ç½®æ–‡ä»¶ ==="
        if [ ! -f "firmware-config/repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          echo "è¯·åˆ›å»º firmware-config/repositories.json æ–‡ä»¶ï¼Œå†…å®¹ç¤ºä¾‹:"
          cat << 'EOF'
          {
            "repositories": {
              "immortalwrt": {
                "url": "https://github.com/immortalwrt/immortalwrt",
                "description": "ImmortalWrt åŠŸèƒ½ä¸°å¯Œ",
                "recommended_branch": "openwrt-21.02"
              },
              "openwrt": {
                "url": "https://github.com/openwrt/openwrt",
                "description": "OpenWrt å®˜æ–¹çº¯å‡€",
                "recommended_branch": "main"
              },
              "lede": {
                "url": "https://github.com/coolsnowwolf/lede",
                "description": "LEDE é›†æˆåº¦é«˜", 
                "recommended_branch": "master"
              }
            }
          }
          EOF
          exit 1
        fi
        
        echo "âœ… repositories.json å­˜åœ¨"
        cat firmware-config/repositories.json

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        echo "æ­£åœ¨è§£ææºç é…ç½®..."
        
        PRESET="${{ github.event.inputs.source_preset }}"
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"æœªçŸ¥\"" firmware-config/repositories.json)
        
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°é¢„è®¾ $PRESET çš„æºç URL"
          echo "å¯ç”¨çš„é¢„è®¾:"
          jq -r '.repositories | keys[]' firmware-config/repositories.json
          exit 1
        fi
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
        fi
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
        echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
        echo "âœ… æºç é…ç½®: $PRESET - $DESCRIPTION, åˆ†æ”¯: $BRANCH"

    - name: "ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–"
      run: |
        echo "å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–åŒ…..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-setuptools rsync unzip zlib1g-dev file wget jq ccache \
          m4 help2man texinfo texi2html libtool-bin automake autoconf \
          pkg-config subversion mercurial curl cmake ninja-build libelf-dev \
          libssl-dev zlib1g-dev libc6-dev
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: "âš¡ è®¾ç½®ç¼–è¯‘ç¼“å­˜"
      run: |
        echo "è®¾ç½®CCache..."
        ccache -M 4G
        ccache -o compression=true
        echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
        echo "âœ… ç¼“å­˜è®¾ç½®å®Œæˆ"

    - name: "ğŸ“¥ è·å–æºä»£ç ï¼ˆæ”¯æŒ main/master åˆ†æ”¯ï¼‰"
      id: clone-source
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
        cd ${{ env.SOURCE_DIR }}
        
        REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
        echo "è¯·æ±‚çš„åˆ†æ”¯: $REQUESTED_BRANCH"
        
        # å°è¯•å…‹éš†æŒ‡å®šåˆ†æ”¯
        if git clone --depth 1 --branch "$REQUESTED_BRANCH" "${{ env.SOURCE_URL }}" . 2>/dev/null; then
          echo "âœ… ä½¿ç”¨æŒ‡å®šåˆ†æ”¯å…‹éš†æˆåŠŸ: $REQUESTED_BRANCH"
          ACTUAL_BRANCH="$REQUESTED_BRANCH"
        else
          echo "âš ï¸ æŒ‡å®šåˆ†æ”¯ $REQUESTED_BRANCH å¤±è´¥ï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹åˆ†æ”¯..."
          
          # å…ˆå…‹éš†ä»“åº“ä½†ä¸æ£€å‡ºåˆ†æ”¯
          git clone --depth 1 "${{ env.SOURCE_URL }}" .
          
          # å°è¯•å¸¸è§åˆ†æ”¯åç§°
          COMMON_BRANCHES="main master openwrt-23.05 openwrt-22.03 openwrt-21.02 immortalwrt-21.02 lede-17.01"
          for branch in $COMMON_BRANCHES; do
            if git checkout "$branch" 2>/dev/null; then
              echo "âœ… ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹åˆ†æ”¯: $branch"
              ACTUAL_BRANCH="$branch"
              break
            fi
          done
          
          # å¦‚æœå¸¸è§åˆ†æ”¯éƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨è¿œç¨‹é»˜è®¤åˆ†æ”¯
          if [ -z "$ACTUAL_BRANCH" ]; then
            DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d" " -f5)
            if [ -n "$DEFAULT_BRANCH" ] && git checkout "$DEFAULT_BRANCH" 2>/dev/null; then
              echo "âœ… ä½¿ç”¨é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
              ACTUAL_BRANCH="$DEFAULT_BRANCH"
            else
              # æœ€åå°è¯•ä»»ä½•å¯ç”¨çš„åˆ†æ”¯
              FIRST_BRANCH=$(git branch -r | head -1 | sed 's|origin/||' | tr -d ' ')
              if [ -n "$FIRST_BRANCH" ] && git checkout "$FIRST_BRANCH" 2>/dev/null; then
                echo "âœ… ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨åˆ†æ”¯: $FIRST_BRANCH"
                ACTUAL_BRANCH="$FIRST_BRANCH"
              fi
            fi
          fi
        fi
        
        if [ -z "$ACTUAL_BRANCH" ]; then
          echo "âŒ æ— æ³•æ‰¾åˆ°åˆé€‚çš„åˆ†æ”¯ï¼Œå…‹éš†å¤±è´¥"
          exit 1
        fi
        
        echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
        echo "âœ… æºç å…‹éš†å®Œæˆï¼Œå®é™…åˆ†æ”¯: $ACTUAL_BRANCH"

    - name: "ğŸ”„ æºç åˆå§‹åŒ–ä¸ä¾èµ–"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "å¼€å§‹æºç åˆå§‹åŒ–..."
        
        # ç¡®ä¿ feeds é…ç½®å­˜åœ¨
        if [ ! -f "feeds.conf" ] && [ -f "feeds.conf.default" ]; then
          cp feeds.conf.default feeds.conf
        fi
        
        echo "æ›´æ–° feeds..."
        ./scripts/feeds update -a || {
          echo "âš ï¸ Feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
          ./scripts/feeds clean
          ./scripts/feeds update -a
        }
        
        echo "å®‰è£… feeds..."
        ./scripts/feeds install -a || echo "âš ï¸ éƒ¨åˆ†feedså®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­ç¼–è¯‘"
        
        echo "âœ… æºç åˆå§‹åŒ–å®Œæˆ"

    - name: "ğŸ¨ åº”ç”¨è®¾å¤‡é…ç½®"
      run: |
        cd ${{ env.SOURCE_DIR }}
        CONFIG_FILE="firmware-config/${{ github.event.inputs.config_profile }}"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          echo "å¯ç”¨çš„é…ç½®æ–‡ä»¶:"
          find firmware-config/configs -name ".config_*" 2>/dev/null | head -10 || echo "æ— é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ: $(basename $CONFIG_FILE)"

    - name: "ğŸ”§ é…ç½®ä¼˜åŒ–"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "åº”ç”¨ç¼–è¯‘ä¼˜åŒ–..."
        
        # å¯ç”¨ccache
        echo "CONFIG_CCACHE=y" >> .config
        
        # æ ¹æ®ä¼˜åŒ–ç­–ç•¥è°ƒæ•´
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "ğŸš€ åº”ç”¨æé€Ÿä¼˜åŒ–"
            ;;
          "stability")  
            echo "ğŸ›¡ï¸ åº”ç”¨ç¨³å®šä¼˜åŒ–"
            echo "CONFIG_DEBUG_INFO=n" >> .config
            ;;
          *)
            echo "âš–ï¸ åº”ç”¨å¹³è¡¡ä¼˜åŒ–"
            ;;
        esac
        
        # è‡ªåŠ¨å¤„ç†é…ç½®ä¾èµ–
        yes "" | make oldconfig >/dev/null 2>&1 || true
        echo "âœ… é…ç½®ä¼˜åŒ–å®Œæˆ"

    - name: "ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾"
      timeout-minutes: 90
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
        
        # ç¼–è¯‘hostå·¥å…·
        make tools/compile -j$(nproc) || make tools/compile -j1
        
        # ç¼–è¯‘å·¥å…·é“¾
        make toolchain/compile -j$(nproc) || make toolchain/compile -j1
        
        echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"

    - name: "ğŸ“¦ å¤„ç†è‡ªå®šä¹‰åŠŸèƒ½"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "å¤„ç†è‡ªå®šä¹‰åŠŸèƒ½..."
        
        # é¢„ç¼–è¯‘IPKåŒ…
        IPK_DIR="firmware-config/custom-features/prebuilt-ipks"
        if [ -d "$IPK_DIR" ]; then
          mkdir -p package/base-files/files/usr/lib/opkg/custom
          find "$IPK_DIR" -name "*.ipk" -exec cp {} package/base-files/files/usr/lib/opkg/custom/ \;
          echo "âœ… IPKåŒ…å¤„ç†å®Œæˆ"
        fi
        
        # è‡ªå®šä¹‰è„šæœ¬
        SCRIPTS_DIR="firmware-config/custom-features/scripts"
        if [ -d "$SCRIPTS_DIR" ]; then
          for script in $(find "$SCRIPTS_DIR" -name "*.sh" | sort); do
            echo "æ‰§è¡Œè„šæœ¬: $(basename $script)"
            chmod +x "$script"
            timeout 300 bash "$script" || echo "âš ï¸ è„šæœ¬æ‰§è¡Œå¤±è´¥ä½†ç»§ç»­"
          done
        fi

    - name: "ğŸ” é¢„åˆ›å»ºç›®å½•ç»“æ„"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "é¢„åˆ›å»ºç¼–è¯‘ç›®å½•..."
        
        # åˆ›å»ºé€šç”¨ç›®å½•ç»“æ„
        mkdir -p build_dir/target-*/root-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev}
        mkdir -p build_dir/target-*/root.orig-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev}
        mkdir -p staging_dir/target-*/root-*/{tmp,etc,usr,lib,bin,sbin,var,proc,dev}
        
        # è®¾ç½®tmpç›®å½•æƒé™
        find build_dir staging_dir -name "tmp" -type d -exec chmod 1777 {} \; 2>/dev/null || true
        
        echo "âœ… ç›®å½•ç»“æ„é¢„åˆ›å»ºå®Œæˆ"

    - name: "ğŸ—ï¸ ç¼–è¯‘å›ºä»¶"
      timeout-minutes: 180
      id: compile
      run: |
        cd ${{ env.SOURCE_DIR }}
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
        echo "å·¥å…·é“¾: ${{ github.event.inputs.toolchain_strategy }}"
        
        CPU_CORES=$(nproc)
        
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "ğŸš€ æé€Ÿæ¨¡å¼ç¼–è¯‘..."
            make -j$CPU_CORES
            ;;
          "stability")
            echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼ç¼–è¯‘..."
            make -j1 V=s
            ;;
          *)
            echo "âš–ï¸ å¹³è¡¡æ¨¡å¼ç¼–è¯‘..."
            make -j$((CPU_CORES / 2)) V=s
            ;;
        esac
        
        if [ $? -eq 0 ]; then
          echo "BUILD_STATUS=success" >> $GITHUB_ENV
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
        else
          echo "BUILD_STATUS=failed" >> $GITHUB_ENV
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi

    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      if: env.BUILD_STATUS == 'success'
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "æ”¶é›†ç¼–è¯‘äº§ç‰©..."
        
        mkdir -p ${{ env.ARTIFACTS_DIR }}
        
        # å¤åˆ¶å›ºä»¶æ–‡ä»¶
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) \
          -exec cp --parents {} ${{ env.ARTIFACTS_DIR }}/ \; 2>/dev/null || true
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp .config ${{ env.ARTIFACTS_DIR }}/ 2>/dev/null || true
        
        # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        {
          echo "=== å›ºä»¶æ„å»ºæŠ¥å‘Š ==="
          echo "æ„å»ºæ—¶é—´: $(date)"
          echo "æºç åº“: ${{ env.SOURCE_PRESET }}"
          echo "æºç åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}"
          echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "å·¥å…·é“¾ç­–ç•¥: ${{ github.event.inputs.toolchain_strategy }}"
          echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS }}"
        } > ${{ env.ARTIFACTS_DIR }}/build-report.txt
        
        # å¤åˆ¶åˆ°å·¥ä½œåŒº
        mkdir -p $GITHUB_WORKSPACE/artifacts
        cp -r ${{ env.ARTIFACTS_DIR }}/* $GITHUB_WORKSPACE/artifacts/ 2>/dev/null || true
        
        echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      if: env.BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}"
        path: artifacts
        retention-days: 7

    - name: "ğŸ§¹ æ¸…ç†ç¯å¢ƒ"
      if: always()
      run: |
        echo "æ¸…ç†ç¼–è¯‘ç¯å¢ƒ..."
        sudo swapoff /swapfile 2>/dev/null || true
        sudo rm -f /swapfile 2>/dev/null || true
        sudo rm -rf ${{ env.SOURCE_DIR }} 2>/dev/null || true
        sudo rm -rf ${{ env.ARTIFACTS_DIR }} 2>/dev/null || true
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

    - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "å·¥ä½œæµ: ${{ github.workflow }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "æºç åº“: ${{ env.SOURCE_PRESET }}"
        echo "åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
        echo "çŠ¶æ€: ${{ env.BUILD_STATUS || 'unknown' }}"
        
        if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸï¼äº§ç‰©å·²ä¸Šä¼ åˆ° Artifacts"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
