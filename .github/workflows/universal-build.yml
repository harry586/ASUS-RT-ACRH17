name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“ (ImmortalWrtåŠŸèƒ½ä¸°å¯Œ/OpenWrtå®˜æ–¹çº¯å‡€/LEDEé›†æˆåº¦é«˜)'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨æŒ‡å®šåˆ†æ”¯å)'
        required: true
        default: 'auto'
        type: string
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ - æŸ¥çœ‹ firmware-config/configs-list.md è·å–å¯ç”¨æ–‡ä»¶åˆ—è¡¨'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      build_optimization:
        description: 'ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥'
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: 'balanced'
      toolchain_strategy:
        description: 'å·¥å…·é“¾ç­–ç•¥ (prebuilt=é¢„ç¼–è¯‘æœ€å¿«/local=æœ¬åœ°ç¼–è¯‘æœ€ç¨³/auto=è‡ªåŠ¨é€‰æ‹©)'
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: 'auto'
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½ (è‡ªå®šä¹‰è„šæœ¬å’Œé¢„ç¼–è¯‘IPKåŒ…)'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  TERM: "linux"
  SOURCE_DIR: "/mnt/source"
  ARTIFACTS_DIR: "/mnt/artifacts"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»“åº“"
      uses: actions/checkout@v4

    - name: "ğŸ’¾ ç³»ç»Ÿèµ„æºåˆ†æä¸æ¸…ç†"
      run: |
        echo "=== ç³»ç»Ÿèµ„æºåˆ†æ ==="
        df -h
        echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
        free -h
        
        echo "ğŸ§¹ æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§äº¤æ¢æ–‡ä»¶..."
        # å®‰å…¨åœ°æ¸…ç†äº¤æ¢æ–‡ä»¶
        sudo swapoff /mnt/swapfile 2>/dev/null || true
        sudo swapoff /swapfile 2>/dev/null || true
        sudo rm -f /mnt/swapfile 2>/dev/null || true
        sudo rm -f /swapfile 2>/dev/null || true
        
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

    - name: "ğŸ”§ è®¾ç½®é«˜æ€§èƒ½å·¥ä½œç¯å¢ƒ"
      run: |
        echo "è®¾ç½®é«˜æ€§èƒ½ç¼–è¯‘ç¯å¢ƒ..."
        sudo mkdir -p ${{ env.SOURCE_DIR }}
        sudo mkdir -p ${{ env.ARTIFACTS_DIR }}
        sudo chown -R runner:runner ${{ env.SOURCE_DIR }}
        sudo chown -R runner:runner ${{ env.ARTIFACTS_DIR }}
        
        echo "ğŸ”„ å®‰å…¨åˆ›å»ºå¤§å®¹é‡äº¤æ¢æ–‡ä»¶..."
        # ä½¿ç”¨ddå‘½ä»¤æ›¿ä»£fallocateï¼Œé¿å…"Text file busy"é”™è¯¯
        sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=8192 status=progress
        sudo chmod 600 /mnt/swapfile
        sudo mkswap /mnt/swapfile
        sudo swapon /mnt/swapfile
        echo "âœ… 8GBäº¤æ¢æ–‡ä»¶å·²å¯ç”¨"
        
        echo "âš¡ ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½è®¾ç½®..."
        ulimit -n 65536
        export FORCE_UNSAFE_CONFIGURE=1

    - name: "ğŸ” æ£€æŸ¥ç›®å½•ç»“æ„"
      run: |
        echo "=== å½“å‰ç›®å½•ç»“æ„ ==="
        pwd
        ls -la
        echo "=== firmware-config ç›®å½•å†…å®¹ ==="
        ls -la firmware-config/
        echo "=== æ£€æŸ¥ repositories.json ==="
        if [ -f "firmware-config/repositories.json" ]; then
          echo "âœ… repositories.json å­˜åœ¨"
          cat firmware-config/repositories.json
        else
          echo "âŒ repositories.json ä¸å­˜åœ¨"
          echo "è¯·åœ¨ firmware-config ç›®å½•ä¸‹åˆ›å»º repositories.json æ–‡ä»¶"
          exit 1
        fi

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        echo "æ­£åœ¨è§£ææºç é…ç½®..."
        
        if [ ! -f "firmware-config/repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        PRESET="${{ github.event.inputs.source_preset }}"
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" firmware-config/repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
        fi
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
        echo "âœ… æºç é…ç½®: $PRESET - $DESCRIPTION, åˆ†æ”¯: $BRANCH"

    - name: "ğŸ§¹ å‡†å¤‡é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ"
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–åŒ…..."
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools rsync unzip zlib1g-dev file wget jq ccache
        
        echo "âš¡ è®¾ç½®ç¼–è¯‘ç¼“å­˜..."
        export CCACHE_DIR="/mnt/ccache"
        mkdir -p $CCACHE_DIR
        ccache -M 5G
        ccache -s
        
        echo "âœ… é«˜æ€§èƒ½æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: "ğŸ“¥ é«˜æ€§èƒ½æºç è·å–"
      id: clone-source
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“åˆ°é«˜é€Ÿåˆ†åŒº..."
        cd ${{ env.SOURCE_DIR }}
        
        CLONE_SUCCESS=false
        echo "ğŸ” å°è¯•ä½¿ç”¨é¦–é€‰åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        
        if git clone --depth 1 --branch "${{ env.SOURCE_BRANCH }}" "${{ env.SOURCE_URL }}" . 2>/dev/null; then
          echo "âœ… ä½¿ç”¨é¦–é€‰åˆ†æ”¯å…‹éš†æˆåŠŸ"
          CLONE_SUCCESS=true
          ACTUAL_BRANCH="${{ env.SOURCE_BRANCH }}"
        else
          echo "âš ï¸ å°è¯•å¤‡é€‰åˆ†æ”¯..."
          if [ "${{ env.SOURCE_BRANCH }}" = "main" ]; then
            ALTERNATIVE_BRANCH="master"
          else
            ALTERNATIVE_BRANCH="main"
          fi
          
          if git clone --depth 1 --branch "$ALTERNATIVE_BRANCH" "${{ env.SOURCE_URL }}" . 2>/dev/null; then
            echo "âœ… ä½¿ç”¨å¤‡é€‰åˆ†æ”¯å…‹éš†æˆåŠŸ"
            CLONE_SUCCESS=true
            ACTUAL_BRANCH="$ALTERNATIVE_BRANCH"
          else
            if git clone --depth 1 "${{ env.SOURCE_URL }}" . 2>/dev/null; then
              echo "âœ… æ— åˆ†æ”¯å…‹éš†æˆåŠŸ"
              CLONE_SUCCESS=true
              ACTUAL_BRANCH=$(git branch --show-current)
            fi
          fi
        fi
        
        if [ "$CLONE_SUCCESS" = "false" ]; then
          echo "âŒ å…‹éš†å¤±è´¥"
          exit 1
        fi
        
        echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
        echo "âœ… æºç å…‹éš†å®Œæˆ: $ACTUAL_BRANCH"

    - name: "ğŸ’¾ æºç å…‹éš†åç©ºé—´æ£€æŸ¥"
      run: |
        echo "=== æºç å…‹éš†åç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
        df -h
        
        # æ£€æŸ¥å¯ç”¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿç»§ç»­ç¼–è¯‘
        AVAILABLE_GB=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
        echo "å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}GB"
        
        if [ "$AVAILABLE_GB" -lt 20 ]; then
          echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´ä¸è¶³20GBï¼Œç¼–è¯‘å¯èƒ½ä¼šå¤±è´¥"
          echo "ğŸ’¡ å»ºè®®: æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶æˆ–ä½¿ç”¨æ›´ç²¾ç®€çš„é…ç½®"
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³"
        fi

    - name: "ğŸ”§ æºç åˆå§‹åŒ–ä¸ä¼˜åŒ–"
      timeout-minutes: 30
      id: feeds-update
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        START_TIME=$(date +%s)
        echo "å¼€å§‹æºç åˆå§‹åŒ–..."
        
        echo "æ­¥éª¤1: å¹¶è¡Œæ›´æ–°feeds..."
        ./scripts/feeds update -a &
        ./scripts/feeds update packages &
        ./scripts/feeds update luci &
        wait
        
        echo "æ­¥éª¤2: å®‰è£…feeds..."
        ./scripts/feeds install -a
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        # è®°å½•æ—¶é•¿ï¼ˆå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼‰
        if [ "$DURATION" -gt 600 ]; then  # è¶…è¿‡10åˆ†é’Ÿ
          echo "â±ï¸ Feedsæ›´æ–°è€—æ—¶: ${DURATION}ç§’ (è¾ƒé•¿)"
          echo "feeds_duration=$DURATION" >> $GITHUB_ENV
        elif [ "$DURATION" -gt 300 ]; then  # è¶…è¿‡5åˆ†é’Ÿ
          echo "â±ï¸ Feedsæ›´æ–°è€—æ—¶: ${DURATION}ç§’"
        fi
        
        echo "âœ… Feedsæ›´æ–°å®Œæˆ"

    - name: "ğŸ¨ åº”ç”¨é…ç½®"
      run: |
        cd ${{ env.SOURCE_DIR }}
        CONFIG_FILE="$GITHUB_WORKSPACE/firmware-config/${{ github.event.inputs.config_profile }}"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: "ğŸ”§ æ€§èƒ½ä¼˜åŒ–é…ç½®"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "åº”ç”¨æ€§èƒ½ä¼˜åŒ–é…ç½®..."
        
        # ç¦ç”¨è°ƒè¯•ä¿¡æ¯ä»¥åŠ é€Ÿç¼–è¯‘
        sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_BUILD_LOG=y/# CONFIG_BUILD_LOG is not set/' .config 2>/dev/null || true
        
        # å¯ç”¨ccacheåŠ é€Ÿ
        echo "CONFIG_CCACHE=y" >> .config
        
        yes "" | make oldconfig >/dev/null 2>&1 || true
        echo "âœ… æ€§èƒ½ä¼˜åŒ–é…ç½®å®Œæˆ"

    - name: "ğŸ› ï¸ è®¾ç½®å·¥å…·é“¾ç­–ç•¥"
      id: toolchain-setup
      timeout-minutes: 45
      run: |
        cd ${{ env.SOURCE_DIR }}
        
        START_TIME=$(date +%s)
        
        STRATEGY="${{ github.event.inputs.toolchain_strategy }}"
        echo "å·¥å…·é“¾ç­–ç•¥: $STRATEGY"
        
        # ä½¿ç”¨æ›´å¤šçº¿ç¨‹ç¼–è¯‘å·¥å…·é“¾
        case $STRATEGY in
          "prebuilt")
            echo "ğŸ”§ ä½¿ç”¨é¢„ç¼–è¯‘å·¥å…·é“¾..."
            if make tools/install toolchain/install -j$(nproc); then
              echo "âœ… é¢„ç¼–è¯‘å·¥å…·é“¾å®‰è£…æˆåŠŸ"
              echo "result=prebuilt" >> $GITHUB_OUTPUT
            else
              echo "âŒ é¢„ç¼–è¯‘å·¥å…·é“¾å®‰è£…å¤±è´¥"
              echo "result=local" >> $GITHUB_OUTPUT
            fi
            ;;
          "local"|*)
            echo "ğŸ”§ ä½¿ç”¨æœ¬åœ°ç¼–è¯‘å·¥å…·é“¾..."
            echo "result=local" >> $GITHUB_OUTPUT
            ;;
        esac
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        # è®°å½•æ—¶é•¿ï¼ˆå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼‰
        if [ "$DURATION" -gt 1200 ]; then  # è¶…è¿‡20åˆ†é’Ÿ
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ (è¾ƒé•¿)"
          echo "toolchain_duration=$DURATION" >> $GITHUB_ENV
        elif [ "$DURATION" -gt 600 ]; then  # è¶…è¿‡10åˆ†é’Ÿ
          echo "â±ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’"
        fi

    - name: "ğŸ“¦ å¤„ç†é¢„ç¼–è¯‘IPKåŒ…"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd ${{ env.SOURCE_DIR }}
        IPK_DIR="$GITHUB_WORKSPACE/firmware-config/custom-features/prebuilt-ipks"
        
        if [ -d "$IPK_DIR" ]; then
          IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f)
          if [ -n "$IPK_FILES" ]; then
            mkdir -p package/base-files/files/usr/lib/opkg/custom
            for ipk in $IPK_FILES; do
              echo "ğŸ“¥ å¤åˆ¶IPKåŒ…: $(basename "$ipk")"
              cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
            done
            echo "âœ… é¢„ç¼–è¯‘IPKåŒ…å¤„ç†å®Œæˆ"
          fi
        fi

    - name: "ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd ${{ env.SOURCE_DIR }}
        SCRIPTS_DIR="$GITHUB_WORKSPACE/firmware-config/custom-features/scripts"
        
        if [ -d "$SCRIPTS_DIR" ]; then
          for script in $(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort); do
            echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
            chmod +x "$script"
            bash "$script" || exit 1
          done
        fi

    - name: "ğŸ” éªŒè¯é…ç½®"
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "éªŒè¯é…ç½®æ–‡ä»¶..."
        make defconfig >/dev/null 2>&1
        echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

    - name: "ğŸ’¾ ç¼–è¯‘å‰å…³é”®ç©ºé—´æ£€æŸ¥"
      run: |
        echo "=== ç¼–è¯‘å‰å…³é”®ç©ºé—´æ£€æŸ¥ ==="
        echo "æ ¹åˆ†åŒº (/):"
        df -h /
        echo ""
        echo "æ•°æ®åˆ†åŒº (/mnt):"
        df -h /mnt
        
        # æ£€æŸ¥å¯ç”¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿç¼–è¯‘
        AVAILABLE_GB=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
        echo ""
        echo "å¯ç”¨ç©ºé—´: ${AVAILABLE_GB}GB"
        
        if [ "$AVAILABLE_GB" -lt 15 ]; then
          echo "âŒ é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³15GBï¼Œæ— æ³•å®‰å…¨ç¼–è¯‘"
          echo "ğŸ’¡ å»ºè®®:"
          echo "  - æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶"
          echo "  - ä½¿ç”¨æ›´ç²¾ç®€çš„é…ç½®æ–‡ä»¶"
          echo "  - ç¦ç”¨éƒ¨åˆ†è‡ªå®šä¹‰åŠŸèƒ½"
          exit 1
        elif [ "$AVAILABLE_GB" -lt 25 ]; then
          echo "âš ï¸ è­¦å‘Š: ç£ç›˜ç©ºé—´ç´§å¼  (${AVAILABLE_GB}GB)ï¼Œç¼–è¯‘å¯èƒ½ä¼šå¤±è´¥"
        else
          echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼Œå¯ä»¥å¼€å§‹ç¼–è¯‘"
        fi

    - name: "ğŸ—ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶ - é€Ÿåº¦ä¸è¯Šæ–­å…¼é¡¾"
      timeout-minutes: 180
      id: compile-firmware
      run: |
        cd ${{ env.SOURCE_DIR }}
        export TERM=linux
        export FORCE_UNSAFE_CONFIGURE=1
        
        # è®¾ç½®æ€§èƒ½ä¼˜åŒ–ç¯å¢ƒ
        export CCACHE_DIR="/mnt/ccache"
        export CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros
        export CCACHE_MAXSIZE=5G
        
        # è·å–CPUæ ¸å¿ƒæ•°
        CPU_CORES=$(nproc)
        echo "ğŸ’» å¯ç”¨CPUæ ¸å¿ƒæ•°: $CPU_CORES"
        
        # åˆ›å»ºç¼–è¯‘æ—¥å¿—ç›®å½•
        mkdir -p /tmp/build-logs
        
        START_TIME=$(date +%s)
        
        echo "ğŸš€ å¼€å§‹æ™ºèƒ½ç¼–è¯‘ (é€Ÿåº¦ä¸è¯Šæ–­å…¼é¡¾)..."
        echo "ğŸ“Š ç¼–è¯‘å‚æ•°:"
        echo "  - å·¥å…·é“¾ç­–ç•¥: ${{ steps.toolchain-setup.outputs.result }}"
        echo "  - ç¼–è¯‘ä¼˜åŒ–: ${{ github.event.inputs.build_optimization }}"
        echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
        echo "  - å®é™…åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
        echo "  - CPUæ ¸å¿ƒ: $CPU_CORES"
        echo "  - CCACHE: å·²å¯ç”¨ (5GBç¼“å­˜)"
        
        # æ™ºèƒ½ç¼–è¯‘ç­–ç•¥
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "ğŸš€ æé€Ÿæ¨¡å¼: ä½¿ç”¨ $CPU_CORES çº¿ç¨‹ + æ™ºèƒ½é”™è¯¯æ•è·"
            {
              echo "ğŸ“¦ é˜¶æ®µ1: å¿«é€Ÿç¼–è¯‘æ‰€æœ‰åŒ…"
              make -j$CPU_CORES CC="ccache gcc" CXX="ccache g++" 2>&1
            } | tee /tmp/build-logs/speed.log
            
            if [ ${PIPESTATUS[0]} -eq 0 ]; then
              echo "âœ… æé€Ÿç¼–è¯‘æˆåŠŸ!"
            else
              echo "âŒ æé€Ÿç¼–è¯‘å¤±è´¥ï¼Œå¯ç”¨è¯Šæ–­..."
              echo "=== é”™è¯¯æ‘˜è¦ ==="
              grep -i "error\|failed" /tmp/build-logs/speed.log | tail -10
              exit 1
            fi
            ;;
          "stability")
            echo "ğŸ›¡ï¸ ç¨³å®šæ¨¡å¼: ä½¿ç”¨ $((CPU_CORES - 1)) çº¿ç¨‹ + è¯¦ç»†è¾“å‡º"
            make -j$((CPU_CORES - 1)) V=s CC="ccache gcc" CXX="ccache g++" 2>&1 | tee /tmp/build-logs/stability.log
            ;;
          "balanced"|*)
            echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: ä½¿ç”¨ $CPU_CORES çº¿ç¨‹ + åˆ†é˜¶æ®µä¼˜åŒ–"
            {
              # é˜¶æ®µ1: å·¥å…·é“¾å’ŒåŸºç¡€åŒ… - å¿«é€Ÿç¼–è¯‘
              echo "ğŸ“¦ é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾å’ŒåŸºç¡€åŒ… (å¿«é€Ÿæ¨¡å¼)"
              PHASE1_START=$(date +%s)
              make tools/compile toolchain/compile -j$CPU_CORES CC="ccache gcc" CXX="ccache g++" 2>&1
              PHASE1_END=$(date +%s)
              PHASE1_DURATION=$((PHASE1_END - PHASE1_START))
              echo "é˜¶æ®µ1å®Œæˆï¼Œè€—æ—¶: ${PHASE1_DURATION}ç§’"
              
              # é˜¶æ®µ1åç©ºé—´æ£€æŸ¥
              echo "=== é˜¶æ®µ1åç£ç›˜ç©ºé—´ ==="
              df -h /mnt
              
              # é˜¶æ®µ2: å†…æ ¸å’Œå…³é”®åŒ… - è¯¦ç»†è¾“å‡º
              echo "ğŸ”§ é˜¶æ®µ2: ç¼–è¯‘å†…æ ¸å’Œå…³é”®åŒ… (è¯¦ç»†æ¨¡å¼)"
              PHASE2_START=$(date +%s)
              make target/linux/compile package/kernel/linux/compile -j$CPU_CORES V=s CC="ccache gcc" CXX="ccache g++" 2>&1
              PHASE2_END=$(date +%s)
              PHASE2_DURATION=$((PHASE2_END - PHASE2_START))
              echo "é˜¶æ®µ2å®Œæˆï¼Œè€—æ—¶: ${PHASE2_DURATION}ç§’"
              
              # é˜¶æ®µ2åç©ºé—´æ£€æŸ¥
              echo "=== é˜¶æ®µ2åç£ç›˜ç©ºé—´ ==="
              df -h /mnt
              
              # é˜¶æ®µ3: å‰©ä½™åŒ… - å¿«é€Ÿç¼–è¯‘ä½†ç›‘æ§é”™è¯¯
              echo "ğŸ“¦ é˜¶æ®µ3: ç¼–è¯‘å‰©ä½™åŒ… (å¿«é€Ÿæ¨¡å¼ + é”™è¯¯ç›‘æ§)"
              PHASE3_START=$(date +%s)
              make package/compile -j$CPU_CORES CC="ccache gcc" CXX="ccache g++" 2>&1
              PHASE3_END=$(date +%s)
              PHASE3_DURATION=$((PHASE3_END - PHASE3_START))
              echo "é˜¶æ®µ3å®Œæˆï¼Œè€—æ—¶: ${PHASE3_DURATION}ç§’"
              
              # é˜¶æ®µ3åç©ºé—´æ£€æŸ¥
              echo "=== é˜¶æ®µ3åç£ç›˜ç©ºé—´ ==="
              df -h /mnt
              
              # é˜¶æ®µ4: æœ€ç»ˆç»„è£…
              echo "ğŸ”§ é˜¶æ®µ4: æœ€ç»ˆç»„è£…"
              PHASE4_START=$(date +%s)
              make target/install -j$CPU_CORES CC="ccache gcc" CXX="ccache g++" 2>&1
              PHASE4_END=$(date +%s)
              PHASE4_DURATION=$((PHASE4_END - PHASE4_START))
              echo "é˜¶æ®µ4å®Œæˆï¼Œè€—æ—¶: ${PHASE4_DURATION}ç§’"
              
            } | tee /tmp/build-logs/balanced.log
            
            # è®°å½•é˜¶æ®µæ—¶é•¿ï¼ˆå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼‰
            if [ "$PHASE1_DURATION" -gt 1200 ]; then
              echo "â±ï¸ é˜¶æ®µ1è€—æ—¶è¾ƒé•¿: ${PHASE1_DURATION}ç§’"
            fi
            if [ "$PHASE2_DURATION" -gt 1800 ]; then
              echo "â±ï¸ é˜¶æ®µ2è€—æ—¶è¾ƒé•¿: ${PHASE2_DURATION}ç§’"
            fi
            if [ "$PHASE3_DURATION" -gt 2400 ]; then
              echo "â±ï¸ é˜¶æ®µ3è€—æ—¶è¾ƒé•¿: ${PHASE3_DURATION}ç§’"
            fi
            
            # æ£€æŸ¥æœ€ç»ˆç»“æœ
            if [ ${PIPESTATUS[0]} -eq 0 ]; then
              echo "âœ… åˆ†é˜¶æ®µç¼–è¯‘æˆåŠŸ!"
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œåˆ†æé˜¶æ®µæ—¥å¿—..."
              # åˆ†æå“ªä¸ªé˜¶æ®µå¤±è´¥
              if grep -q "Error" /tmp/build-logs/balanced.log; then
                echo "=== å…³é”®é”™è¯¯ ==="
                grep -A5 -B5 "Error" /tmp/build-logs/balanced.log | tail -20
              fi
              exit 1
            fi
            ;;
        esac
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ $? -eq 0 ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆ!"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          
          # è¯¦ç»†çš„é”™è¯¯åˆ†æ
          echo "=== è¯¦ç»†é”™è¯¯åˆ†æ ==="
          for logfile in /tmp/build-logs/*.log; do
            if [ -f "$logfile" ]; then
              echo "åˆ†ææ—¥å¿—: $(basename $logfile)"
              echo "æœ€åé”™è¯¯:"
              tail -50 "$logfile" | grep -i "error\|failed" | tail -10 || echo "  æ— æ˜ç¡®é”™è¯¯ä¿¡æ¯"
              echo ""
            fi
          done
          
          # æ£€æŸ¥ç‰¹å®šåŒ…çš„ç¼–è¯‘çŠ¶æ€
          echo "=== åŒ…ç¼–è¯‘çŠ¶æ€æ£€æŸ¥ ==="
          for pkg in ath10k-ct samba4; do
            if find build_dir/ -name ".pkgdir_${pkg}" -o -name ".built_${pkg}" 2>/dev/null | grep -q .; then
              echo "âœ… $pkg: å·²ç¼–è¯‘"
            else
              echo "âŒ $pkg: æœªç¼–è¯‘æˆ–ç¼–è¯‘å¤±è´¥"
            fi
          done
          
          exit 1
        fi
        
        # æ˜¾ç¤ºccacheç»Ÿè®¡
        echo "ğŸ“Š CCache ç»Ÿè®¡:"
        ccache -s
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
        
        # è®°å½•ç¼–è¯‘æ€»æ—¶é•¿ï¼ˆå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼‰
        if [ "$DURATION" -gt 3600 ]; then  # è¶…è¿‡1å°æ—¶
          echo "â±ï¸ æ€»ç¼–è¯‘è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ) - è¾ƒé•¿"
        else
          echo "âœ… ç¼–è¯‘å®Œæˆ! è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"
        fi

    - name: "ğŸ’¾ ç¼–è¯‘åæœ€ç»ˆç©ºé—´æ£€æŸ¥"
      run: |
        echo "=== ç¼–è¯‘åæœ€ç»ˆç©ºé—´æ£€æŸ¥ ==="
        echo "æ ¹åˆ†åŒº (/):"
        df -h /
        echo ""
        echo "æ•°æ®åˆ†åŒº (/mnt):"
        df -h /mnt
        
        # è®¡ç®—ç©ºé—´ä½¿ç”¨å˜åŒ–
        echo ""
        echo "ğŸ“Š ç©ºé—´ä½¿ç”¨æ€»ç»“:"
        du -sh ${{ env.SOURCE_DIR }}/bin/ 2>/dev/null || echo "æ— æ³•è·å–è¾“å‡ºç›®å½•å¤§å°"

    - name: "ğŸ“‹ ç¼–è¯‘è¯Šæ–­æŠ¥å‘Š"
      if: always()
      run: |
        echo "=== ç¼–è¯‘è¯Šæ–­æŠ¥å‘Š ==="
        
        # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
        if ls /tmp/build-logs/*.log 2>/dev/null; then
          echo "ğŸ“ å¯ç”¨æ—¥å¿—æ–‡ä»¶:"
          ls -la /tmp/build-logs/
          
          # æ˜¾ç¤ºå…³é”®ç»Ÿè®¡
          for logfile in /tmp/build-logs/*.log; do
            echo ""
            echo "ğŸ“Š $(basename $logfile) ç»Ÿè®¡:"
            echo "  æ€»è¡Œæ•°: $(wc -l < "$logfile")"
            echo "  é”™è¯¯æ•°: $(grep -c "Error" "$logfile" || echo 0)"
            echo "  è­¦å‘Šæ•°: $(grep -c "Warning" "$logfile" || echo 0)"
            echo "  å¤±è´¥æ•°: $(grep -c "Failed" "$logfile" || echo 0)"
          done
        else
          echo "âš ï¸ æ— ç¼–è¯‘æ—¥å¿—æ–‡ä»¶"
        fi
        
        # æ˜¾ç¤ºè€—æ—¶ç»Ÿè®¡
        echo ""
        echo "â±ï¸ å…³é”®æ­¥éª¤è€—æ—¶ç»Ÿè®¡:"
        if [ -n "${{ env.feeds_duration }}" ] && [ "${{ env.feeds_duration }}" -gt 600 ]; then
          echo "  Feedsæ›´æ–°: ${{ env.feeds_duration }}ç§’ (è¾ƒé•¿)"
        fi
        if [ -n "${{ env.toolchain_duration }}" ] && [ "${{ env.toolchain_duration }}" -gt 1200 ]; then
          echo "  å·¥å…·é“¾ç¼–è¯‘: ${{ env.toolchain_duration }}ç§’ (è¾ƒé•¿)"
        fi
        if [ -n "${{ env.BUILD_DURATION }}" ] && [ "${{ env.BUILD_DURATION }}" -gt 3600 ]; then
          echo "  æ€»ç¼–è¯‘: ${{ env.BUILD_DURATION }}ç§’ ($((${{ env.BUILD_DURATION }}/60))åˆ†é’Ÿ) (è¾ƒé•¿)"
        fi

    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©å’Œè¯Šæ–­ä¿¡æ¯"
      if: success() || failure()
      run: |
        cd ${{ env.SOURCE_DIR }}
        echo "æ”¶é›†ç¼–è¯‘äº§ç‰©å’Œè¯Šæ–­ä¿¡æ¯..."
        
        mkdir -p ${{ env.ARTIFACTS_DIR }}
        
        # æ”¶é›†å›ºä»¶æ–‡ä»¶
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" \) -exec cp --parents {} ${{ env.ARTIFACTS_DIR }}/ \; 2>/dev/null || true
        
        # æ”¶é›†ç¼–è¯‘æ—¥å¿—
        cp -r /tmp/build-logs ${{ env.ARTIFACTS_DIR }}/ 2>/dev/null || true
        
        # æ”¶é›†é…ç½®ä¿¡æ¯
        cp .config ${{ env.ARTIFACTS_DIR }}/config 2>/dev/null || true
        
        # æ”¶é›†å…³é”®æ„å»ºçŠ¶æ€
        {
          echo "=== æ„å»ºçŠ¶æ€æŠ¥å‘Š ==="
          echo "æ„å»ºæ—¶é—´: $(date)"
          echo "ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION || 'N/A' }}ç§’"
          echo "æºç åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
          echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
          echo "ä¼˜åŒ–ç­–ç•¥: ${{ github.event.inputs.build_optimization }}"
          echo "å·¥å…·é“¾: ${{ steps.toolchain-setup.outputs.result }}"
          echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
          echo ""
          echo "=== è€—æ—¶ç»Ÿè®¡ ==="
          if [ -n "${{ env.feeds_duration }}" ]; then
            echo "Feedsæ›´æ–°: ${{ env.feeds_duration }}ç§’"
          fi
          if [ -n "${{ env.toolchain_duration }}" ]; then
            echo "å·¥å…·é“¾ç¼–è¯‘: ${{ env.toolchain_duration }}ç§’"
          fi
          if [ -n "${{ env.BUILD_DURATION }}" ]; then
            echo "æ€»ç¼–è¯‘: ${{ env.BUILD_DURATION }}ç§’"
          fi
          echo ""
          echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
          find bin/targets -type f 2>/dev/null | sort || echo "æ— æ³•åˆ—å‡ºæ–‡ä»¶"
        } > ${{ env.ARTIFACTS_DIR }}/build-report.txt
        
        # å¤åˆ¶åˆ°å·¥ä½œç›®å½•
        mkdir -p $GITHUB_WORKSPACE/artifacts
        cp -r ${{ env.ARTIFACTS_DIR }}/* $GITHUB_WORKSPACE/artifacts/ 2>/dev/null || true
        
        echo "âœ… äº§ç‰©å’Œè¯Šæ–­ä¿¡æ¯æ”¶é›†å®Œæˆ"

    - name: "ğŸ§¹ å®‰å…¨æ¸…ç†ç¯å¢ƒ"
      if: always()
      run: |
        echo "å®‰å…¨æ¸…ç†ç¼–è¯‘ç¯å¢ƒ..."
        # å…ˆç¦ç”¨äº¤æ¢æ–‡ä»¶å†åˆ é™¤
        sudo swapoff /mnt/swapfile 2>/dev/null || true
        sudo rm -rf ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} /mnt/ccache /mnt/swapfile 2>/dev/null || true
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}-${{ env.ACTUAL_BRANCH }}"
        path: artifacts
        retention-days: 30

    - name: "ğŸ“Š æ™ºèƒ½ç¼–è¯‘æŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æ™ºèƒ½ç¼–è¯‘æŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æºç : ${{ env.SOURCE_URL }}"
        echo "åˆ†æ”¯: ${{ env.ACTUAL_BRANCH }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
          echo "â±ï¸ ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’"
          echo "âš¡ æ€§èƒ½ç‰¹æ€§:"
          echo "  - ä½¿ç”¨ /mnt åˆ†åŒº (66G ç©ºé—´)"
          echo "  - 8GB äº¤æ¢æ–‡ä»¶"
          echo "  - CCache ç¼–è¯‘ç¼“å­˜"
          echo "  - æ™ºèƒ½å¤šçº¿ç¨‹ç¼–è¯‘"
          echo "  - åˆ†é˜¶æ®µé”™è¯¯è¯Šæ–­"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "ğŸ” è¯Šæ–­ä¿¡æ¯å·²æ”¶é›†åˆ°Artifactsä¸­"
          echo "ğŸ’¡ æŸ¥çœ‹ build-logs/ ç›®å½•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
        
        # æ˜¾ç¤ºè€—æ—¶è­¦å‘Š
        echo ""
        echo "â±ï¸ è€—æ—¶åˆ†æ:"
        if [ -n "${{ env.feeds_duration }}" ] && [ "${{ env.feeds_duration }}" -gt 600 ]; then
          echo "  âš ï¸ Feedsæ›´æ–°è€—æ—¶è¾ƒé•¿: ${{ env.feeds_duration }}ç§’"
        fi
        if [ -n "${{ env.toolchain_duration }}" ] && [ "${{ env.toolchain_duration }}" -gt 1200 ]; then
          echo "  âš ï¸ å·¥å…·é“¾ç¼–è¯‘è€—æ—¶è¾ƒé•¿: ${{ env.toolchain_duration }}ç§’"
        fi
        if [ -n "${{ env.BUILD_DURATION }}" ] && [ "${{ env.BUILD_DURATION }}" -gt 3600 ]; then
          echo "  âš ï¸ æ€»ç¼–è¯‘è€—æ—¶è¾ƒé•¿: ${{ env.BUILD_DURATION }}ç§’"
        fi
