name: Universal Firmware Builder - Optimized File Discovery

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 选择源码库
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: immortalwrt
      source_branch:
        description: 源码分支 (auto=自动推荐稳定分支，或指定 main/master/具体分支名)
        required: true
        default: auto
        type: string
      config_profile:
        description: 设备配置文件路径 (支持通配符如 .config_* 或具体文件名)
        required: true
        type: string
        default: .config_rt-ac42u_immortalwrt
      build_optimization:
        description: 编译优化策略
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: balanced
      toolchain_strategy:
        description: 工具链策略
        required: true
        type: choice
        options:
          - prebuilt
          - local
          - auto
        default: auto
      enable_custom_features:
        description: 启用自定义功能
        required: false
        default: true
        type: boolean

env:
  TZ: Asia/Shanghai
  SOURCE_DIR: /mnt/source
  ARTIFACTS_DIR: /mnt/artifacts
  CCACHE_DIR: /mnt/ccache
  BUILD_LOG_DIR: /mnt/build-logs
  TOOLCHAIN_LOG_DIR: /mnt/toolchain-logs

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: 📥 检出配置仓库
        uses: actions/checkout@v4
        with:
          path: .
          fetch-depth: 0

      - name: 💾 智能系统资源分析
        timeout-minutes: 2
        run: |
          echo "=== 智能系统资源分析 ==="
          echo "📊 磁盘空间:"
          df -h
          echo ""
          echo "💻 CPU 信息:"
          echo "核心数: $(nproc)"
          echo "架构: $(uname -m)"
          echo "CPU 型号: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | sed 's/^ *//')"
          echo ""
          echo "🧠 内存信息:"
          free -h
          echo ""
          echo "📁 关键目录状态:"
          for dir in /tmp /mnt /home/runner /opt /var /usr; do
            if [ -d "$dir" ]; then
              mount_point=$(df "$dir" 2>/dev/null | awk 'NR==2 {print $6}')
              usage=$(df -h "$dir" 2>/dev/null | awk 'NR==2 {print $5}')
              available=$(df -h "$dir" 2>/dev/null | awk 'NR==2 {print $4}')
              echo "  $dir: 挂载点=$mount_point, 使用率=$usage, 可用=$available"
            else
              echo "  $dir: 目录不存在"
            fi
          done
          echo ""
          echo "🔄 交换空间: $(swapon --show | wc -l 2>/dev/null || echo 0) 个交换文件"
          echo ""
          echo "✅ 资源分析完成 - 系统就绪"

      - name: 🔧 全面工作环境设置
        run: |
          echo "设置全面编译环境..."
          
          # 清理根分区空间
          echo "🧹 清理根分区临时空间..."
          sudo rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          
          # 在 /mnt 创建所有必要目录
          echo "📁 在 /mnt 创建目录结构..."
          sudo mkdir -p ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          
          # 设置所有权和权限
          echo "🔒 设置目录权限..."
          sudo chown -R $USER:$USER ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          sudo chmod -R 755 ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }}
          sudo chmod -R 777 ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}
          
          # 验证目录创建
          echo "🔍 验证目录创建..."
          for dir in ${{ env.SOURCE_DIR }} ${{ env.ARTIFACTS_DIR }} ${{ env.CCACHE_DIR }} ${{ env.BUILD_LOG_DIR }} ${{ env.TOOLCHAIN_LOG_DIR }}; do
            if [ -d "$dir" ]; then
              echo "✅ $dir: 创建成功"
              dir_df=$(df -h "$dir" | awk 'NR==2')
              echo "   所在分区: $dir_df"
            else
              echo "❌ $dir: 创建失败"
              exit 1
            fi
          done
          
          # 修复交换文件创建问题
          echo "🔄 在 /mnt 创建高性能交换文件..."
          if [ -f /mnt/swapfile ]; then
            echo "🔍 发现现有交换文件，正在清理..."
            sudo swapoff /mnt/swapfile 2>/dev/null || true
            sudo rm -f /mnt/swapfile 2>/dev/null || true
            sleep 2
          fi
          
          # 创建新的交换文件
          echo "📝 创建新的交换文件..."
          sudo dd if=/dev/zero of=/mnt/swapfile bs=1M count=8192 status=progress || sudo fallocate -l 8G /mnt/swapfile || sudo truncate -s 8G /mnt/swapfile
          
          # 设置权限和启用交换
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          
          echo "📊 交换空间状态:"
          sudo swapon --show
          free -h
          
          echo "⚡ 优化系统性能设置..."
          ulimit -n 65536
          sudo sysctl -w vm.swappiness=60 2>/dev/null || echo "⚠️ 无法设置swappiness（非关键错误）"
          sudo sysctl -w vm.vfs_cache_pressure=50 2>/dev/null || echo "⚠️ 无法设置vfs_cache_pressure（非关键错误）"
          
          echo "🔧 设置环境变量..."
          export FORCE_UNSAFE_CONFIGURE=1
          export TERM=xterm-256color
          
          # 显示设置后的空间状态
          echo ""
          echo "📊 设置后磁盘空间状态:"
          df -h

      - name: 🔍 快速文件发现与配置分析
        id: file-discovery
        timeout-minutes: 3
        run: |
          echo "=== 快速文件发现与配置分析 ==="
          echo "🔍 高效分析仓库结构..."
          
          # 1. 快速查找 repositories.json
          echo ""
          echo "📋 快速查找 repositories.json 文件..."
          REPO_JSON_FOUND=$(find . -maxdepth 3 -name "repositories.json" -type f 2>/dev/null | head -1)
          if [ -n "$REPO_JSON_FOUND" ]; then
            echo "✅ 找到 repositories.json: $REPO_JSON_FOUND"
            echo "REPO_JSON_PATH=$REPO_JSON_FOUND" >> $GITHUB_ENV
            
            # 分析 repositories.json 内容
            echo "📊 repositories.json 内容分析:"
            jq -r '.repositories | keys[] as $k | "  - \($k): \(.[$k].description // "无描述")"' "$REPO_JSON_FOUND" 2>/dev/null || echo "无法解析JSON内容"
          else
            echo "❌ 未找到 repositories.json 文件"
            echo "当前目录结构:"
            ls -la
            echo "JSON文件搜索:"
            find . -maxdepth 2 -name "*.json" -type f 2>/dev/null | head -10 || echo "无JSON文件"
            exit 1
          fi
          
          # 2. 快速查找配置文件（限制深度）
          echo ""
          echo "📋 快速配置文件扫描..."
          CONFIG_PATTERNS=(".config_*" "config_*")
          ALL_CONFIG_FILES=""
          for pattern in "${CONFIG_PATTERNS[@]}"; do
            echo "搜索模式: $pattern"
            found_files=$(find . -maxdepth 3 -name "$pattern" -type f 2>/dev/null | head -10)
            if [ -n "$found_files" ]; then
              ALL_CONFIG_FILES="$ALL_CONFIG_FILES"$'\n'"$found_files"
              echo "找到文件:"
              echo "$found_files"
            fi
          done
          
          if [ -n "$ALL_CONFIG_FILES" ]; then
            CONFIG_COUNT=$(echo "$ALL_CONFIG_FILES" | grep -v '^$' | wc -l)
            echo "✅ 总共找到 $CONFIG_COUNT 个配置文件"
            echo "CONFIG_FILES_FOUND=true" >> $GITHUB_ENV
            echo "$ALL_CONFIG_FILES" > ${{ env.BUILD_LOG_DIR }}/all_config_files.txt
          else
            echo "⚠️ 未找到任何配置文件"
            echo "CONFIG_FILES_FOUND=false" >> $GITHUB_ENV
          fi
          
          # 3. 快速查找自定义功能目录
          echo ""
          echo "📋 快速查找自定义功能目录..."
          CUSTOM_DIR_PATTERNS=("custom-features" "custom" "features" "firmware-config")
          CUSTOM_FEATURES_DIR=""
          for pattern in "${CUSTOM_DIR_PATTERNS[@]}"; do
            echo "搜索目录: $pattern"
            found_dir=$(find . -maxdepth 2 -type d -name "$pattern" 2>/dev/null | head -1)
            if [ -n "$found_dir" ]; then
              CUSTOM_FEATURES_DIR="$found_dir"
              echo "✅ 找到自定义功能目录: $found_dir"
              break
            fi
          done
          
          if [ -n "$CUSTOM_FEATURES_DIR" ]; then
            echo "CUSTOM_FEATURES_DIR=$CUSTOM_FEATURES_DIR" >> $GITHUB_ENV
            echo "🔍 自定义目录快速分析:"
            ls -la "$CUSTOM_FEATURES_DIR" | head -10
          else
            echo "ℹ️ 未找到自定义功能目录"
            echo "CUSTOM_FEATURES_DIR=" >> $GITHUB_ENV
          fi
          
          echo ""
          echo "📁 快速目录结构分析:"
          echo "顶层目录:"
          ls -la
          echo ""
          echo "关键文件统计:"
          echo "  - 配置文件: $(find . -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | wc -l)"
          echo "  - 脚本文件: $(find . -maxdepth 3 -name "*.sh" 2>/dev/null | wc -l)"
          
          echo "✅ 快速文件发现完成"

      - name: 🔧 智能源码配置解析
        id: source-config
        run: |
          echo "正在智能解析源码配置..."
          PRESET="${{ github.event.inputs.source_preset }}"
          echo "使用的预设: $PRESET"
          REPO_JSON_PATH="${{ env.REPO_JSON_PATH }}"
          
          if ! jq -e ".repositories.$PRESET" "$REPO_JSON_PATH" >/dev/null 2>&1; then
            echo "❌ 错误: 预设 '$PRESET' 不存在"
            echo "可用的预设:"
            jq -r '.repositories | keys[]' "$REPO_JSON_PATH"
            exit 1
          fi
          
          SOURCE_URL=$(jq -r ".repositories.$PRESET.url" "$REPO_JSON_PATH")
          DESCRIPTION=$(jq -r ".repositories.$PRESET.description // \"未知\"" "$REPO_JSON_PATH")
          RECOMMENDED_BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch" "$REPO_JSON_PATH")
          echo "✅ 成功获取配置信息"
          
          BRANCH="${{ github.event.inputs.source_branch }}"
          if [ "$BRANCH" = "auto" ]; then
            BRANCH="$RECOMMENDED_BRANCH"
            echo "🤖 自动选择推荐分支: $BRANCH"
          else
            echo "📋 使用指定分支: $BRANCH"
          fi
          
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "SOURCE_PRESET=$PRESET" >> $GITHUB_ENV
          echo "RECOMMENDED_BRANCH=$RECOMMENDED_BRANCH" >> $GITHUB_ENV
          
          echo ""
          echo "✅ 源码配置解析完成"
          echo "📊 配置详情:"
          echo "  - 预设: $PRESET"
          echo "  - 描述: $DESCRIPTION"
          echo "  - 仓库: $SOURCE_URL"
          echo "  - 分支: $BRANCH"
          echo "  - 推荐分支: $RECOMMENDED_BRANCH"

      - name: 🛠️ 全面编译依赖安装与验证
        run: |
          echo "安装全面编译依赖包..."
          sudo apt-get update
          echo "📦 安装基础编译工具..."
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          echo "📦 安装开发库..."
          sudo apt-get install -y gettext git libncurses5-dev libssl-dev python3 python3-pip python3-setuptools
          echo "📦 安装工具链依赖..."
          sudo apt-get install -y rsync unzip zlib1g-dev file wget jq ccache m4 help2man texinfo texi2html
          echo "📦 安装构建工具..."
          sudo apt-get install -y libtool-bin automake autoconf pkg-config subversion mercurial curl cmake ninja-build
          echo "📦 安装系统库..."
          sudo apt-get install -y libelf-dev libssl-dev zlib1g-dev libc6-dev libxml2-dev liblzma-dev liblzo2-dev
          echo "🔍 依赖安装验证..."
          echo "=== 关键工具验证 ==="
          for tool in gcc g++ make flex bison git curl wget; do
            if command -v $tool >/dev/null 2>&1; then
              version=$($tool --version 2>/dev/null | head -1 | cut -d' ' -f1-4 | tr -d '\n' || echo "可用")
              echo "✅ $tool: $version"
            else
              echo "❌ $tool: 未安装"
              exit 1
            fi
          done
          echo "✅ 所有依赖安装和验证完成"

      - name: ⚡ 高级缓存与性能优化
        run: |
          echo "设置高级缓存与性能优化..."
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M 16G
          ccache -o compression=true
          ccache -o compression_level=6
          ccache -o max_files=200000
          ccache -o sloppiness=file_macro,include_file_mtime,include_file_ctime,time_macros
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=16G" >> $GITHUB_ENV
          echo "CCACHE_SLOPPINESS=file_macro,include_file_mtime,include_file_ctime,time_macros" >> $GITHUB_ENV
          echo "📊 初始CCache统计:"
          ccache -s
          echo "✅ 缓存与性能优化完成"

      - name: 📥 智能源码获取与分支处理
        id: clone-source
        timeout-minutes: 15
        run: |
          echo "开始智能源码获取与分支处理..."
          cd ${{ env.SOURCE_DIR }}
          REQUESTED_BRANCH="${{ env.SOURCE_BRANCH }}"
          SOURCE_URL="${{ env.SOURCE_URL }}"
          echo "🎯 请求分支: $REQUESTED_BRANCH"
          echo "🎯 源码仓库: $SOURCE_URL"
          
          CLONE_STRATEGIES=()
          if [ "$REQUESTED_BRANCH" != "auto" ] && [ "$REQUESTED_BRANCH" != "main" ] && [ "$REQUESTED_BRANCH" != "master" ]; then
            CLONE_STRATEGIES+=("指定分支: git clone --depth 1 --branch $REQUESTED_BRANCH $SOURCE_URL .")
          fi
          CLONE_STRATEGIES+=("main分支: git clone --depth 1 --branch main $SOURCE_URL ." "master分支: git clone --depth 1 --branch master $SOURCE_URL ." "默认分支: git clone --depth 1 $SOURCE_URL .")
          
          if [ "$REQUESTED_BRANCH" = "auto" ]; then
            RECOMMENDED_BRANCH="${{ env.RECOMMENDED_BRANCH }}"
            if [ -n "$RECOMMENDED_BRANCH" ] && [ "$RECOMMENDED_BRANCH" != "null" ]; then
              CLONE_STRATEGIES=("推荐分支: git clone --depth 1 --branch $RECOMMENDED_BRANCH $SOURCE_URL ." "${CLONE_STRATEGIES[@]}")
            fi
          fi
          
          CLONE_SUCCESS=false
          CLONE_ERROR=""
          ACTUAL_BRANCH=""
          
          for strategy in "${CLONE_STRATEGIES[@]}"; do
            strategy_name=$(echo "$strategy" | cut -d: -f1)
            clone_cmd=$(echo "$strategy" | cut -d: -f2-)
            echo ""
            echo "🔄 尝试策略: $strategy_name"
            echo "命令: $clone_cmd"
            rm -rf .[!.]* * 2>/dev/null || true
            
            if eval $clone_cmd 2>&1 | tee ${{ env.BUILD_LOG_DIR }}/clone.log; then
              if [ -d ".git" ]; then
                ACTUAL_BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
                COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                echo "✅ 克隆成功: $strategy_name"
                echo "📋 实际分支: $ACTUAL_BRANCH"
                echo "🔗 提交哈希: $COMMIT_HASH"
                CLONE_SUCCESS=true
                break
              else
                CLONE_ERROR="Git目录未创建"
                echo "⚠️ Git目录未创建，继续尝试其他策略..."
              fi
            else
              CLONE_ERROR="克隆命令执行失败"
              echo "❌ 策略失败: $strategy_name"
              if [ -f "${{ env.BUILD_LOG_DIR }}/clone.log" ]; then
                echo "克隆错误详情:"
                tail -20 ${{ env.BUILD_LOG_DIR }}/clone.log
              fi
            fi
          done
          
          if [ "$CLONE_SUCCESS" = "false" ]; then
            echo "❌ 所有克隆策略都失败"
            echo "🔍 最后尝试的克隆日志:"
            cat ${{ env.BUILD_LOG_DIR }}/clone.log 2>/dev/null || echo "无克隆日志"
            echo "错误: $CLONE_ERROR"
            exit 1
          fi
          
          echo "ACTUAL_BRANCH=$ACTUAL_BRANCH" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          
          echo ""
          echo "🔍 源码仓库快速验证..."
          echo "📁 源码目录结构:"
          ls -la | head -10
          echo ""
          echo "✅ 源码获取与验证完成"

      - name: 💾 源码获取后空间监测
        run: |
          echo "=== 源码获取后空间监测 ==="
          echo "📊 当前磁盘使用情况:"
          df -h
          ROOT_AVAILABLE=$(df / | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          MNT_AVAILABLE=$(df /mnt | awk 'NR==2 {gsub("G","",$4); print int($4)}')
          echo "根分区可用空间: ${ROOT_AVAILABLE}GB"
          echo "/mnt 分区可用空间: ${MNT_AVAILABLE}GB"
          if [ "$ROOT_AVAILABLE" -lt 2 ]; then
            echo "🚨 严重警告: 根分区空间不足2GB，可能影响系统稳定性"
          fi
          if [ "$MNT_AVAILABLE" -lt 10 ]; then
            echo "🚨 严重错误: /mnt 分区空间不足10GB，无法编译"
            exit 1
          elif [ "$MNT_AVAILABLE" -lt 20 ]; then
            echo "⚠️ 警告: /mnt 分区空间紧张 (${MNT_AVAILABLE}GB)"
          else
            echo "✅ /mnt 分区空间充足"
          fi

      - name: 🔄 智能源码初始化
        timeout-minutes: 30
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "开始智能源码初始化..."
          START_TIME=$(date +%s)
          
          echo "🔧 Feeds配置检测..."
          FEEDS_CONF_FOUND=""
          for feeds_file in feeds.conf feeds.conf.default .feeds.conf .feeds.conf.default; do
            if [ -f "$feeds_file" ]; then
              FEEDS_CONF_FOUND="$feeds_file"
              echo "📋 使用现有 $feeds_file"
              if [ "$feeds_file" != "feeds.conf" ]; then
                cp "$feeds_file" feeds.conf
              fi
              break
            fi
          done
          
          if [ -z "$FEEDS_CONF_FOUND" ]; then
            echo "⚠️ 未找到feeds配置，创建通用配置"
            cat > feeds.conf << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/feed/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git
EOF
          fi
          
          echo "🔄 更新Feeds..."
          for i in 1 2 3; do
            echo "尝试 $i/3"
            if ./scripts/feeds update -a; then
              echo "✅ Feeds更新成功"
              break
            else
              echo "❌ Feeds更新失败，尝试修复..."
              if [ $i -eq 3 ]; then
                echo "❌ Feeds更新彻底失败"
                exit 1
              fi
              sleep 5
            fi
          done
          
          echo "📦 安装基础Feeds..."
          for feed in packages luci routing telephony; do
            if ./scripts/feeds install -a -p $feed; then
              echo "✅ $feed 安装成功"
            else
              echo "⚠️ $feed 安装失败"
            fi
          done
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "⏱️ Feeds初始化耗时: ${DURATION}秒"
          echo "✅ 源码初始化完成"

      - name: 🎯 高效配置文件查找与应用
        timeout-minutes: 2
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "高效配置文件查找与应用..."
          CONFIG_PROFILE="${{ github.event.inputs.config_profile }}"
          echo "输入配置模式: $CONFIG_PROFILE"
          
          echo "🔍 快速配置文件搜索..."
          
          # 方法1: 直接路径查找（最快）
          echo "🎯 方法1: 直接路径查找"
          POSSIBLE_PATHS=(
            "$CONFIG_PROFILE"
            "configs/$CONFIG_PROFILE"
            "firmware-config/$CONFIG_PROFILE"
            "profiles/$CONFIG_PROFILE"
            "../$CONFIG_PROFILE"
            "../../$CONFIG_PROFILE"
            "$GITHUB_WORKSPACE/$CONFIG_PROFILE"
          )
          
          CONFIG_FOUND=""
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$path" ]; then
              CONFIG_FOUND="$path"
              echo "✅ 直接找到配置文件: $CONFIG_FOUND"
              break
            fi
          done
          
          # 方法2: 受限find搜索
          if [ -z "$CONFIG_FOUND" ]; then
            echo "🔍 方法2: 受限find搜索"
            CONFIG_FOUND=$(find . -maxdepth 4 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -n "$CONFIG_FOUND" ]; then
              echo "✅ 通过find找到配置文件: $CONFIG_FOUND"
            fi
          fi
          
          # 方法3: 模式匹配（如果包含通配符）
          if [ -z "$CONFIG_FOUND" ] && [[ "$CONFIG_PROFILE" == *"*"* ]]; then
            echo "🔍 方法3: 通配符模式匹配"
            CONFIG_FOUND=$(find . -maxdepth 3 -name "$CONFIG_PROFILE" -type f 2>/dev/null | head -1)
            if [ -n "$CONFIG_FOUND" ]; then
              echo "✅ 通过通配符找到配置文件: $CONFIG_FOUND"
            fi
          fi
          
          # 方法4: 显示所有可能的配置文件供选择
          if [ -z "$CONFIG_FOUND" ]; then
            echo "🔍 方法4: 显示所有可用配置文件"
            echo "可用的配置文件:"
            find . -maxdepth 3 -name "*.config" -o -name ".config_*" -o -name "config_*" 2>/dev/null | head -20 || echo "无配置文件"
            
            # 尝试找到最接近的匹配
            SIMPLE_NAME=$(echo "$CONFIG_PROFILE" | sed 's/^\.config_//')
            CLOSEST_MATCH=$(find . -maxdepth 3 -name "*$SIMPLE_NAME*" -type f 2>/dev/null | head -1)
            if [ -n "$CLOSEST_MATCH" ]; then
              CONFIG_FOUND="$CLOSEST_MATCH"
              echo "⚠️ 使用最接近的匹配: $CONFIG_FOUND"
            fi
          fi
          
          if [ -n "$CONFIG_FOUND" ]; then
            echo "📋 复制配置文件: $CONFIG_FOUND -> .config"
            cp "$CONFIG_FOUND" .config
            echo "🔍 配置文件基本信息:"
            CONFIG_SIZE=$(stat -c%s .config 2>/dev/null || echo "未知")
            echo "  - 文件: $(basename $CONFIG_FOUND)"
            echo "  - 大小: ${CONFIG_SIZE} 字节"
            echo "  - 来源: $CONFIG_FOUND"
            echo "✅ 配置应用完成"
          else
            echo "❌ 错误: 无法找到配置文件 '$CONFIG_PROFILE'"
            echo ""
            echo "🔍 调试信息:"
            echo "当前目录: $(pwd)"
            echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
            echo "所有.config文件:"
            find . -maxdepth 3 -name "*.config" 2>/dev/null | head -10 || echo "无.config文件"
            exit 1
          fi

      - name: 🔧 高级性能优化配置
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "应用高级性能优化配置..."
          echo "⚡ 应用基础优化..."
          sed -i 's/CONFIG_DEBUG=y/# CONFIG_DEBUG is not set/' .config 2>/dev/null || true
          sed -i 's/CONFIG_DEVEL=y/# CONFIG_DEVEL is not set/' .config 2>/dev/null || true
          echo "CONFIG_CCACHE=y" >> .config
          
          case "${{ github.event.inputs.build_optimization }}" in
            "speed")
              echo "🚀 应用极速优化配置..."
              echo "CONFIG_DEBUG_INFO=n" >> .config
              ;;
            "stability")
              echo "🛡️ 应用稳定优化配置..."
              echo "CONFIG_SMALL_FLASH=y" >> .config
              ;;
            *)
              echo "⚖️ 应用平衡优化配置..."
              ;;
          esac
          
          echo "🔄 运行配置处理..."
          yes "" | make oldconfig >/dev/null 2>&1 || make defconfig >/dev/null 2>&1 || echo "配置处理完成"
          echo "✅ 性能优化配置完成"

      - name: 🛠️ 全面工具链编译与验证
        timeout-minutes: 90
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "开始全面工具链编译..."
          START_TIME=$(date +%s)
          mkdir -p ${{ env.TOOLCHAIN_LOG_DIR }}
          
          echo "🔧 编译Host工具..."
          if ! make tools/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools.log; then
            echo "❌ Host工具编译失败，尝试单线程..."
            if ! make tools/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/host-tools-single.log; then
              echo "❌ Host工具编译彻底失败"
              exit 1
            fi
          fi
          
          echo "🔧 编译工具链..."
          if ! make toolchain/compile -j$(($(nproc) - 1)) V=sc 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile.log; then
            echo "❌ 工具链编译失败，尝试单线程..."
            if ! make toolchain/compile -j1 V=s 2>&1 | tee ${{ env.TOOLCHAIN_LOG_DIR }}/toolchain-compile-single.log; then
              echo "❌ 工具链编译彻底失败"
              exit 1
            fi
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "⏱️ 工具链编译耗时: ${DURATION}秒"
          echo "✅ 工具链编译完成"

      - name: 🔍 深度工具链验证
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 深度工具链验证 ==="
          echo "🔧 关键工具验证:"
          for tool in m4 flex bison; do
            tool_path=$(find staging_dir/host/bin -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$tool_path" ] && [ -x "$tool_path" ]; then
              echo "✅ $tool: 可用"
            else
              echo "❌ $tool: 缺失"
              exit 1
            fi
          done
          
          echo "🎯 目标工具链验证:"
          TARGET_GCC=$(find staging_dir/toolchain-*/bin/ -name "*gcc" -type f 2>/dev/null | head -1)
          if [ -n "$TARGET_GCC" ] && [ -x "$TARGET_GCC" ]; then
            echo "✅ 目标GCC: 可用"
          else
            echo "❌ 目标GCC: 缺失"
            exit 1
          fi
          echo "✅ 深度工具链验证完成"

      - name: 📦 智能自定义功能处理
        if: github.event.inputs.enable_custom_features == 'true'
        timeout-minutes: 10
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "处理智能自定义功能..."
          CUSTOM_FEATURES_DIR="${{ env.CUSTOM_FEATURES_DIR }}"
          if [ -n "$CUSTOM_FEATURES_DIR" ]; then
            echo "🔍 使用找到的自定义功能目录: $CUSTOM_FEATURES_DIR"
            
            # 处理预编译IPK包
            IPK_DIRS=("$CUSTOM_FEATURES_DIR/prebuilt-ipks" "$CUSTOM_FEATURES_DIR/ipks")
            for ipk_dir in "${IPK_DIRS[@]}"; do
              if [ -d "$ipk_dir" ]; then
                IPK_FILES=$(find "$ipk_dir" -name "*.ipk" -type f 2>/dev/null)
                IPK_COUNT=$(echo "$IPK_FILES" | wc -l)
                if [ "$IPK_COUNT" -gt 0 ]; then
                  echo "✅ 在 $ipk_dir 找到 $IPK_COUNT 个IPK文件"
                  mkdir -p package/base-files/files/usr/lib/opkg/custom
                  for ipk in $IPK_FILES; do
                    if [ -f "$ipk" ]; then
                      cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
                      echo "✅ 已复制: $(basename $ipk)"
                    fi
                  done
                  break
                fi
              fi
            done
            
            # 处理自定义脚本
            SCRIPT_DIRS=("$CUSTOM_FEATURES_DIR/scripts" "$CUSTOM_FEATURES_DIR/script")
            for script_dir in "${SCRIPT_DIRS[@]}"; do
              if [ -d "$script_dir" ]; then
                SCRIPT_FILES=$(find "$script_dir" -name "*.sh" -type f 2>/dev/null | head -5)
                for script in $SCRIPT_FILES; do
                  if [ -f "$script" ]; then
                    echo "▶️ 执行脚本: $(basename $script)"
                    chmod +x "$script"
                    if timeout 300 bash "$script"; then
                      echo "✅ 脚本执行成功: $(basename $script)"
                    else
                      echo "⚠️ 脚本执行失败: $(basename $script)"
                    fi
                  fi
                done
                break
              fi
            done
          else
            echo "ℹ️ 无自定义功能目录，跳过自定义功能处理"
          fi
          echo "✅ 自定义功能处理完成"

      - name: 🏗️ 智能编译固件
        timeout-minutes: 180
        id: compile-firmware
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "开始智能编译固件..."
          export FORCE_UNSAFE_CONFIGURE=1
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          CPU_CORES=$(nproc)
          BUILD_JOBS=$((CPU_CORES - 1))
          mkdir -p ${{ env.BUILD_LOG_DIR }}
          START_TIME=$(date +%s)
          
          echo "📊 编译参数:"
          echo "  - CPU核心: $CPU_CORES"
          echo "  - 编译任务数: $BUILD_JOBS"
          echo "  - 优化策略: ${{ github.event.inputs.build_optimization }}"
          
          echo "🔧 开始编译..."
          LOG_FILE="${{ env.BUILD_LOG_DIR }}/firmware-compile.log"
          
          # 分阶段编译以提高稳定性
          {
            echo "阶段1: 编译准备..."
            make tools/install -j$BUILD_JOBS
            make toolchain/install -j$BUILD_JOBS
            
            echo "阶段2: 编译目标..."
            make target/compile -j$BUILD_JOBS V=sc
            
            echo "阶段3: 编译软件包..."
            make package/compile -j$BUILD_JOBS V=sc
            
            echo "阶段4: 安装和打包..."
            make package/install -j1 V=s
            make target/install -j1 V=s
            
          } 2>&1 | tee "$LOG_FILE"
          
          COMPILE_EXIT_CODE=${PIPESTATUS[0]}
          if [ $COMPILE_EXIT_CODE -eq 0 ]; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            echo "🎉 编译成功完成!"
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "❌ 编译失败，退出码: $COMPILE_EXIT_CODE"
            echo "=== 错误分析 ==="
            grep -i "error\|failed" "$LOG_FILE" | tail -10 || echo "无明确错误信息"
            exit 1
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV
          echo "⏱️ 总编译耗时: ${DURATION}秒 ($(($DURATION/60))分钟)"

      - name: 🔍 通用固件产物验证与收集
        if: env.BUILD_STATUS == 'success'
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "=== 通用固件产物验证与收集 ==="
          mkdir -p ${{ env.ARTIFACTS_DIR }}/firmware
          mkdir -p ${{ env.ARTIFACTS_DIR }}/logs
          mkdir -p ${{ env.ARTIFACTS_DIR }}/configs
          
          echo "🔍 搜索固件文件..."
          if [ -d "bin/targets" ]; then
            echo "📁 复制标准输出目录..."
            cp -r bin/targets ${{ env.ARTIFACTS_DIR }}/firmware/
            FIRMWARE_COUNT=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | wc -l)
            echo "✅ 找到 $FIRMWARE_COUNT 个固件文件"
          else
            echo "🔍 在其它位置搜索固件..."
            FIRMWARE_FILES=$(find . -maxdepth 4 -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -20)
            if [ -n "$FIRMWARE_FILES" ]; then
              for file in $FIRMWARE_FILES; do
                if [ -f "$file" ]; then
                  file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
                  if [ "$file_size" -gt 1000000 ]; then  # 大于1MB的才认为是固件
                    rel_path=$(echo "$file" | sed 's|^\./||')
                    target_dir="${{ env.ARTIFACTS_DIR }}/firmware/$(dirname "$rel_path")"
                    mkdir -p "$target_dir"
                    cp "$file" "$target_dir/"
                    echo "📦 已收集: $rel_path ($(($file_size/1024/1024))MB)"
                  fi
                fi
              done
              FIRMWARE_COUNT=$(echo "$FIRMWARE_FILES" | wc -l)
            else
              FIRMWARE_COUNT=0
            fi
          fi
          
          echo "📋 收集构建信息..."
          cp .config ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || true
          cp feeds.conf ${{ env.ARTIFACTS_DIR }}/configs/ 2>/dev/null || true
          cp -r ${{ env.BUILD_LOG_DIR }}/* ${{ env.ARTIFACTS_DIR }}/logs/ 2>/dev/null || true
          
          if [ $FIRMWARE_COUNT -eq 0 ]; then
            echo "❌ 错误: 未找到任何固件文件"
            echo "当前目录结构:"
            find . -maxdepth 3 -type d | head -20
            exit 1
          else
            echo "✅ 固件验证与收集完成: $FIRMWARE_COUNT 个文件"
          fi
          echo "FIRMWARE_COUNT=$FIRMWARE_COUNT" >> $GITHUB_ENV

      - name: 📊 生成详细构建报告
        if: always()
        run: |
          cd ${{ env.SOURCE_DIR }}
          echo "生成详细构建报告..."
          {
            echo "=== 详细固件构建报告 ==="
            echo "构建时间: $(date)"
            echo "构建状态: ${{ env.BUILD_STATUS || 'unknown' }}"
            echo "编译时长: ${{ env.BUILD_DURATION || 'N/A' }}秒"
            echo "固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
            echo ""
            echo "=== 源码信息 ==="
            echo "源码库: ${{ env.SOURCE_PRESET }}"
            echo "实际分支: ${{ env.ACTUAL_BRANCH }}"
            echo "提交哈希: ${{ env.COMMIT_HASH || 'unknown' }}"
            echo ""
            echo "=== 编译配置 ==="
            echo "配置文件: ${{ github.event.inputs.config_profile }}"
            echo "优化策略: ${{ github.event.inputs.build_optimization }}"
            echo "工具链策略: ${{ github.event.inputs.toolchain_strategy }}"
            echo "自定义功能: ${{ github.event.inputs.enable_custom_features }}"
            echo ""
            if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
              echo "=== 产物信息 ==="
              echo "固件文件列表:"
              find ${{ env.ARTIFACTS_DIR }}/firmware -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | xargs -I {} basename {} | head -10
            else
              echo "构建失败，无固件产物"
            fi
          } > ${{ env.ARTIFACTS_DIR }}/detailed-build-report.txt
          echo "✅ 详细构建报告生成完成"

      - name: 💾 上传构建产物
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-${{ github.run_number }}-${{ env.SOURCE_PRESET }}-${{ env.ACTUAL_BRANCH }}-${{ env.BUILD_STATUS || 'unknown' }}
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 30

      - name: 🧹 编译后智能清理
        if: always()
        run: |
          echo "开始编译后智能清理..."
          echo "=== 清理前状态 ==="
          df -h
          if [ -d "${{ env.SOURCE_DIR }}" ]; then
            cd ${{ env.SOURCE_DIR }}
            echo "🧹 清理编译临时文件..."
            rm -rf build_dir/* staging_dir/* tmp/* 2>/dev/null || true
          fi
          echo "🧹 清理交换文件..."
          sudo swapoff /mnt/swapfile 2>/dev/null || true
          sudo rm -f /mnt/swapfile 2>/dev/null || true
          echo ""
          echo "=== 清理后状态 ==="
          df -h
          echo "✅ 智能清理完成"

      - name: 📊 最终综合报告
        if: always()
        run: |
          echo "=== 最终综合报告 ==="
          echo "🎯 工作流: ${{ github.workflow }}"
          echo "🆔 运行号: ${{ github.run_number }}"
          echo ""
          echo "📦 源码信息:"
          echo "  - 预设: ${{ env.SOURCE_PRESET }}"
          echo "  - 分支: ${{ env.ACTUAL_BRANCH }}"
          echo ""
          echo "⚙️ 编译配置:"
          echo "  - 配置文件: ${{ github.event.inputs.config_profile }}"
          echo "  - 优化策略: ${{ github.event.inputs.build_optimization }}"
          echo ""
          echo "📈 构建结果:"
          echo "  - 状态: ${{ env.BUILD_STATUS || 'unknown' }}"
          echo "  - 时长: ${{ env.BUILD_DURATION || 'N/A' }}秒"
          echo "  - 固件数量: ${{ env.FIRMWARE_COUNT || 0 }}"
          echo ""
          if [ "${{ env.BUILD_STATUS }}" = "success" ]; then
            echo "🎉 构建成功！固件已上传到 Artifacts"
            echo "📦 下载 Artifacts 获取编译产物"
          else
            echo "❌ 构建失败"
            echo "🔍 请查看详细日志分析错误原因"
          fi
