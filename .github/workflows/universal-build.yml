name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨è)'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶ (è¿è¡Œå·¥ä½œæµæŸ¥çœ‹å¯ç”¨é€‰é¡¹)'
        required: true
        type: string
        default: 'è¯·å…ˆè¿è¡Œä¸€æ¬¡å·¥ä½œæµæŸ¥çœ‹å¯ç”¨é…ç½®æ–‡ä»¶'
      
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  BUILD_TIMEOUT: 180

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: config-repo

    - name: "ğŸ” å‘ç°å¹¶æ˜¾ç¤ºå¯ç”¨é…ç½®æ–‡ä»¶"
      id: discover-configs
      run: |
        cd config-repo
        echo "=== å¯ç”¨é…ç½®æ–‡ä»¶åˆ—è¡¨ ==="
        
        # æŸ¥æ‰¾æ‰€æœ‰é…ç½®æ–‡ä»¶
        CONFIG_FILES=$(find configs -name ".config_*" -type f 2>/dev/null | sort || echo "")
        
        if [ -z "$CONFIG_FILES" ]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶"
          echo "è¯·åœ¨ config-repo/configs/ ç›®å½•ä¸‹æ”¾ç½®é…ç½®æ–‡ä»¶"
          echo "æ–‡ä»¶å‘½åæ ¼å¼: .config_è®¾å¤‡å_æºç åº“"
          echo ""
          echo "ç¤ºä¾‹:"
          echo "  .config_rt-ac42u_immortalwrt"
          echo "  .config_x86-64_openwrt"
          echo "  .config_rt-acrh17_lede"
          exit 1
        else
          echo "æ‰¾åˆ°ä»¥ä¸‹é…ç½®æ–‡ä»¶:"
          echo "$CONFIG_FILES"
          echo ""
          echo "âš ï¸  æ³¨æ„: å¦‚æœè¿™ä¸æ˜¯ä½ æƒ³è¦çš„é…ç½®æ–‡ä»¶åˆ—è¡¨ï¼Œ"
          echo "è¯·åœ¨å·¥ä½œæµè¾“å…¥ä¸­ä¿®æ”¹ 'config_profile' å­—æ®µ"
          echo "ä½¿ç”¨ä¸Šé¢æ˜¾ç¤ºçš„å®Œæ•´è·¯å¾„ä¹‹ä¸€"
          
          # ä¿å­˜é…ç½®æ–‡ä»¶åˆ—è¡¨ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          CONFIG_JSON=$(echo "$CONFIG_FILES" | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "CONFIG_LIST=$CONFIG_JSON" >> $GITHUB_OUTPUT
        fi

    - name: "âœ… éªŒè¯é…ç½®æ–‡ä»¶é€‰æ‹©"
      run: |
        cd config-repo
        USER_CONFIG="${{ github.event.inputs.config_profile }}"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯é»˜è®¤æç¤ºå€¼
        if [ "$USER_CONFIG" = "è¯·å…ˆè¿è¡Œä¸€æ¬¡å·¥ä½œæµæŸ¥çœ‹å¯ç”¨é…ç½®æ–‡ä»¶" ]; then
          echo "âŒ é”™è¯¯: è¯·åœ¨å·¥ä½œæµè¾“å…¥ä¸­æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„"
          echo "å¯ç”¨é…ç½®æ–‡ä»¶:"
          echo "${{ steps.discover-configs.outputs.CONFIG_LIST }}" | jq -r '.[]'
          exit 1
        fi
        
        # éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$USER_CONFIG" ]; then
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $USER_CONFIG"
          echo "å¯ç”¨é…ç½®æ–‡ä»¶:"
          echo "${{ steps.discover-configs.outputs.CONFIG_LIST }}" | jq -r '.[]'
          exit 1
        fi
        
        echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡: $USER_CONFIG"

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        cd config-repo
        echo "è¯»å–æºç åº“é…ç½®..."
        echo "é€‰æ‹©çš„é¢„è®¾: ${{ github.event.inputs.source_preset }}"
        
        if [ ! -f "repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        PRESET="${{ github.event.inputs.source_preset }}"
        
        # ä» repositories å¯¹è±¡ä¸­è·å–é…ç½®
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" repositories.json)
        
        # åˆ†æ”¯å¤„ç†
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" repositories.json)
          echo "è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
        fi
        
        # éªŒè¯è·å–çš„å€¼
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•ä»repositories.jsonè·å–æºç URLï¼Œè¯·æ£€æŸ¥$PRESETé…ç½®"
          exit 1
        fi
        
        if [ -z "$BRANCH" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•è·å–æºç åˆ†æ”¯"
          exit 1
        fi
        
        echo "æºç åº“: $PRESET - $DESCRIPTION"
        echo "ä»“åº“URL: $SOURCE_URL"
        echo "ä½¿ç”¨åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    - name: "ğŸ§¹ å‡†å¤‡æ„å»ºç¯å¢ƒ"
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip python3-serial python3-setuptools rsync unzip zlib1g-dev file wget jq

    - name: "ğŸ“¥ è·å–æºä»£ç "
      run: |
        echo "å…‹éš†æºç ä»“åº“: ${{ env.SOURCE_URL }}"
        echo "ä½¿ç”¨åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        git clone --depth 1 --branch "${{ env.SOURCE_BRANCH }}" "${{ env.SOURCE_URL }}" source

    - name: "ğŸ”§ æºç åˆå§‹åŒ–"
      run: |
        cd source
        if [ -f "feeds.conf" ] || [ -f "feeds.conf.default" ]; then
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feedsæ›´æ–°å®Œæˆ"
        fi

    - name: "ğŸ¨ åº”ç”¨è‡ªå®šä¹‰é…ç½®"
      run: |
        cd source
        CONFIG_FILE="../config-repo/${{ github.event.inputs.config_profile }}"
        echo "æ­£åœ¨åº”ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ: ${{ github.event.inputs.config_profile }}"

    - name: "ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        SCRIPTS_DIR="../config-repo/custom-features/scripts"
        if [ ! -d "$SCRIPTS_DIR" ]; then
          echo "â„¹ï¸ è‡ªå®šä¹‰è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $SCRIPTS_DIR"
          exit 0
        fi
        SCRIPTS=$(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort)
        if [ -z "$SCRIPTS" ]; then
          echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½•è„šæœ¬æ–‡ä»¶"
          exit 0
        fi
        echo "æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬æ–‡ä»¶:"
        echo "$SCRIPTS"
        for script in $SCRIPTS; do
          echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
          chmod +x "$script"
          if bash "$script"; then
            echo "âœ… $(basename "$script") æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ $(basename "$script") æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

    - name: "ğŸ—ï¸ ç¼–è¯‘å›ºä»¶"
      timeout-minutes: ${{ env.BUILD_TIMEOUT }}
      run: |
        cd source
        BUILD_JOBS=$(( $(nproc) - 1 ))
        [ $BUILD_JOBS -lt 1 ] && BUILD_JOBS=1
        echo "ä½¿ç”¨å¹¶è¡Œä»»åŠ¡æ•°: $BUILD_JOBS"
        START_TIME=$(date +%s)
        echo "å¼€å§‹ç¼–è¯‘è¿‡ç¨‹..."
        make defconfig
        make download -j${BUILD_JOBS} || make download -j1 V=s
        make -j${BUILD_JOBS} || make -j1 V=s
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "âœ… ç¼–è¯‘å®Œæˆ! è€—æ—¶: ${DURATION}ç§’"
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV

    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      run: |
        cd source
        echo "æ”¶é›†ç¼–è¯‘è¾“å‡ºæ–‡ä»¶..."
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
        fi
        mkdir -p ../artifacts
        cp -r bin/targets/* ../artifacts/ 2>/dev/null || true
        echo "æºç : ${{ env.SOURCE_URL }}" > ../artifacts/build-info.txt
        echo "åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}" >> ../artifacts/build-info.txt
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}" >> ../artifacts/build-info.txt
        echo "æ—¶é—´: $(date)" >> ../artifacts/build-info.txt
        echo "æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’" >> ../artifacts/build-info.txt

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}"
        path: artifacts/
        retention-days: 30

    - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æºç : ${{ env.SOURCE_URL }}"
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
        fi
