name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨è)'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ - æŸ¥çœ‹ firmware-config/configs-list.md'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  BUILD_TIMEOUT: 180

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: .  # ç›´æ¥æ£€å‡ºåˆ°å·¥ä½œåŒºæ ¹ç›®å½•

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        echo "=== è¯¦ç»†æ–‡ä»¶æ£€æŸ¥ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        
        echo "=== æ£€æŸ¥firmware-configç›®å½• ==="
        if [ -d "firmware-config" ]; then
          echo "âœ… firmware-config ç›®å½•å­˜åœ¨"
          echo "firmware-config ç›®å½•å†…å®¹:"
          ls -la firmware-config/
          echo ""
          
          echo "=== æ£€æŸ¥repositories.jsonæ–‡ä»¶ ==="
          if [ -f "firmware-config/repositories.json" ]; then
            echo "âœ… repositories.json æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
            ls -la firmware-config/repositories.json
            echo "æ–‡ä»¶å¤§å°: $(wc -c < firmware-config/repositories.json) å­—èŠ‚"
            echo ""
            
            echo "=== éªŒè¯JSONæ ¼å¼ ==="
            if jq empty firmware-config/repositories.json 2>/dev/null; then
              echo "âœ… JSONæ ¼å¼éªŒè¯é€šè¿‡"
            else
              echo "âŒ JSONæ ¼å¼é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰JSONæ–‡ä»¶:"
            find . -name "*.json" -type f | head -10
            exit 1
          fi
        else
          echo "âŒ firmware-config ç›®å½•ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½•:"
          find . -maxdepth 1 -type d | head -10
          exit 1
        fi
        
        echo "=== å¼€å§‹è§£æé…ç½® ==="
        PRESET="${{ github.event.inputs.source_preset }}"
        
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" firmware-config/repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
          echo "è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
        fi
        
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•ä»repositories.jsonè·å–æºç URL"
          exit 1
        fi
        
        if [ -z "$BRANCH" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•è·å–æºç åˆ†æ”¯"
          exit 1
        fi
        
        echo "âœ… æºç åº“: $PRESET - $DESCRIPTION"
        echo "âœ… ä»“åº“URL: $SOURCE_URL"
        echo "âœ… ä½¿ç”¨åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    # ... å…¶ä½™æ­¥éª¤ä¿æŒä¸å˜ ...
