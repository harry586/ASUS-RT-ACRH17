name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“ (ImmortalWrtåŠŸèƒ½ä¸°å¯Œ/OpenWrtå®˜æ–¹çº¯å‡€/LEDEé›†æˆåº¦é«˜)'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨æŒ‡å®šåˆ†æ”¯å)'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ - æŸ¥çœ‹ firmware-config/configs-list.md è·å–å¯ç”¨æ–‡ä»¶åˆ—è¡¨'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½ (è‡ªå®šä¹‰è„šæœ¬å’Œé¢„ç¼–è¯‘IPKåŒ…)'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"                    # è®¾ç½®æ—¶åŒºä¸ºä¸­å›½æ ‡å‡†æ—¶é—´
  BUILD_TIMEOUT: 180                     # æ„å»ºè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # ======================
    # é˜¶æ®µ1ï¼šç¯å¢ƒå‡†å¤‡å’Œé…ç½®è§£æ
    # ======================
    
    # æ­¥éª¤1: æ£€å‡ºé…ç½®ä»“åº“
    - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: .  # ç›´æ¥æ£€å‡ºåˆ°å·¥ä½œåŒºæ ¹ç›®å½•

    # æ­¥éª¤2: è§£ææºç åº“é…ç½®
    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        echo "=== è¯¦ç»†æ–‡ä»¶æ£€æŸ¥ ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        
        echo "=== æ£€æŸ¥firmware-configç›®å½• ==="
        if [ -d "firmware-config" ]; then
          echo "âœ… firmware-config ç›®å½•å­˜åœ¨"
          echo "firmware-config ç›®å½•å†…å®¹:"
          ls -la firmware-config/
          echo ""
          
          echo "=== æ£€æŸ¥repositories.jsonæ–‡ä»¶ ==="
          if [ -f "firmware-config/repositories.json" ]; then
            echo "âœ… repositories.json æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
            ls -la firmware-config/repositories.json
            echo "æ–‡ä»¶å¤§å°: $(wc -c < firmware-config/repositories.json) å­—èŠ‚"
            echo ""
            
            echo "=== éªŒè¯JSONæ ¼å¼ ==="
            if jq empty firmware-config/repositories.json 2>/dev/null; then
              echo "âœ… JSONæ ¼å¼éªŒè¯é€šè¿‡"
            else
              echo "âŒ JSONæ ¼å¼é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰JSONæ–‡ä»¶:"
            find . -name "*.json" -type f | head -10
            exit 1
          fi
        else
          echo "âŒ firmware-config ç›®å½•ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½•:"
          find . -maxdepth 1 -type d | head -10
          exit 1
        fi
        
        echo "=== å¼€å§‹è§£æé…ç½® ==="
        PRESET="${{ github.event.inputs.source_preset }}"
        
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" firmware-config/repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" firmware-config/repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" firmware-config/repositories.json)
          echo "è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
        fi
        
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•ä»repositories.jsonè·å–æºç URL"
          exit 1
        fi
        
        if [ -z "$BRANCH" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•è·å–æºç åˆ†æ”¯"
          exit 1
        fi
        
        echo "âœ… æºç åº“: $PRESET - $DESCRIPTION"
        echo "âœ… ä»“åº“URL: $SOURCE_URL"
        echo "âœ… ä½¿ç”¨åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    # æ­¥éª¤3: å®‰è£…ç¼–è¯‘ä¾èµ–
    - name: "ğŸ§¹ å‡†å¤‡æ„å»ºç¯å¢ƒ"
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–åŒ…..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial python3-setuptools rsync unzip zlib1g-dev file wget \
          jq
        echo "âœ… æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

    # ======================
    # é˜¶æ®µ2ï¼šæºç è·å–å’Œåˆå§‹åŒ–
    # ======================
    
    # æ­¥éª¤4: å…‹éš†æºä»£ç 
    - name: "ğŸ“¥ è·å–æºä»£ç "
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“: ${{ env.SOURCE_URL }}"
        echo "ä½¿ç”¨åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨sourceç›®å½•ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ é™¤
        if [ -d "source" ]; then
          echo "æ¸…ç†å·²å­˜åœ¨çš„sourceç›®å½•"
          rm -rf source
        fi
        
        # å…‹éš†æºç 
        git clone --depth 1 \
          --branch "${{ env.SOURCE_BRANCH }}" \
          "${{ env.SOURCE_URL }}" \
          source
          
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        echo "sourceç›®å½•å†…å®¹:"
        ls -la source/ | head -10

    # æ­¥éª¤5: åˆå§‹åŒ–æºç 
    - name: "ğŸ”§ æºç åˆå§‹åŒ–"
      run: |
        cd source
        echo "åˆå§‹åŒ–æºç æ ‘..."
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # æ£€æŸ¥feedsé…ç½®æ–‡ä»¶
        if [ -f "feeds.conf" ] || [ -f "feeds.conf.default" ]; then
          echo "æ›´æ–°feeds..."
          ./scripts/feeds update -a
          echo "å®‰è£…feeds..."
          ./scripts/feeds install -a
          echo "âœ… Feedsæ›´æ–°å®Œæˆ"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°feedsé…ç½®æ–‡ä»¶ï¼Œè·³è¿‡feedsæ›´æ–°"
        fi
        
        echo "æºç æ ‘åˆå§‹åŒ–å®Œæˆ"

    # ======================
    # é˜¶æ®µ3ï¼šé…ç½®åº”ç”¨å’Œè‡ªå®šä¹‰åŠŸèƒ½
    # ======================
    
    # æ­¥éª¤6: åº”ç”¨è®¾å¤‡é…ç½®
    - name: "ğŸ¨ åº”ç”¨è‡ªå®šä¹‰é…ç½®"
      run: |
        cd source
        CONFIG_FILE="../firmware-config/${{ github.event.inputs.config_profile }}"
        echo "æ­£åœ¨åº”ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        
        # éªŒè¯é…ç½®æ–‡ä»¶
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          echo "å½“å‰firmware-config/configsç›®å½•å†…å®¹:"
          ls -la ../firmware-config/configs/ 2>/dev/null || echo "configsç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ: ${{ github.event.inputs.config_profile }}"
        
        # æ˜¾ç¤ºé…ç½®åŸºæœ¬ä¿¡æ¯
        echo "é…ç½®åŸºæœ¬ä¿¡æ¯:"
        grep "CONFIG_TARGET" .config | head -5 || echo "æ— æ³•è¯»å–é…ç½®"

    # æ­¥éª¤7: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
    - name: "ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        SCRIPTS_DIR="../firmware-config/custom-features/scripts"
        
        echo "æ£€æŸ¥è‡ªå®šä¹‰è„šæœ¬ç›®å½•: $SCRIPTS_DIR"
        if [ ! -d "$SCRIPTS_DIR" ]; then
          echo "â„¹ï¸ è‡ªå®šä¹‰è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $SCRIPTS_DIR"
          exit 0
        fi
        
        # æŸ¥æ‰¾æ‰€æœ‰è„šæœ¬
        SCRIPTS=$(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort)
        
        if [ -z "$SCRIPTS" ]; then
          echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½•è„šæœ¬æ–‡ä»¶"
          exit 0
        fi
        
        echo "æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬æ–‡ä»¶:"
        echo "$SCRIPTS"
        
        # æ‰§è¡Œæ‰€æœ‰è„šæœ¬
        for script in $SCRIPTS; do
          echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
          chmod +x "$script"
          if bash "$script"; then
            echo "âœ… $(basename "$script") æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ $(basename "$script") æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
        done
        
        echo "âœ… æ‰€æœ‰è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

    # ======================
    # é˜¶æ®µ4ï¼šç¼–è¯‘è¿‡ç¨‹
    # ======================
    
    # æ­¥éª¤8: ç¼–è¯‘å›ºä»¶
    - name: "ğŸ—ï¸ ç¼–è¯‘å›ºä»¶"
      timeout-minutes: ${{ env.BUILD_TIMEOUT }}
      run: |
        cd source
        
        echo "=== ç¼–è¯‘ç¯å¢ƒæ£€æŸ¥ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        
        echo "=== æ£€æŸ¥é…ç½®æ–‡ä»¶ ==="
        if [ -f ".config" ]; then
          echo "âœ… .config æ–‡ä»¶å­˜åœ¨"
          echo "é…ç½®æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
          echo "é…ç½®æ–‡ä»¶ç›®æ ‡å¹³å°ä¿¡æ¯:"
          grep "CONFIG_TARGET" .config | head -10 || echo "æœªæ‰¾åˆ°ç›®æ ‡å¹³å°é…ç½®"
        else
          echo "âŒ .config æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo ""
        echo "=== å¼€å§‹ç¼–è¯‘è¿‡ç¨‹ ==="
        
        # è®¡ç®—å¹¶è¡Œä»»åŠ¡æ•°
        BUILD_JOBS=$(( $(nproc) - 1 ))
        [ $BUILD_JOBS -lt 1 ] && BUILD_JOBS=1
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "ä½¿ç”¨å¹¶è¡Œä»»åŠ¡æ•°: $BUILD_JOBS"
        
        START_TIME=$(date +%s)
        
        echo "æ­¥éª¤1: åº”ç”¨é»˜è®¤é…ç½® (make defconfig)"
        make defconfig
        echo "âœ… defconfig å®Œæˆ"
        
        echo "æ­¥éª¤2: ä¸‹è½½æºç åŒ… (make download)"
        make download -j${BUILD_JOBS} || {
          echo "âš ï¸ å¹¶è¡Œä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è¯¦ç»†æ¨¡å¼"
          make download -j1 V=s
        }
        echo "âœ… æºç åŒ…ä¸‹è½½å®Œæˆ"
        
        echo "æ­¥éª¤3: å¼€å§‹ç¼–è¯‘å›ºä»¶ (make)"
        echo "è¿™å¯èƒ½ä¼šèŠ±è´¹è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
        make -j${BUILD_JOBS} || {
          echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è¯¦ç»†æ¨¡å¼"
          make -j1 V=s
        }
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "âœ… ç¼–è¯‘å®Œæˆ! æ€»è€—æ—¶: ${DURATION}ç§’"
        
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV

    # ======================
    # é˜¶æ®µ5ï¼šè¾“å‡ºå¤„ç†å’Œäº§ç‰©æ”¶é›†
    # ======================
    
    # æ­¥éª¤9: æ”¶é›†æ„å»ºäº§ç‰©
    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      run: |
        cd source
        echo "=== æŸ¥æ‰¾ç¼–è¯‘è¾“å‡º ==="
        
        echo "æ£€æŸ¥binç›®å½•æ˜¯å¦å­˜åœ¨:"
        if [ -d "bin" ]; then
          echo "âœ… binç›®å½•å­˜åœ¨"
          echo "binç›®å½•ç»“æ„:"
          find bin/ -type d 2>/dev/null | head -20
        else
          echo "âŒ binç›®å½•ä¸å­˜åœ¨ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥"
          exit 1
        fi
        
        echo ""
        echo "=== æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶ ==="
        # æŸ¥æ‰¾å„ç§å¯èƒ½çš„å›ºä»¶æ ¼å¼
        FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" -o -name "*.gz" -o -name "*.elf" -o -name "*.iso" \) 2>/dev/null | head -20)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          echo ""
          echo "å›ºä»¶æ–‡ä»¶å¤§å°:"
          for file in $FIRMWARE_FILES; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "  $file - $size"
            fi
          done
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
          echo "æ­£åœ¨æœç´¢binç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶..."
          find bin/ -type f 2>/dev/null | head -30
        fi
        
        echo ""
        echo "=== å‡†å¤‡äº§ç‰© ==="
        mkdir -p ../artifacts
        
        # å¤åˆ¶ç›®æ ‡æ–‡ä»¶
        if [ -d "bin/targets" ]; then
          echo "å¤åˆ¶bin/targetsç›®å½•..."
          cp -r bin/targets/* ../artifacts/ 2>/dev/null || true
        fi
        
        # å¦‚æœartifactsç›®å½•ä»ç„¶ä¸ºç©ºï¼Œå¤åˆ¶æ•´ä¸ªbinç›®å½•
        if [ ! "$(ls -A ../artifacts 2>/dev/null)" ]; then
          echo "artifactsç›®å½•ä¸ºç©ºï¼Œå¤åˆ¶æ•´ä¸ªbinç›®å½•..."
          cp -r bin/* ../artifacts/ 2>/dev/null || true
        fi
        
        echo "äº§ç‰©ç›®å½•å†…å®¹:"
        ls -la ../artifacts/ || echo "artifactsç›®å½•ä¸ºç©º"
        
        # åˆ›å»ºè¯¦ç»†çš„æ„å»ºä¿¡æ¯
        echo "=== åˆ›å»ºæ„å»ºä¿¡æ¯ ==="
        cat > ../artifacts/build-info.txt << EOF
æ„å»ºä¿¡æ¯
========
æºç åº“: ${{ env.SOURCE_URL }}
åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}
é…ç½®æ–‡ä»¶: ${{ github.event.inputs.config_profile }}
è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}
æ„å»ºæ—¶é—´: $(date)
ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’

å›ºä»¶æ–‡ä»¶åˆ—è¡¨:
$(echo "$FIRMWARE_FILES" | sed 's/^/  - /')

å·¥ä½œæµä¿¡æ¯:
- è¿è¡Œç¼–å·: ${{ github.run_number }}
- è¿è¡ŒID: ${{ github.run_id }}
EOF

        echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

    # æ­¥éª¤10: ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}-${{ github.event.inputs.source_preset }}"
        path: artifacts/
        retention-days: 30

    # æ­¥éª¤11: æ„å»ºæŠ¥å‘Š
    - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
      if: always()
      run: |
        echo "=========================================="
        echo "            ğŸ—ï¸ æ„å»ºæŠ¥å‘Š"
        echo "=========================================="
        echo ""
        echo "ğŸ“‹ åŸºæœ¬ä¿¡æ¯:"
        echo "  - çŠ¶æ€: ${{ job.status }}"
        echo "  - æºç åº“: ${{ env.SOURCE_URL }}"
        echo "  - åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        echo "  - é…ç½®: ${{ github.event.inputs.config_profile }}"
        echo "  - è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
        echo ""
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
          echo "  - ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’"
          echo "  - å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
          echo "  - äº§ç‰©åç§°: Firmware-${{ github.run_number }}-${{ github.event.inputs.source_preset }}"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "  è¯·æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯"
        fi
        echo ""
        echo "=========================================="
