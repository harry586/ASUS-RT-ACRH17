name: "Universal Firmware Builder"

on:
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“ (ImmortalWrtåŠŸèƒ½ä¸°å¯Œ/OpenWrtå®˜æ–¹çº¯å‡€/LEDEé›†æˆåº¦é«˜)'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨èç¨³å®šåˆ†æ”¯ï¼Œæˆ–æ‰‹åŠ¨æŒ‡å®šåˆ†æ”¯å)'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ - æŸ¥çœ‹ firmware-config/configs-list.md è·å–å¯ç”¨æ–‡ä»¶åˆ—è¡¨'
        required: true
        type: string
        default: 'configs/.config_rt-ac42u_immortalwrt'
      
      build_optimization:
        description: 'ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥'
        required: true
        type: choice
        options:
          - balanced
          - speed
          - stability
        default: 'balanced'

      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½ (è‡ªå®šä¹‰è„šæœ¬å’Œé¢„ç¼–è¯‘IPKåŒ…)'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  TERM: "linux"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: firmware-config

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        cd firmware-config
        
        if [ ! -f "repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        PRESET="${{ github.event.inputs.source_preset }}"
        SOURCE_URL=$(jq -r ".repositories.$PRESET.url // empty" repositories.json)
        DESCRIPTION=$(jq -r ".repositories.$PRESET.description // empty" repositories.json)
        
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(jq -r ".repositories.$PRESET.recommended_branch // \"main\"" repositories.json)
          echo "è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
        fi
        
        if [ -z "$SOURCE_URL" ]; then
          echo "âŒ é”™è¯¯: æ— æ³•ä»repositories.jsonè·å–æºç URL"
          exit 1
        fi
        
        echo "âœ… æºç åº“: $PRESET - $DESCRIPTION"
        echo "âœ… ä»“åº“URL: $SOURCE_URL"
        echo "âœ… ä½¿ç”¨åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    - name: "ğŸ§¹ å‡†å¤‡æ„å»ºç¯å¢ƒ"
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–åŒ…..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial python3-setuptools rsync unzip zlib1g-dev file wget \
          jq ncurses-term tree
        echo "âœ… æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: "ğŸ“¥ è·å–æºä»£ç "
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“: ${{ env.SOURCE_URL }}"
        git clone --depth 1 \
          --branch "${{ env.SOURCE_BRANCH }}" \
          "${{ env.SOURCE_URL }}" \
          source
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: "ğŸ”§ æºç åˆå§‹åŒ–"
      run: |
        cd source
        echo "åˆå§‹åŒ–æºç æ ‘..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… Feedsæ›´æ–°å®Œæˆ"

    - name: "ğŸ¨ åº”ç”¨è‡ªå®šä¹‰é…ç½®"
      run: |
        cd source
        CONFIG_FILE="../firmware-config/${{ github.event.inputs.config_profile }}"
        echo "æ­£åœ¨åº”ç”¨é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ"

    # ======================
    # è‡ªå®šä¹‰åŠŸèƒ½é˜¶æ®µ
    # ======================
    
    - name: "ğŸ“¦ å¤„ç†é¢„ç¼–è¯‘IPKåŒ…"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        IPK_DIR="../firmware-config/custom-features/prebuilt-ipks"
        
        if [ ! -d "$IPK_DIR" ]; then
          echo "â„¹ï¸ é¢„ç¼–è¯‘IPKåŒ…ç›®å½•ä¸å­˜åœ¨: $IPK_DIR"
          exit 0
        fi
        
        echo "ğŸ” æŸ¥æ‰¾é¢„ç¼–è¯‘IPKåŒ…..."
        IPK_FILES=$(find "$IPK_DIR" -name "*.ipk" -type f)
        
        if [ -z "$IPK_FILES" ]; then
          echo "â„¹ï¸ æœªæ‰¾åˆ°é¢„ç¼–è¯‘IPKåŒ…"
          exit 0
        fi
        
        echo "æ‰¾åˆ°ä»¥ä¸‹IPKåŒ…:"
        echo "$IPK_FILES"
        
        # åˆ›å»ºIPKåŒ…å­˜å‚¨ç›®å½•
        mkdir -p package/base-files/files/usr/lib/opkg/custom
        
        # å¤åˆ¶æ‰€æœ‰IPKåŒ…åˆ°å›ºä»¶æ–‡ä»¶ç³»ç»Ÿä¸­
        for ipk in $IPK_FILES; do
          echo "ğŸ“¥ å¤åˆ¶IPKåŒ…: $(basename "$ipk")"
          cp "$ipk" package/base-files/files/usr/lib/opkg/custom/
        done
        
        # åˆ›å»ºè‡ªåŠ¨å®‰è£…è„šæœ¬
        mkdir -p package/base-files/files/etc/init.d
        cat > package/base-files/files/etc/init.d/custom-ipk-install << 'EOF'
        #!/bin/sh /etc/rc.common
        
        START=99
        
        start() {
            echo "æ­£åœ¨å®‰è£…è‡ªå®šä¹‰IPKåŒ…..."
            for ipk in /usr/lib/opkg/custom/*.ipk; do
                if [ -f "$ipk" ]; then
                    echo "å®‰è£…: $(basename $ipk)"
                    opkg install "$ipk"
                fi
            done
            echo "è‡ªå®šä¹‰IPKåŒ…å®‰è£…å®Œæˆ"
        }
        EOF
        
        chmod +x package/base-files/files/etc/init.d/custom-ipk-install
        
        # ç¡®ä¿å¯åŠ¨è„šæœ¬è¢«å¯ç”¨
        if [ -f "package/base-files/files/etc/rc.local" ]; then
          if ! grep -q "custom-ipk-install" package/base-files/files/etc/rc.local; then
            echo "/etc/init.d/custom-ipk-install start" >> package/base-files/files/etc/rc.local
          fi
        fi
        
        echo "âœ… é¢„ç¼–è¯‘IPKåŒ…å¤„ç†å®Œæˆ"
        echo "ğŸ“Š å…±å¤„ç† $(echo "$IPK_FILES" | wc -l) ä¸ªIPKåŒ…"

    - name: "ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        SCRIPTS_DIR="../firmware-config/custom-features/scripts"
        
        # æ£€æŸ¥è„šæœ¬ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "$SCRIPTS_DIR" ]; then
          echo "â„¹ï¸ è‡ªå®šä¹‰è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $SCRIPTS_DIR"
          exit 0
        fi
        
        # æŸ¥æ‰¾æ‰€æœ‰.shè„šæœ¬æ–‡ä»¶å¹¶æŒ‰åç§°æ’åº
        SCRIPTS=$(find "$SCRIPTS_DIR" -name "*.sh" -type f | sort)
        
        if [ -z "$SCRIPTS" ]; then
          echo "â„¹ï¸ æœªæ‰¾åˆ°ä»»ä½•è„šæœ¬æ–‡ä»¶"
          exit 0
        fi
        
        echo "æ‰¾åˆ°ä»¥ä¸‹è„šæœ¬æ–‡ä»¶:"
        echo "$SCRIPTS"
        
        # é€ä¸ªæ‰§è¡Œæ‰€æœ‰è„šæœ¬
        for script in $SCRIPTS; do
          echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
          chmod +x "$script"  # æ·»åŠ æ‰§è¡Œæƒé™
          if bash "$script"; then
            echo "âœ… $(basename "$script") æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ $(basename "$script") æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
        done
        
        echo "âœ… æ‰€æœ‰è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

    - name: "ğŸ” éªŒè¯é…ç½®"
      run: |
        cd source
        echo "éªŒè¯é…ç½®æ–‡ä»¶..."
        make defconfig
        echo "âœ… é…ç½®éªŒè¯å®Œæˆ"

    - name: "ğŸ” ç³»ç»Ÿè¯Šæ–­"
      run: |
        echo "=== ç³»ç»Ÿèµ„æºè¯Šæ–­ ==="
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo "å†…å­˜ä½¿ç”¨:"
        free -h
        echo "CPUæ ¸å¿ƒæ•°:"
        nproc
        echo "ç»ˆç«¯ç¯å¢ƒ: TERM=$TERM"

        # æ˜¾ç¤ºè‡ªå®šä¹‰åŠŸèƒ½çŠ¶æ€
        echo "=== è‡ªå®šä¹‰åŠŸèƒ½çŠ¶æ€ ==="
        echo "å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"

    - name: "ğŸ—ï¸ ç¼–è¯‘å›ºä»¶"
      timeout-minutes: 180
      run: |
        cd source
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export TERM=linux
        export FORCE_UNSAFE_CONFIGURE=1
        
        START_TIME=$(date +%s)
        echo "å¼€å§‹ç¼–è¯‘ (ç­–ç•¥: ${{ github.event.inputs.build_optimization }})"
        
        # æ ¹æ®ä¼˜åŒ–ç­–ç•¥é€‰æ‹©ç¼–è¯‘æ–¹å¼
        case "${{ github.event.inputs.build_optimization }}" in
          "speed")
            echo "ğŸš€ é€Ÿåº¦ä¼˜å…ˆæ¨¡å¼: å¤šçº¿ç¨‹ç¼–è¯‘"
            make -j$(nproc)
            ;;
          "stability")
            echo "ğŸ›¡ï¸ ç¨³å®šæ€§ä¼˜å…ˆæ¨¡å¼: å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘"
            make V=s -j1
            ;;
          "balanced"|*)
            echo "âš–ï¸ å¹³è¡¡æ¨¡å¼: 2çº¿ç¨‹è¯¦ç»†ç¼–è¯‘"
            make -j2 V=s
            ;;
        esac
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "âœ… ç¼–è¯‘å®Œæˆ! è€—æ—¶: ${DURATION}ç§’ ($(($DURATION/60))åˆ†é’Ÿ)"
        echo "BUILD_DURATION=$DURATION" >> $GITHUB_ENV

    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      run: |
        cd source
        echo "æ”¶é›†ç¼–è¯‘è¾“å‡ºæ–‡ä»¶..."
        
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "âœ… ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          echo "æ–‡ä»¶å¤§å°:"
          ls -lh $(echo "$FIRMWARE_FILES" | head -1) 2>/dev/null || echo "æ— æ³•è·å–æ–‡ä»¶å¤§å°"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
          find bin/ -type f 2>/dev/null | head -20 || echo "binç›®å½•ä¸å­˜åœ¨"
        fi
        
        mkdir -p ../artifacts
        cp -r bin/targets/* ../artifacts/ 2>/dev/null || true

        echo "æºç : ${{ env.SOURCE_URL }}" > ../artifacts/build-info.txt
        echo "åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}" >> ../artifacts/build-info.txt
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}" >> ../artifacts/build-info.txt
        echo "ä¼˜åŒ–: ${{ github.event.inputs.build_optimization }}" >> ../artifacts/build-info.txt
        echo "æ—¶é—´: $(date)" >> ../artifacts/build-info.txt
        echo "æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’" >> ../artifacts/build-info.txt
        echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}" >> ../artifacts/build-info.txt

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}"
        path: artifacts
        retention-days: 30

    - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æºç : ${{ env.SOURCE_URL }}"
        echo "åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
        echo "ä¼˜åŒ–: ${{ github.event.inputs.build_optimization }}"
        echo "è‡ªå®šä¹‰åŠŸèƒ½: ${{ github.event.inputs.enable_custom_features }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ! å›ºä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "â±ï¸ ç¼–è¯‘æ—¶é•¿: ${{ env.BUILD_DURATION }}ç§’"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯"
        fi
