name: Update Configs List

on:
  push:
    paths:
      - 'firmware-config/configs/**'  # 当configs目录有变化时触发
    branches: [ main ]
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: write  # 需要写权限来更新文件

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: "📥 检出仓库"
        uses: actions/checkout@v4
        
      - name: "📋 更新配置文件列表"
        run: |
          cd firmware-config
          
          # 获取所有配置文件
          CONFIG_FILES=$(find configs -name ".config_*" -type f 2>/dev/null | sort || echo "")
          CONFIG_COUNT=$(echo "$CONFIG_FILES" | wc -l)
          
          # 生成Markdown表格
          TABLE_HEADER="| 配置文件路径 | 设备型号 | 源码库 | 描述 |"
          TABLE_SEPARATOR="|-------------|---------|--------|------|"
          TABLE_ROWS=""
          
          # 为每个配置文件生成表格行
          for file in $CONFIG_FILES; do
            # 从文件名提取设备型号和源码库
            FILENAME=$(basename "$file")
            DEVICE=$(echo "$FILENAME" | sed 's/\.config_\([^_]*\)_.*/\1/')
            REPO=$(echo "$FILENAME" | sed 's/\.config_[^_]*_\(.*\)/\1/')
            DESCRIPTION="自动生成的配置"
            
            TABLE_ROWS="${TABLE_ROWS}| \`$file\` | $DEVICE | $REPO | $DESCRIPTION |"$'\n'
          done
          
          # 更新configs-list.md文件
          cat > configs-list.md << EOF
# 📋 设备配置文件列表

> 最后更新: $(date +%Y-%m-%d)  
> 配置文件数量: $CONFIG_COUNT 个

## 可用配置文件

以下是当前可用的设备配置文件列表：

$TABLE_HEADER
$TABLE_SEPARATOR
$TABLE_ROWS

## 使用方法

### 1. 选择配置文件
从上表复制你需要的配置文件完整路径。

### 2. 运行工作流
1. 进入 GitHub Actions → Universal Firmware Builder
2. 点击 "Run workflow" 
3. 在 \`设备配置文件\` 字段中粘贴复制的路径
4. 配置其他选项并运行

## 配置文件命名规则

配置文件遵循以下命名约定：
\`\`\`
.config_[设备型号]_[源码库]
\`\`\`

## 添加新配置

要添加新的设备配置：
1. 在 \`configs/\` 目录创建新文件
2. 按照命名规则命名
3. 文件内容为标准的OpenWrt \`.config\` 配置

---

> 💡 **提示**: 此文件自动生成，请勿手动编辑。
EOF
          
          echo "✅ 已更新配置文件列表，共 $CONFIG_COUNT 个文件"
          
      - name: "💾 提交更改"
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add firmware-config/configs-list.md
          git diff --staged --quiet || git commit -m "📋 自动更新配置文件列表"
          git push