name: Update Configs List

on:
  push:
    paths:
      - 'firmware-config/configs/**'  # ç›‘æ§ configs ç›®å½•çš„å˜åŒ–
    branches: [ main, master ]        # åŒæ—¶æ”¯æŒ main å’Œ master åˆ†æ”¯
  pull_request:
    paths:
      - 'firmware-config/configs/**'
  workflow_dispatch:                  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    # æ·»åŠ æ­¥éª¤æ¥è°ƒè¯•è§¦å‘åŸå› 
    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»“åº“"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿æ£€æŸ¥æ›´æ”¹
          
      - name: "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŒ–"
        run: |
          echo "æ£€æŸ¥æœ€è¿‘çš„æ–‡ä»¶å˜æ›´..."
          git diff --name-only HEAD~1 HEAD || echo "æ— æ³•æ¯”è¾ƒæäº¤"
          echo "---"
          echo "configs ç›®å½•å†…å®¹:"
          ls -la firmware-config/configs/ || echo "configs ç›®å½•ä¸å­˜åœ¨"
          
      - name: "ğŸ“‹ ç”Ÿæˆé…ç½®æ–‡ä»¶åˆ—è¡¨"
        run: |
          cd firmware-config
          
          # è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨
          echo "æ‰«æé…ç½®æ–‡ä»¶..."
          CONFIG_FILES=$(find configs -name ".config_*" -type f 2>/dev/null | sort || echo "")
          CONFIG_COUNT=$(echo "$CONFIG_FILES" | grep -c '^' || echo "0")
          
          echo "æ‰¾åˆ° $CONFIG_COUNT ä¸ªé…ç½®æ–‡ä»¶"
          echo "$CONFIG_FILES"
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶åˆ—è¡¨
          echo "# è®¾å¤‡é…ç½®æ–‡ä»¶åˆ—è¡¨" > configs-list.md
          echo "" >> configs-list.md
          echo "> æœ€åæ›´æ–°: $(date)" >> configs-list.md
          echo "> é…ç½®æ–‡ä»¶æ•°é‡: $CONFIG_COUNT ä¸ª" >> configs-list.md
          echo "" >> configs-list.md
          echo "## å¯ç”¨é…ç½®æ–‡ä»¶" >> configs-list.md
          echo "" >> configs-list.md
          echo '```' >> configs-list.md
          echo "$CONFIG_FILES" >> configs-list.md
          echo '```' >> configs-list.md
          echo "" >> configs-list.md
          echo "## ä½¿ç”¨æ–¹æ³•" >> configs-list.md
          echo "" >> configs-list.md
          echo 'å¤åˆ¶ä¸Šé¢çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œåœ¨å·¥ä½œæµçš„"è®¾å¤‡é…ç½®æ–‡ä»¶"å­—æ®µä¸­ç²˜è´´ä½¿ç”¨ã€‚' >> configs-list.md
          echo "" >> configs-list.md
          echo 'æ–‡ä»¶å‘½åæ ¼å¼: `.config_è®¾å¤‡å_æºç åº“`' >> configs-list.md
          echo "" >> configs-list.md
          echo "---" >> configs-list.md
          echo "*æœ¬æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> configs-list.md
          
      - name: "ğŸ’¾ æäº¤æ›´æ”¹"
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          if git diff --quiet firmware-config/configs-list.md; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶åˆ—è¡¨çš„æ›´æ”¹"
          else
            echo "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶åˆ—è¡¨æœ‰æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add firmware-config/configs-list.md
            git commit -m "ğŸ“‹ è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶åˆ—è¡¨"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°"
          fi
